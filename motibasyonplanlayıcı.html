<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya Sahibez Zaman</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter ve sÃ¼slÃ¼ bir font) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <!-- YENÄ°: Chart.js KÃ¼tÃ¼phanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Ã–zel stiller */
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }

        /* BaÅŸlÄ±k iÃ§in sÃ¼slÃ¼ font */
        .fancy-title {
            font-family: 'Dancing Script', cursive;
        }

        /* YarÄ± saydam arka planlar (Ä°stek 13) */
        .glass-bg {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* GÃ¶rev kutucuklarÄ± iÃ§in sarmaÅŸÄ±k/Ã§iÃ§ek benzeri kenarlÄ±k (Ä°stek 15) */
        .task-box, .pool-box {
            border: 2px solid;
            border-image-slice: 1;
            border-width: 2px;
            border-image-source: linear-gradient(to right, #fbc2eb, #a6c1ee);
            transition: all 0.3s ease;
        }

        /* YENÄ°: Ana kutucuklar iÃ§in dinamik hover (Ä°stek 1) */
        .task-box:hover, .pool-box:hover {
            transform: scale(1.01); /* Hafif bÃ¼yÃ¼me */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Hafif gÃ¶lge */
        }

        /* YENÄ°: Temel gÃ¶rev/havuz item stilleri (Ä°stek 14/2) */
        .task-item, .pool-item {
            transition: all 0.2s ease-in-out; /* HÄ±zlandÄ±rÄ±ldÄ± */
            opacity: 0.95; /* Hafif soluk */
        }

        /* Hover efekti (Ä°stek 14 / GÃœNCELLENDÄ°) */
        .task-item:hover, .pool-item:hover {
            transform: scale(1.04); /* Biraz daha bÃ¼yÃ¼tÃ¼ldÃ¼ */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); /* GÃ¶lge belirginleÅŸtirildi */
            opacity: 1; /* Tam opak */
            z-index: 10; /* Ãœste Ã§Ä±ksÄ±n */
            position: relative; /* Hover anÄ±nda Ã¼ste Ã§Ä±ksÄ±n */
        }
        
        /* Havuz itemlerine Ã¶zel (tÄ±klanabilir hissi iÃ§in) (Ä°stek 2) */
        .pool-item {
            cursor: pointer;
        }
        
        /* GÃ¶rev durumu ikonlarÄ± (Ä°stek 4) */
        .status-btn {
            cursor: pointer;
            font-size: 1.5rem; /* 24px */
            transition: transform 0.2s;
        }
        .status-btn:hover {
            transform: scale(1.2);
        }
        /* 0: YapÄ±lmadÄ± (BoÅŸ), 1: YarÄ±m (Ay), 2: Tam (GÃ¼neÅŸ/YÄ±ldÄ±z) */
        .status-0::before { content: 'ðŸ”²'; color: #cbd5e1; }
        .status-1::before { content: 'ðŸŒ—'; color: #f59e0b; }
        .status-2::before { content: 'âœ…'; color: #10b981; }

        /* YÃ¼kleme gÃ¶stergesi (Spinner) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a6c1ee;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ã–zel KaydÄ±rma Ã‡ubuÄŸu */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #fbc2eb, #a6c1ee);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            transform: scale(1.05);
        }

        /* YENÄ°: Arka plan galeri stilleri */
        .bg-thumbnail {
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem; /* 8px */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bg-thumbnail:hover {
            transform: scale(1.05);
            border-color: #fbc2eb; /* Pembe */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* YENÄ°: Tema Kategori ButonlarÄ± */
        .theme-btn {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #374151; /* gray-700 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .theme-btn:hover {
            background-color: white;
            color: #db2777; /* pink-600 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-4 max-w-screen-2xl">
        
        <!-- BaÅŸlÄ±k ve Tarih -->
        <header class="text-center my-6">
            <h1 class="fancy-title text-6xl font-bold text-pink-500 drop-shadow-md">Ya Sahibez Zaman</h1>
            <p id="current-date" class="text-xl text-gray-600 mt-2"></p>
        </header>

        <!-- Ana Ä°Ã§erik IzgarasÄ± -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Sol/Orta Panel (GÃ¶revler) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- GeÃ§miÅŸ GÃ¼nler Butonu -->
                <div class="flex justify-start">
                    <button id="show-history-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        GeÃ§miÅŸ GÃ¼nler
                    </button>
                </div>

                <!-- GÃ¶rev Ekleme Formu -->
                <div class="glass-bg task-box rounded-xl shadow-lg p-4">
                    <h3 class="text-xl font-semibold mb-3 text-pink-600">Yeni GÃ¶rev Ekle</h3>
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="new-task-title" placeholder="GÃ¶rev adÄ±..." class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <select id="new-task-type" class="p-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-pink-300">
                            <option value="dunyevi">DÃ¼nyevi Ä°ÅŸ</option>
                            <option value="ilmi">Ä°lmi Ä°ÅŸ</option>
                            <option value="haftalik">HaftalÄ±k Ä°ÅŸ</option>
                        </select>
                        <input type="number" id="new-task-frequency" placeholder="Haftada kaÃ§ kez?" min="1" class="p-2 border rounded-lg bg-white w-24 focus:outline-none focus:ring-2 focus:ring-pink-300 hidden">
                        <button id="add-task-btn" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">Ekle</button>
                    </div>
                </div>

                <!-- GÃ¶rev Listeleri Sekmeleri -->
                <div class="glass-bg task-box rounded-xl shadow-lg p-4">
                    <div class="flex border-b border-gray-300 mb-4">
                        <button class="tab-btn active-tab py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600" data-tab="gunluk">GÃ¼nlÃ¼k GÃ¶revler</button>
                        <button class="tab-btn py-2 px-4 font-semibold text-gray-500" data-tab="haftalik">HaftalÄ±k GÃ¶revler</button>
                        <button class="tab-btn py-2 px-4 font-semibold text-gray-500" data-tab="istatistik">Ä°statistikler</button>
                    </div>

                    <!-- GÃ¼nlÃ¼k GÃ¶revler Paneli -->
                    <div id="gunluk-tab" class="tab-content space-y-6">
                        <!-- DÃ¼nyevi Ä°ÅŸler -->
                        <div>
                            <h2 class="text-2xl font-bold text-blue-700 mb-3">DÃ¼nyevi Ä°ÅŸler</h2>
                            <div id="dunyevi-tasks" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                <!-- GÃ¶revler buraya eklenecek -->
                            </div>
                        </div>
                        <!-- Ä°lmi Ä°ÅŸler -->
                        <div>
                            <h2 class="text-2xl font-bold text-purple-700 mb-3">Ä°lmi Ä°ÅŸler</h2>
                            <div id="ilmi-tasks" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                <!-- GÃ¶revler buraya eklenecek -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- HaftalÄ±k GÃ¶revler Paneli -->
                    <div id="haftalik-tab" class="tab-content hidden space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <h2 class="text-2xl font-bold text-green-700 mb-3">HaftalÄ±k GÃ¶revler</h2>
                        <div id="haftalik-tasks" class="space-y-3">
                            <!-- HaftalÄ±k gÃ¶revler buraya eklenecek -->
                        </div>
                    </div>

                    <!-- GÃœNCELLENDÄ°: Ä°statistik Paneli -->
                    <div id="istatistik-tab" class="tab-content hidden">
                        <h2 class="text-2xl font-bold text-indigo-700 mb-3">BaÅŸarÄ± Grafikleri</h2>
                        
                        <!-- YENÄ°: Ä°statistik Sekmeleri (GÃ¼nlÃ¼k/HaftalÄ±k) -->
                        <div class="flex border-b border-gray-200 mb-3">
                            <button class="stats-tab-btn py-2 px-4 font-semibold text-indigo-600 border-b-2 border-indigo-600" data-stats-tab="daily-chart">GÃ¼nlÃ¼k EÄŸri</button>
                            <button class="stats-tab-btn py-2 px-4 font-semibold text-gray-500" data-stats-tab="weekly-chart">HaftalÄ±k EÄŸri</button>
                        </div>
            
                        <!-- YENÄ°: Grafik KonteynerlarÄ± -->
                        <div id="daily-chart-tab" class="stats-tab-content w-full h-80">
                            <canvas id="daily-stats-chart"></canvas>
                        </div>
                        <div id="weekly-chart-tab" class="stats-tab-content hidden w-full h-80">
                            <canvas id="weekly-stats-chart"></canvas>
                        </div>
                        <div id="no-stats-message" class="hidden text-gray-500 p-4">Ä°statistik verisi toplandÄ±kÃ§a burada gÃ¶rÃ¼necek...</div>
                    </div>
                    <!-- / Ä°statistik Paneli -->

                </div>

            </div>

            <!-- SaÄŸ Panel (KÃ¼meler ve DiÄŸerleri) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- GÃ¶rev KÃ¼meleri (Havuz) -->
                <div class="glass-bg pool-box rounded-xl shadow-lg p-4">
                    <h2 class="text-2xl font-bold text-pink-600 mb-4">GÃ¶rev KÃ¼meleri (Havuz)</h2>
                    <div class="flex border-b border-gray-300 mb-4">
                        <button class="pool-tab-btn active-tab py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600" data-pool-tab="dunyevi-pool-tab">DÃ¼nyevi</button>
                        <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="ilmi-pool-tab">Ä°lmi</button>
                        <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="haftalik-pool-tab">HaftalÄ±k</button>
                    </div>

                    <div id="dunyevi-pool-tab" class="pool-tab-content space-y-2 max-h-48 overflow-y-auto pr-2">
                        <!-- DÃ¼nyevi kÃ¼me gÃ¶revleri -->
                    </div>
                    <div id="ilmi-pool-tab" class="pool-tab-content hidden space-y-2 max-h-48 overflow-y-auto pr-2">
                        <!-- Ä°lmi kÃ¼me gÃ¶revleri -->
                    </div>
                    <div id="haftalik-pool-tab" class="pool-tab-content hidden space-y-2 max-h-48 overflow-y-auto pr-2">
                        <!-- HaftalÄ±k kÃ¼me gÃ¶revleri -->
                    </div>
                </div>

                <!-- Ali Murtaza KoÃ§ak NÃ¶bet Takibi (Ä°stek 8) - GÃœNCELLENDÄ° -->
                <div class="glass-bg pool-box rounded-xl shadow-lg p-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-3">NÃ¶bet Takibi</h2>
                    
                    <!-- YENÄ°: NÃ¶bet ismi giriÅŸi -->
                    <div class="mb-3">
                        <label for="rota-name-input" class="text-sm font-medium text-gray-600">Ã‡izelgede Aranacak Ä°sim (Ä°stek 3)</label>
                        <input type="text" id="rota-name-input" placeholder="Ã–rn: Ali Murtaza KoÃ§ak" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                    </div>

                    <p class="text-sm mb-3">NÃ¶bet listesini (resim) yÃ¼kleyin:</p>
                    <input type="file" id="rota-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                    <button id="rota-process-btn" class="w-full mt-3 bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        NÃ¶betleri Ä°ÅŸle
                    </button>
                    <div id="rota-output" class="mt-4 p-3 bg-white/70 rounded-lg min-h-[50px]">
                        <p class="text-gray-500 text-sm">KaydedilmiÅŸ nÃ¶bet bilgisi yok veya yeni liste yÃ¼klenmedi.</p>
                        <!-- YÃ¼kleniyor ikonu -->
                        <div id="rota-loader" class="hidden loader mx-auto my-2"></div>
                    </div>
                </div>

                <!-- BaÅŸarÄ± OranÄ± (Ä°stek 11) -->
                <div class="glass-bg pool-box rounded-xl shadow-lg p-4 text-center">
                    <h2 class="text-2xl font-bold text-green-600 mb-2">GÃ¼nlÃ¼k BaÅŸarÄ±</h2>
                    <div id="success-rate" class="text-5xl font-bold text-green-500">0%</div>
                </div>

                <!-- YENÄ°: HaftalÄ±k BaÅŸarÄ± OranÄ± -->
                <div class="glass-bg pool-box rounded-xl shadow-lg p-4 text-center">
                    <h2 class="text-2xl font-bold text-blue-600 mb-2">HaftalÄ±k BaÅŸarÄ±</h2>
                    <div id="weekly-success-rate" class="text-5xl font-bold text-blue-500">0%</div>
                </div>
            </div>

        </main>

        <!-- Alt BÃ¶lÃ¼m -->
        <footer class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- GÃ¼nÃ¼n SÃ¶zÃ¼ (Ä°stek 7) - YER DEÄžÄ°ÅžTÄ°RDÄ° (Ä°stek 1) -->
            <div id="quote-box" class="glass-bg task-box rounded-xl shadow-lg p-6 min-h-[150px] flex flex-col justify-center space-y-4">
                <!-- Ayet -->
                <div class="text-center">
                    <p id="quote-ayet" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-ayet-source" class="text-md font-semibold text-pink-500 mt-1">â€” ...</p>
                </div>
                <hr class="border-pink-200">
                <!-- Hadis -->
                <div class="text-center">
                    <p id="quote-hadis" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-hadis-source" class="text-md font-semibold text-blue-500 mt-1">â€” ...</p>
                </div>
                <hr class="border-blue-200">
                <!-- GÃ¼zel SÃ¶z -->
                <div class="text-center">
                    <p id="quote-soz" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-soz-source" class="text-md font-semibold text-purple-500 mt-1">â€” ...</p>
                </div>
            </div>

            <!-- Arka Plan Galerisi (Ä°stek 16) - YER DEÄžÄ°ÅžTÄ°RDÄ° (Ä°stek 1) -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-3 text-pink-600">Arka Plan Galerisi</h3>
                
                <!-- YENÄ°: Yerel Dosya YÃ¼kleme KÄ±smÄ± -->
                <div class="mb-4 p-3 bg-pink-50 rounded-lg border border-pink-100">
                    <h4 class="font-semibold text-pink-600 mb-2">Bilgisayardan Arka Plan SeÃ§</h4>
                    <input type="file" id="local-bg-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-200 file:text-pink-800 hover:file:bg-pink-300">
                    <button id="upload-bg-btn" class="w-full mt-3 bg-purple-400 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        Arka PlanÄ± YÃ¼kle ve Kaydet
                    </button>
                    <p id="upload-status" class="text-xs text-gray-500 mt-2 hidden">YÃ¼kleniyor...</p>
                </div>

                <p class="text-sm text-gray-600 mb-2">Veya hazÄ±r (stabil) temalardan birini seÃ§in:</p>
                
                <!-- Statik arka plan seÃ§ici galeri -->
                <div id="bg-results-grid" class="grid grid-cols-3 gap-2 h-64 overflow-y-auto pr-2">
                    <!-- Arka planlar buraya JavaScript ile yÃ¼klenecek -->
                </div>
            </div>
            
            <!-- Ayarlar (AI/NÃ¶bet) - YER DEÄžÄ°ÅžTÄ°RDÄ° (Ä°stek 1) -->
            <div class="glass-bg pool-box rounded-xl shadow-lg p-4">
                <h2 class="text-2xl font-bold text-gray-700 mb-3">Ayarlar (AI/NÃ¶bet)</h2>
                <div class="space-y-3">
                    <div>
                        <label for="api-key-input" class="text-sm font-medium text-gray-600">Google AI API AnahtarÄ±</label>
                        <input type="password" id="api-key-input" placeholder="API AnahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n..." class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button id="api-key-save-btn" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            AnahtarÄ± Kaydet
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 italic">API AnahtarÄ±, nÃ¶bet listesi okuma iÃ§in gereklidir.</p>
                </div>

                <!-- YENÄ°: Veri Yedekleme BÃ¶lÃ¼mÃ¼ -->
                <hr class="my-4 border-pink-200">
                <div>
                    <h4 class="text-sm font-medium text-gray-600 mb-2">Veri Yedekleme</h4>
                    <p class="text-xs text-gray-500 italic mb-2">TÃ¼m gÃ¶revlerinizi ve ayarlarÄ±nÄ±zÄ± bir dosyaya yedekleyin veya yedeÄŸi geri yÃ¼kleyin.</p>
                    <div class="flex gap-2">
                        <button id="export-data-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri DÄ±ÅŸa Aktar (Yedekle)
                        </button>
                        <button id="import-data-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri Ä°Ã§e Aktar (Geri YÃ¼kle)
                        </button>
                    </div>
                    <!-- Ä°Ã§e aktarma iÃ§in gizli dosya giriÅŸi -->
                    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt">
                </div>
                <!-- / Veri Yedekleme BÃ¶lÃ¼mÃ¼ -->

            </div>


        </footer>
    </div>
    
    <!-- Modal (Mesajlar iÃ§in) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="modal-close-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-6 rounded-lg">Kapat</button>
        </div>
    </div>
    
    <!-- GeÃ§miÅŸ GÃ¼nler Modal (Ä°stek 9) -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full h-[70vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-pink-600">GeÃ§miÅŸ GÃ¼nler</h3>
                <button id="history-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="history-list" class="space-y-2 overflow-y-auto h-[calc(70vh-100px)] pr-2">
                <p class="text-gray-500">YÃ¼klenecek geÃ§miÅŸ gÃ¼n kaydÄ± bulunamadÄ±.</p>
            </div>
        </div>
    </div>


    <!-- Firebase SDK (Gerekli) -->
    <script type="module">
        // --- GLOBAL DEÄžÄ°ÅžKENLER VE SABÄ°TLER ---
        
        let currentDayStr = new Date().toISOString().split('T')[0];
        let currentWeekStr = getWeekId(new Date());

        // Yerel Depolama iÃ§in anahtar Ã¶neki
        const LS_PREFIX = 'YSZ_';
        
        // YENÄ°: NÃ¶bet Takibi DOM referanslarÄ± (ModÃ¼l KapsamÄ±nda TanÄ±mlandÄ±)
        let rotaLoader = null; 
        let rotaOutput = null;
        
        // YENÄ°: Chart.js iÃ§in global deÄŸiÅŸkenler (Ã§ift render'Ä± Ã¶nlemek iÃ§in)
        let dailyChartInstance = null;
        let weeklyChartInstance = null;

        // GÃœNCELLENDÄ°: Statik Ã‡iÃ§ek Arka PlanlarÄ± (Daha stabil, non-Unsplash placeholderlar)
        const FLOWER_BACKGROUND_PRESETS = [
            { url: 'https://placehold.co/800x450/f9a8d4/ffffff?text=1.+Pastel+Laleler', style: 'Pastel Pembe Laleler' },
            { url: 'https://placehold.co/800x450/a5b4fc/ffffff?text=2.+Sulu+Boya+GÃ¼ller', style: 'Soyut Sulu Boya GÃ¼ller (Ã‡izim)' },
            { url: 'https://placehold.co/800x450/ef4444/ffffff?text=3.+GerÃ§ekÃ§i+GÃ¼ller', style: 'GerÃ§ekÃ§i KÄ±rmÄ±zÄ± GÃ¼ller' },
            { url: 'https://placehold.co/800x450/c4b5fd/ffffff?text=4.+Mor+Pembe+Desen', style: 'YumuÅŸak Pembe/Mor Ã‡iÃ§ek Desen' },
            { url: 'https://placehold.co/800x450/4ade80/ffffff?text=5.+CanlÄ±+Bahar+Ã‡iÃ§ekleri', style: 'CanlÄ± KarÄ±ÅŸÄ±k Bahar Ã‡iÃ§ekleri' }
            // Kendi Base64 resimlerinizi buraya ekleyebilirsiniz: 
            // { url: 'data:image/jpeg;base64,.....KENDÄ° BASE64 VERÄ°NÄ°Z.....', style: 'Kendi Resminiz' }
        ];

        // VarsayÄ±lan arka plan (ilk aÃ§Ä±lÄ±ÅŸta kullanÄ±lÄ±r)
        const DEFAULT_FALLBACK_BG = FLOWER_BACKGROUND_PRESETS[0].url;

        // YENÄ°: GÃ¼nlÃ¼k SÃ¶zler Veri Listesi (Eksikti, Hata DÃ¼zeltmesi)
        const GUNLUK_SOZLER = [
            {
                ayet: { text: "ÅžÃ¼phesiz, Allah sabredenlerle beraberdir.", source: "Bakara, 153" },
                hadis: { text: "KolaylaÅŸtÄ±rÄ±nÄ±z, zorlaÅŸtÄ±rmayÄ±nÄ±z; mÃ¼jdeleyiniz, nefret ettirmeyiniz.", source: "BuhÃ¢rÃ®, Ä°lim, 11" },
                soz: { text: "Ä°ki gÃ¼nÃ¼ bir olan ziyandadÄ±r.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "Sizin en hayÄ±rlÄ±nÄ±z, Kur'an'Ä± Ã¶ÄŸrenen ve Ã¶ÄŸretendir.", source: "TirmizÃ®, FedÃ¢ilÃ¼'l-Kur'an, 15" },
                hadis: { text: "Ä°lim Ã¶ÄŸrenmek, her MÃ¼slÃ¼mana farzdÄ±r.", source: "Ä°bn MÃ¢ce, Mukaddime, 17" },
                soz: { text: "Bana bir harf Ã¶ÄŸretenin kÄ±rk yÄ±l kÃ¶lesi olurum.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "HiÃ§ bilenlerle bilmeyenler bir olur mu?", source: "ZÃ¼mer, 9" },
                hadis: { text: "Allah kimin iÃ§in hayÄ±r dilerse, onu dinde fÃ¢kih (derin anlayÄ±ÅŸ sahibi) kÄ±lar.", source: "BuhÃ¢rÃ®, Ä°lim, 13" },
                soz: { text: "Okumak, gÄ±dadÄ±r; okuyan insan, acÄ±kmaz.", source: "Cemil MeriÃ§" }
            },
            {
                ayet: { text: "Rabbim, ilmimi artÄ±r de.", source: "TÃ¢hÃ¢, 114" },
                hadis: { text: "BeÅŸikten mezara kadar ilim Ã¶ÄŸreniniz.", source: "HadÃ®s-i ÅžerÃ®f" },
                soz: { text: "En bÃ¼yÃ¼k savaÅŸ, insanÄ±n kendi nefsiyle yaptÄ±ÄŸÄ± savaÅŸtanÄ±r.", source: "Hz. Muhammed (s.a.v.)" }
            },
            {
                ayet: { text: "O, (gece) karanlÄ±ÄŸÄ± yarÄ±p sabahÄ± Ã§Ä±karandÄ±r.", source: "En'Ã¢m, 96" },
                hadis: { text: "GÃ¼zel sÃ¶z sadakadÄ±r.", source: "MÃ¼slim, ZekÃ¢t, 56" },
                soz: { text: "Hayat, iman ve cihattÄ±r.", source: "Hz. HÃ¼seyin (r.a.)" }
            },
            {
                ayet: { text: "Allah, bir kimseyi ancak gÃ¼cÃ¼nÃ¼n yettiÄŸi ÅŸeyle yÃ¼kÃ¼mlÃ¼ kÄ±lar.", source: "Bakara, 286" },
                hadis: { text: "Ameller niyetlere gÃ¶redir.", source: "BuhÃ¢rÃ®, Bedâ€™Ã¼â€™l-vahy, 1" },
                soz: { text: "SabÄ±r, baÅŸarÄ±nÄ±n anahtarÄ±dÄ±r.", source: "MevlÃ¢nÃ¢" }
            }
        ];

        // DOM Element ReferanslarÄ±
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- YEREL DEPOLAMA YARDIMCILARI ---

        /**
         * Yerel depolamadan veri okur (JSON.parse yapar)
         */
        function lsGet(key, defaultValue = null) {
            const value = localStorage.getItem(LS_PREFIX + key);
            if (value === null || value === undefined) {
                return defaultValue;
            }
            try {
                return JSON.parse(value);
            } catch (e) {
                console.error("Yerel depolama okuma hatasÄ± (JSON parse):", e);
                return defaultValue;
            }
        }

        /**
         * Yerel depolamaya veri yazar (JSON.stringify yapar)
         */
        function lsSet(key, value) {
            try {
                localStorage.setItem(LS_PREFIX + key, JSON.stringify(value));
            } catch (e) {
                console.error("Yerel depolama yazma hatasÄ±:", e);
                showMessage("Veri KayÄ±t HatasÄ±", "Verileriniz kaydedilemedi. TarayÄ±cÄ±nÄ±za yer kalmamÄ±ÅŸ olabilir.");
            }
        }

        // --- UYGULAMA BAÅžLANGIÃ‡ ---

        try {
            console.log("Uygulama baÅŸlÄ±yor (Yerel Depolama).");
            initializeApp(); // Direkt uygulamayÄ± baÅŸlat
        } catch (error) {
            console.error("Uygulama baÅŸlatÄ±lamadÄ±:", error); // Hata mesajÄ± dÃ¼zeltildi
            showMessage("Hata", "Uygulama baÅŸlatÄ±lamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        }

        async function initializeApp() {
            try {
                await checkDayChange(); // GÃ¼nÃ¼ kontrol et ve gerekirse verileri taÅŸÄ±
                loadStaticData(); // Statik verileri (nÃ¶bet, sÃ¶z, arka plan) yÃ¼kle
                loadAllDataAndSetupListeners(); // Veri dinleyicilerini baÅŸlat

            } catch (error) {
                console.error("BaÅŸlatma hatasÄ±:", error);
                showMessage("BaÅŸlatma HatasÄ±", "Uygulama verileri yÃ¼klenirken bir hata oluÅŸtu.");
            }
        }
        
        // GÃœN VE HAFTA DEÄžÄ°ÅžÄ°MÄ° FONKSÄ°YONLARI BURADA KALDI (Hata DÃ¼zeltmeleri YapÄ±lmÄ±ÅŸtÄ±)

        /**
         * GÃ¶revler, havuzlar vb. iÃ§in tÃ¼m veri yÃ¼kleyicilerini baÅŸlatÄ±r (Yerel Depolama).
         */
        function loadAllDataAndSetupListeners() {
            loadDailyTasks();
            loadWeeklyTasks();
            loadPools();
            loadStats(); // GÃœNCELLENDÄ°: ArtÄ±k grafikleri de Ã§izecek
            loadSettings(); // YENÄ°: AyarlarÄ± yÃ¼kle

            // Event Listeners (UI)
            setupEventListeners();
        }

        /**
         * GÃ¼n deÄŸiÅŸip deÄŸiÅŸmediÄŸini kontrol eder. DeÄŸiÅŸtiyse, dÃ¼nkÃ¼ gÃ¶revleri
         * 'history' koleksiyonuna taÅŸÄ±r ve varsayÄ±lanlarÄ± yeni gÃ¼ne ekler. (Ä°stek 9)
         */
        async function checkDayChange() {
            try {
                const lastLoginInfo = lsGet('metadata_lastLogin', { date: null, week: null });
                const lastLoginDate = lastLoginInfo.date;

                $("#current-date").textContent = new Date().toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                if (lastLoginDate && lastLoginDate !== currentDayStr) {
                    console.log(`GÃ¼n deÄŸiÅŸti. Eski gÃ¼n: ${lastLoginDate}, Yeni gÃ¼n: ${currentDayStr}`);
                    await archiveTasks(lastLoginDate); // DÃ¼nkÃ¼ gÃ¶revleri arÅŸivle (GÃœNCELLENDÄ°: artÄ±k istatistik de kaydeder)
                    await addDefaultTasksForNewDay(); // Yeni gÃ¼n iÃ§in varsayÄ±lanlarÄ± ekle
                } else if (!lastLoginDate) {
                    console.log("Ä°lk giriÅŸ, varsayÄ±lan gÃ¶revler ekleniyor.");
                    await addDefaultTasksForNewDay(); // Ä°lk giriÅŸse de varsayÄ±lanlarÄ± ekle
                } else {
                    console.log("AynÄ± gÃ¼n giriÅŸi.");
                }

                const lastLoginWeek = lastLoginInfo.week;
                if(lastLoginWeek !== currentWeekStr) {
                    console.log(`Hafta deÄŸiÅŸti. Eski hafta: ${lastLoginWeek}, Yeni hafta: ${currentWeekStr}`);
                    await resetWeeklyTasks(lastLoginWeek); // GÃœNCELLENDÄ°: ArtÄ±k eski haftayÄ± parametre olarak alÄ±r
                }
                
                lsSet('metadata_lastLogin', { date: currentDayStr, week: currentWeekStr });

            } catch (error) {
                console.error("GÃ¼n deÄŸiÅŸtirme kontrol hatasÄ±:", error);
            }
        }

        /**
         * YENÄ°: GÃ¼nlÃ¼k gÃ¶revleri geÃ§miÅŸe arÅŸivler (Hata 1'i dÃ¼zeltir)
         * GÃœNCELLENDÄ°: ArtÄ±k gÃ¼nlÃ¼k istatistikleri de kaydeder.
         */
        async function archiveTasks(dateToArchive) {
            console.log(`GÃ¶revler arÅŸivleniyor: ${dateToArchive}`);
            const dailyTasksKey = `tasks_daily_${dateToArchive}`;
            const tasks = lsGet(dailyTasksKey, []);
            
            if (tasks.length > 0) {
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // GÃœNCELLENDÄ°: Yeni stats yapÄ±sÄ±
                const allStats = lsGet('stats', { daily: {}, weekly: {} }); 
                allStats.daily[dateToArchive] = { success: successRate }; // 'daily' anahtarÄ± altÄ±na kaydet
                lsSet('stats', allStats);
                
                const allHistory = lsGet('history', {});
                allHistory[dateToArchive] = tasks;
                lsSet('history', allHistory);
            }
            localStorage.removeItem(LS_PREFIX + dailyTasksKey);
        }
        
        /**
         * YENÄ°: Yeni gÃ¼n iÃ§in varsayÄ±lan gÃ¶revleri ekler (Hata 1'i dÃ¼zeltir)
         */
        async function addDefaultTasksForNewDay() {
            console.log("Yeni gÃ¼n iÃ§in varsayÄ±lan gÃ¶revler ekleniyor...");
            
            const dunyeviPool = lsGet('pools_dunyevi', []);
            const ilmiPool = lsGet('pools_ilmi', []);
            
            const defaultDunyevi = dunyeviPool.filter(t => t.isDefault).map(t => ({...t, type: 'dunyevi', status: 0}));
            const defaultIlmi = ilmiPool.filter(t => t.isDefault).map(t => ({...t, type: 'ilmi', status: 0}));
            
            const dailyKey = `tasks_daily_${currentDayStr}`;
            const dailyTasks = lsGet(dailyKey, []);
            
            const allDefaults = [...defaultDunyevi, ...defaultIlmi];
            allDefaults.forEach(defaultTask => {
                const exists = dailyTasks.some(t => t.title === defaultTask.title);
                if (!exists) {
                    dailyTasks.push({
                        id: Date.now().toString() + Math.random(), // Benzersiz ID
                        title: defaultTask.title,
                        type: defaultTask.type,
                        status: 0
                    });
                }
            });
            
            lsSet(dailyKey, dailyTasks);
            loadDailyTasks(); // UI'Ä± yenile
        }
        
        /**
         * YENÄ°: Yeni hafta iÃ§in haftalÄ±k gÃ¶revleri sÄ±fÄ±rlar (tamamlanma durumlarÄ±nÄ±)
         * GÃœNCELLENDÄ°: Eski haftanÄ±n istatistiÄŸini kaydeder.
         */
        async function resetWeeklyTasks(lastLoginWeek) {
            console.log("HaftalÄ±k gÃ¶revler sÄ±fÄ±rlanÄ±yor...");

            // YENÄ°: SÄ±fÄ±rlamadan Ã–NCE, eski haftanÄ±n baÅŸarÄ±sÄ±nÄ± kaydet
            if (lastLoginWeek && lastLoginWeek !== currentWeekStr) {
                const oldWeeklyTasks = lsGet(`tasks_weekly_${lastLoginWeek}`, []);
                if (oldWeeklyTasks.length > 0) {
                    const finalWeeklySuccess = calculateWeeklySuccess(oldWeeklyTasks); // UI'Ä± gÃ¼ncelleme
                    
                    const allStats = lsGet('stats', { daily: {}, weekly: {} });
                    allStats.weekly[lastLoginWeek] = { success: finalWeeklySuccess };
                    lsSet('stats', allStats);
                    console.log(`HaftalÄ±k baÅŸarÄ± (${lastLoginWeek}) kaydedildi: ${finalWeeklySuccess}%`);
                    
                    // Eski haftanÄ±n gÃ¶revlerini sil (isteÄŸe baÄŸlÄ±, ama yerel depolamayÄ± temiz tutar)
                    localStorage.removeItem(LS_PREFIX + `tasks_weekly_${lastLoginWeek}`);
                }
            }
            
            // Yeni hafta iÃ§in varsayÄ±lanlarÄ± yÃ¼kle
            const weeklyKey = `tasks_weekly_${currentWeekStr}`;
            const weeklyPool = lsGet('pools_haftalik', []);
            
            const defaultWeekly = weeklyPool
                .filter(t => t.isDefault)
                .map(t => ({
                    id: Date.now().toString() + Math.random(),
                    title: t.title,
                    frequency: t.frequency || 1,
                    completed: 0
                }));
            
            lsSet(weeklyKey, defaultWeekly);
            loadWeeklyTasks(); // UI'Ä± yenile
        }


        // --- YEREL DEPOLAMADAN YÃœKLEME FONKSÄ°YONLARI ---
        function loadDailyTasks() {
            const tasks = lsGet(`tasks_daily_${currentDayStr}`, []);
            const dunyevi = tasks.filter(t => t.type === 'dunyevi');
            const ilmi = tasks.filter(t => t.type === 'ilmi');
            renderDailyTasks(dunyevi, ilmi);
            calculateSuccess(); // GÃ¼nlÃ¼k baÅŸarÄ±yÄ± hesapla/gÃ¼ncelle
        }

        function loadWeeklyTasks() {
            const tasks = lsGet(`tasks_weekly_${currentWeekStr}`, []);
            renderWeeklyTasks(tasks);
            calculateWeeklySuccess(); // YENÄ°: HaftalÄ±k baÅŸarÄ±yÄ± hesapla/gÃ¼ncelle
        }

        function loadPools() {
            renderPool(lsGet('pools_dunyevi', []), 'dunyevi-pool-tab');
            renderPool(lsGet('pools_ilmi', []), 'ilmi-pool-tab');
            renderPool(lsGet('pools_haftalik', []), 'haftalik-pool-tab');
        }

        function loadStats() {
            // GÃœNCELLENDÄ°: Yeni stats yapÄ±sÄ±
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const dailyStats = allStats.daily || {};
            const weeklyStats = allStats.weekly || {};
            
            renderStats(dailyStats, weeklyStats); // renderStats'Ä± yeni verilerle Ã§aÄŸÄ±r
        }

        function loadSettings() {
            const apiKey = lsGet('settings_apiKey', '');
            $('#api-key-input').value = apiKey;
            
            const rotaName = lsGet('settings_rotaName', 'Ali Murtaza KoÃ§ak'); // VarsayÄ±lan isim
            $('#rota-name-input').value = rotaName;
        }

        /**
         * NÃ¶bet bilgisi, gÃ¼nÃ¼n sÃ¶zÃ¼, arka plan gibi statik verileri yÃ¼kler
         */
        async function loadStaticData() {
            // GÃ¼nÃ¼n SÃ¶zÃ¼ (Ä°stek 7)
            setDailyQuote();
            // VarsayÄ±lan Arka Plan (Ä°stek 10)
            setDailyBackground(); 
            
            // YENÄ°: Arka plan seÃ§ici galeriyi Ã§iz (Statik Ã‡iÃ§ekler)
            renderStaticBackgrounds();
            
            // YENÄ°: Global DOM referanslarÄ±nÄ± kaydet
            rotaLoader = $("#rota-loader"); 
            rotaOutput = $("#rota-output");

            // KayÄ±tlÄ± NÃ¶bet Bilgisi (Ä°stek 8)
            try {
                const rotaInfo = lsGet('metadata_rotaInfo');
                // DOM elemanlarÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol etmeye gerek yok, Ã§Ã¼nkÃ¼ processRota iÃ§inde kontrol edilecek.
                if (rotaOutput && rotaInfo && rotaInfo.text) {
                     rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${rotaInfo.text}</pre>`;
                }
            } catch (error) {
                console.error("KayÄ±tlÄ± nÃ¶bet bilgisi yÃ¼klenemedi:", error);
            }
        }
        
        // --- RENDER (GÃ–RÃœNÃœM) FONKSÄ°YONLARI ---

        function renderDailyTasks(dunyevi, ilmi) {
            const dunyeviContainer = $("#dunyevi-tasks");
            const ilmiContainer = $("#ilmi-tasks");
            
            dunyeviContainer.innerHTML = dunyevi.length ? '' : '<p class="text-gray-400 italic">DÃ¼nyevi gÃ¶rev yok.</p>';
            ilmiContainer.innerHTML = ilmi.length ? '' : '<p class="text-gray-400 italic">Ä°lmi gÃ¶rev yok.</p>';

            dunyevi.forEach(task => dunyeviContainer.appendChild(createTaskElement(task, 'daily')));
            ilmi.forEach(task => ilmiContainer.appendChild(createTaskElement(task, 'daily')));
        }

        function renderWeeklyTasks(tasks) {
            const container = $("#haftalik-tasks");
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic">HaftalÄ±k gÃ¶rev yok.</p>';
            tasks.forEach(task => container.appendChild(createTaskElement(task, 'weekly')));
        }
        
        function renderPool(tasks, containerId) {
            const container = $(`#${containerId}`);
            if (!container) {
                console.error(`Havuz konteyneri bulunamadÄ±: #${containerId}`);
                return;
            }
            
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic text-sm">Bu havuzda gÃ¶rev yok.</p>';
            tasks.forEach(task => {
                const el = document.createElement('div');
                el.className = 'pool-item bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';
                el.dataset.id = task.id;
                el.dataset.title = task.title;
                
                el.innerHTML = `
                    <span class="flex-grow text-gray-700">${task.title}</span>
                    <button class="toggle-default-btn text-lg ${task.isDefault ? 'text-yellow-500' : 'text-gray-300'}" title="VarsayÄ±lan olarak ayarla">
                        ${task.isDefault ? 'â˜…' : 'â˜†'}
                    </button>
                    <button class="delete-pool-btn text-red-400 hover:text-red-600 ml-2" title="Havuzdan sil">
                        &times;
                    </button>
                `;
                
                el.querySelector('span').onclick = () => handlePoolClick(task, containerId);
                el.querySelector('.toggle-default-btn').onclick = (e) => {
                    e.stopPropagation();
                    toggleTaskDefault(task.id, poolTypeFromContainer(containerId));
                };
                el.querySelector('.delete-pool-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteFromPool(task.id, poolTypeFromContainer(containerId));
                };
                
                container.appendChild(el);
            });
        }
        
        /**
         * GÃœNCELLENDÄ°: ArtÄ±k Chart.js kullanarak grafikleri Ã§izer
         */
        function renderStats(dailyStats, weeklyStats) {
            const dailyContainer = $("#daily-chart-tab");
            const weeklyContainer = $("#weekly-chart-tab");
            const noStatsMsg = $("#no-stats-message");

            if (!dailyContainer || !weeklyContainer || !noStatsMsg) {
                console.error("Ä°statistik canvas konteynerlarÄ± bulunamadÄ±.");
                return;
            }
            
            // Ã–nceki chart'larÄ± yok et (varsa)
            if (dailyChartInstance) dailyChartInstance.destroy();
            if (weeklyChartInstance) weeklyChartInstance.destroy();

            const dailyEntries = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0])); // Tarihe gÃ¶re sÄ±rala
            const weeklyEntries = Object.entries(weeklyStats).sort((a, b) => a[0].localeCompare(b[0])); // Haftaya gÃ¶re sÄ±rala

            if (dailyEntries.length === 0 && weeklyEntries.length === 0) {
                noStatsMsg.classList.remove('hidden');
                dailyContainer.classList.add('hidden');
                weeklyContainer.classList.add('hidden');
                return;
            }
            
            noStatsMsg.classList.add('hidden');

            // --- GÃ¼nlÃ¼k Grafik ---
            if (dailyEntries.length > 0) {
                // Konteynerin iÃ§ini temizle (canvas'Ä± yeniden oluÅŸtur)
                dailyContainer.innerHTML = '<canvas id="daily-stats-chart"></canvas>';
                const dailyCtx = $('#daily-stats-chart').getContext('2d');
                
                const dailyLabels = dailyEntries.map(entry => {
                    const [date] = entry;
                    return new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                });
                const dailyData = dailyEntries.map(entry => entry[1].success);

                dailyChartInstance = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'GÃ¼nlÃ¼k BaÅŸarÄ± %',
                            data: dailyData,
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3 // EÄŸri iÃ§in
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 dailyContainer.innerHTML = '<p class="text-gray-500 p-4">GÃ¶sterilecek gÃ¼nlÃ¼k istatistik verisi yok.</p>';
            }

            // --- HaftalÄ±k Grafik ---
            if (weeklyEntries.length > 0) {
                // Konteynerin iÃ§ini temizle (canvas'Ä± yeniden oluÅŸtur)
                weeklyContainer.innerHTML = '<canvas id="weekly-stats-chart"></canvas>';
                const weeklyCtx = $('#weekly-stats-chart').getContext('2d');
                
                const weeklyLabels = weeklyEntries.map(entry => entry[0]); // Ã–rn: "2025-W45"
                const weeklyData = weeklyEntries.map(entry => entry[1].success);

                weeklyChartInstance = new Chart(weeklyCtx, {
                    type: 'line',
                    data: {
                        labels: weeklyLabels,
                        datasets: [{
                            label: 'HaftalÄ±k BaÅŸarÄ± %',
                            data: weeklyData,
                            borderColor: 'rgb(217, 70, 239)', // fuchsia-500
                            backgroundColor: 'rgba(217, 70, 239, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 weeklyContainer.innerHTML = '<p class="text-gray-500 p-4">GÃ¶sterilecek haftalÄ±k istatistik verisi yok.</p>';
            }
            
             // Grafikleri ilk yÃ¼klemede doÄŸru sekmede gÃ¶ster
            $('#daily-chart-tab').classList.remove('hidden');
            $('#weekly-chart-tab').classList.add('hidden');
        }


        function createTaskElement(task, taskListType) {
            const el = document.createElement('div');
            el.className = 'task-item bg-white p-4 rounded-lg shadow-md flex items-center space-x-4';
            el.dataset.id = task.id;

            if (taskListType === 'daily') {
                el.innerHTML = `
                    <span class="status-btn status-${task.status}" data-status="${task.status}" title="Durumu deÄŸiÅŸtir"></span>
                    <span class="flex-grow text-gray-800">${task.title}</span>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl" title="GÃ¶revi sil">&times;</button>
                `;
                el.querySelector('.status-btn').onclick = () => updateTaskStatus(task.id, task.status);
                el.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'daily');
                
            } else if (taskListType === 'weekly') {
                el.innerHTML = `
                    <span class="flex-grow text-gray-800">${task.title} (Haftada ${task.frequency} kez)</span>
                    <div class="flex space-x-2 items-center">
                        ${Array(task.frequency).fill(0).map((_, i) => 
                            `<input type="checkbox" class="weekly-checkbox w-5 h-5" data-index="${i}" ${i < task.completed ? 'checked' : ''}>`
                        ).join('')}
                    </div>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl ml-4" title="GÃ¶revi sil">&times;</button>
                `;
                el.querySelectorAll('.weekly-checkbox').forEach(cb => {
                    cb.onchange = () => updateWeeklyTask(task.id);
                });
                el.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'weekly');
            }
            return el;
        }

        /**
         * YENÄ°: Statik arka plan listesini DOM'a Ã§izer (Ã‡iÃ§ekler)
         */
        function renderStaticBackgrounds() {
            const container = $("#bg-results-grid");
            if (!container) return;

            container.innerHTML = ""; // Temizle
            
            FLOWER_BACKGROUND_PRESETS.forEach(item => {
                container.appendChild(createThumbnail(item.url, item.style));
            });
        }
        
        /**
         * YENÄ°: Tek bir kÃ¼Ã§Ã¼k resim (thumbnail) elementi oluÅŸturur ve dÃ¶ndÃ¼rÃ¼r
         */
        function createThumbnail(url, title = "Arka planÄ± seÃ§") {
            const thumb = document.createElement('div');
            thumb.className = 'bg-thumbnail';
            thumb.style.backgroundImage = `url('${url}')`;
            thumb.title = title; // Yeni title kullanÄ±mÄ±
            thumb.onclick = () => {
                document.body.style.backgroundImage = `url('${url}')`;
                lsSet('settings_userBackground', url); // SeÃ§imi kaydet
            };
            return thumb;
        }


        // --- DÄ°ÄžER YARDIMCI VE Ä°ÅžLEM FONKSÄ°YONLARI ---

        /**
         * TÃ¼m UI event listener'larÄ±nÄ± ayarlar.
         */
        function setupEventListeners() {
            // GÃ¶rev Ekleme
            $("#add-task-btn").onclick = handleAddTask;
            $("#new-task-title").onkeydown = (e) => {
                if(e.key === 'Enter') handleAddTask();
            };
            
            // GÃ¶rev Tipi SeÃ§imi (HaftalÄ±k iÃ§in frekans gÃ¶sterme) (Ä°stek 5)
            $("#new-task-type").onchange = (e) => {
                if (e.target.value === 'haftalik') {
                    $("#new-task-frequency").classList.remove('hidden');
                } else {
                    $("#new-task-frequency").classList.add('hidden');
                }
            };
            
            // Ana Sekme DeÄŸiÅŸimi
            $$(".tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent'); // Pasif stil
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent'); // Aktif stil
                    
                    $$(".tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.tab + "-tab").classList.remove('hidden');
                };
            });
            
            // Havuz Sekme DeÄŸiÅŸimi
            $$(".pool-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".pool-tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent');
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent');
                    
                    $$(".pool-tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.poolTab).classList.remove('hidden');
                };
            });

            // YENÄ°: Ä°statistik alt sekme deÄŸiÅŸimi
            $$(".stats-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    // TÃ¼m butonlarÄ± pasif yap
                    $$(".stats-tab-btn").forEach(b => {
                        b.classList.remove('text-indigo-600', 'border-indigo-600');
                        b.classList.add('text-gray-500');
                    });
                    // TÄ±klananÄ± aktif yap
                    e.target.classList.add('text-indigo-600', 'border-indigo-600');
                    e.target.classList.remove('text-gray-500');
                    
                    // TÃ¼m iÃ§erikleri gizle
                    $$(".stats-tab-content").forEach(c => c.classList.add('hidden'));
                    
                    // Ä°lgili iÃ§eriÄŸi gÃ¶ster
                    const tabId = e.target.dataset.statsTab + "-tab";
                    const contentTab = $("#" + tabId);
                    if (contentTab) {
                        contentTab.classList.remove('hidden');
                    }
                };
            });
            
            // NÃ¶bet Ä°ÅŸleme (Ä°stek 8)
            $("#rota-process-btn").onclick = processRota;
            
            // YENÄ°: Ayar kaydetme butonlarÄ±
            $("#api-key-save-btn").onclick = saveApiKey;
            $('#rota-name-input').onblur = saveRotaName; // Ä°sim kutusundan Ã§Ä±kÄ±nca kaydet
            
            // YENÄ°: Yerel Arka Plan YÃ¼kleme
            $("#upload-bg-btn").onclick = handleLocalBackgroundUpload;

            // Modal Kapatma
            $("#modal-close-btn").onclick = () => $("#message-modal").classList.add('hidden');
            
            // GeÃ§miÅŸ Modal
            $("#show-history-btn").onclick = showHistoryModal;
            $("#history-modal-close-btn").onclick = () => $("#history-modal").classList.add('hidden');
            
            // YENÄ°: Veri Yedekleme Event Listeners
            $("#export-data-btn").onclick = exportData;
            $("#import-data-btn").onclick = () => $("#import-file-input").click(); // Gizli input'u tetikle
            $("#import-file-input").onchange = importData;
        }

        // --- CRUD Ä°ÅžLEMLERÄ° ---

        /**
         * YENÄ°: API AnahtarÄ±nÄ± kaydeder
         */
        function saveApiKey() {
            const apiKey = $("#api-key-input").value.trim();
            lsSet('settings_apiKey', apiKey);
            showMessage("Kaydedildi", "API AnahtarÄ±nÄ±z tarayÄ±cÄ±nÄ±za kaydedildi.");
        }

        /**
         * YENÄ°: NÃ¶bet ismini kaydeder
         */
        function saveRotaName() {
            const rotaName = $("#rota-name-input").value.trim();
            lsSet('settings_rotaName', rotaName);
        }

        /**
         * Formdan aldÄ±ÄŸÄ± veriye gÃ¶re yeni gÃ¶rev ekler (gÃ¼nlÃ¼k veya haftalÄ±k)
         */
        async function handleAddTask() {
            const title = $("#new-task-title").value.trim();
            const type = $("#new-task-type").value;
            const frequency = parseInt($("#new-task-frequency").value) || 1;
            
            if (!title) {
                showMessage("Hata", "LÃ¼tfen bir gÃ¶rev adÄ± girin.");
                return;
            }

            try {
                if (type === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        frequency: frequency,
                        completed: 0
                    });
                    lsSet(key, tasks);
                    loadWeeklyTasks(); // UI'Ä± yenile (iÃ§inde haftalÄ±k baÅŸarÄ± hesaplamasÄ± var)

                } else {
                    const key = `tasks_daily_${currentDayStr}`;
                    const tasks = lsGet(key, []);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        type: type,
                        status: 0
                    });
                    lsSet(key, tasks);
                    loadDailyTasks(); // UI'Ä± yenile (iÃ§inde gÃ¼nlÃ¼k baÅŸarÄ± hesaplamasÄ± var)
                }
                
                // GÃ¶revi KÃ¼meye de ekle (Ä°stek 1)
                const poolType = (type === 'haftalik') ? 'haftalik' : (type === 'dunyevi' ? 'dunyevi' : 'ilmi');
                const poolKey = `pools_${poolType}`;
                
                const poolTasks = lsGet(poolKey, []);
                const taskExists = poolTasks.some(task => task.title === title);
                
                if (!taskExists) {
                    poolTasks.push({
                        id: Date.now().toString(),
                        title: title,
                        isDefault: false,
                        ...(type === 'haftalik' && { frequency: frequency })
                    });
                    lsSet(poolKey, poolTasks);
                    loadPools(); // UI'Ä± yenile
                }
                
                // Formu temizle
                $("#new-task-title").value = "";
                $("#new-task-frequency").value = "1";

            } catch (error) {
                console.error("GÃ¶rev ekleme hatasÄ±:", error);
                showMessage("Hata", "GÃ¶rev eklenirken bir sorun oluÅŸtu.");
            }
        }
        
        /**
         * YENÄ°: Havuzdan bir gÃ¶reve tÄ±klandÄ±ÄŸÄ±nda onu gÃ¼nlÃ¼k listeye ekler
         */
        function handlePoolClick(task, containerId) {
            try {
                const poolType = poolTypeFromContainer(containerId);
                if (!poolType) return;
                
                if (poolType === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            frequency: task.frequency || 1,
                            completed: 0
                        });
                        lsSet(key, tasks);
                        loadWeeklyTasks();
                    }
                } else {
                    const key = `tasks_daily_${currentDayStr}`;
                    const tasks = lsGet(key, []);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            type: poolType,
                            status: 0
                        });
                        lsSet(key, tasks);
                        loadDailyTasks();
                    }
                }
            } catch (error) {
                console.error("Havuzdan gÃ¶rev ekleme hatasÄ±:", error);
            }
        }
        
        /**
         * YENÄ°: GÃ¼nlÃ¼k gÃ¶revin durumunu gÃ¼nceller (0, 1, 2)
         */
        async function updateTaskStatus(taskId, currentStatus) {
            const newStatus = (currentStatus + 1) % 3;
            const key = `tasks_daily_${currentDayStr}`;
            const tasks = lsGet(key, []);
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                tasks[taskIndex].status = newStatus;
                lsSet(key, tasks);
                loadDailyTasks(); // UI'Ä± yenile (iÃ§inde baÅŸarÄ± hesaplamasÄ± var)
            }
        }
        
        /**
         * YENÄ°: HaftalÄ±k gÃ¶revin tamamlanma sayÄ±sÄ±nÄ± gÃ¼nceller
         */
        async function updateWeeklyTask(taskId) {
            const taskElement = document.querySelector(`.task-item[data-id="${taskId}"]`);
            if (!taskElement) return;
            
            const checkboxes = taskElement.querySelectorAll('.weekly-checkbox');
            const completedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            const key = `tasks_weekly_${currentWeekStr}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].completed = completedCount;
                lsSet(key, tasks);
                calculateWeeklySuccess(); // YENÄ°: HaftalÄ±k baÅŸarÄ±yÄ± anÄ±nda gÃ¼ncelle
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revi gÃ¼nlÃ¼k/haftalÄ±k listeden siler
         */
        async function deleteTask(taskId, taskType) {
            if (taskType === 'daily') {
                const key = `tasks_daily_${currentDayStr}`;
                let tasks = lsGet(key, []);
                tasks = tasks.filter(t => t.id !== taskId);
                lsSet(key, tasks);
                loadDailyTasks();
            } else if (taskType === 'weekly') {
                const key = `tasks_weekly_${currentWeekStr}`;
                let tasks = lsGet(key, []);
                tasks = tasks.filter(t => t.id !== taskId);
                lsSet(key, tasks);
                loadWeeklyTasks();
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revin havuzdaki varsayÄ±lan (isDefault) durumunu deÄŸiÅŸtirir
         */
        async function toggleTaskDefault(taskId, poolType) {
            const key = `pools_${poolType}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].isDefault = !tasks[taskIndex].isDefault;
                lsSet(key, tasks);
                loadPools(); // UI'Ä± yenile
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revi havuzdan kalÄ±cÄ± olarak siler
         */
        async function deleteFromPool(taskId, poolType) {
            const key = `pools_${poolType}`;
            let tasks = lsGet(key, []);
            tasks = tasks.filter(t => t.id !== taskId);
            lsSet(key, tasks);
            loadPools(); // UI'Ä± yenile
        }
        
        /**
         * YENÄ°: BaÅŸarÄ± oranÄ±nÄ± hesaplar ve gÃ¶sterir
         */
        function calculateSuccess(tasks = null) {
            if (tasks === null) {
                tasks = lsGet(`tasks_daily_${currentDayStr}`, []);
            }
            
            const total = tasks.length;
            if (total === 0) {
                $("#success-rate").textContent = "0%";
                return { total: 0, completed: 0 };
            }
            
            // YarÄ±m yapÄ±lanlar 0.5, tam yapÄ±lanlar 1 puan
            const completed = tasks.reduce((sum, task) => {
                if (task.status === 1) return sum + 0.5;
                if (task.status === 2) return sum + 1;
                return sum;
            }, 0);
            
            const successRate = Math.round((completed / total) * 100);
            $("#success-rate").textContent = `${successRate}%`;
            
            return { total, completed };
        }

        /**
         * YENÄ°: HaftalÄ±k baÅŸarÄ± oranÄ±nÄ± hesaplar.
         * tasks null ise, mevcut haftayÄ± LS'den okur ve UI'Ä± gÃ¼nceller.
         * tasks doluysa, o gÃ¶rev listesi iÃ§in oranÄ± hesaplar ve dÃ¶ndÃ¼rÃ¼r.
         */
        function calculateWeeklySuccess(tasks = null, weekId = null) {
            let updateUI = false;
            if (tasks === null) {
                weekId = weekId || currentWeekStr;
                tasks = lsGet(`tasks_weekly_${weekId}`, []);
                updateUI = true;
            }

            if (tasks.length === 0) {
                if(updateUI) $("#weekly-success-rate").textContent = "0%";
                return 0; // BaÅŸarÄ± oranÄ±
            }

            const totalFrequency = tasks.reduce((sum, task) => sum + (task.frequency || 1), 0);
            const totalCompleted = tasks.reduce((sum, task) => sum + task.completed, 0);

            if (totalFrequency === 0) {
                if(updateUI) $("#weekly-success-rate").textContent = "0%";
                return 0;
            }
            
            const successRate = Math.round((totalCompleted / totalFrequency) * 100);
            
            if (updateUI) {
                $("#weekly-success-rate").textContent = `${successRate}%`;
            }
            
            return successRate;
        }
        
        /**
         * YENÄ°: GeÃ§miÅŸ gÃ¼nleri modal'da gÃ¶sterir
         */
        function showHistoryModal() {
            const history = lsGet('history', {});
            const historyList = $("#history-list");
            const sortedDates = Object.keys(history).sort((a, b) => b.localeCompare(a)); // En yeni en Ã¼stte
            
            if (sortedDates.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500">GÃ¶sterilecek geÃ§miÅŸ gÃ¼n kaydÄ± yok.</p>';
                $("#history-modal").classList.remove('hidden');
                return;
            }
            
            historyList.innerHTML = "";
            sortedDates.forEach(date => {
                const tasks = history[date];
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const dateEl = document.createElement('div');
                dateEl.className = 'p-4 bg-gray-50 rounded-lg shadow-sm';
                dateEl.innerHTML = `
                    <h4 class="font-bold text-lg text-pink-500">${new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', day:'numeric', month:'long' })}</h4>
                    <p class="text-sm font-semibold text-green-600 mb-2">BaÅŸarÄ±: ${successRate}%</p>
                    <ul class="list-disc list-inside ml-2">
                        ${tasks.map(t => `<li class="text-gray-700 ${t.status === 2 ? 'line-through' : ''} ${t.status === 0 ? 'opacity-60' : ''}">${t.title} (${t.type === 'ilmi' ? 'Ä°lmi' : 'DÃ¼nyevi'} - ${t.status === 2 ? 'Tamam' : (t.status === 1 ? 'YarÄ±m' : 'YapÄ±lmadÄ±')})</li>`).join('')}
                    </ul>
                `;
                historyList.appendChild(dateEl);
            });
            
            $("#history-modal").classList.remove('hidden');
        }
        
        /**
         * YENÄ°: Havuz konteyner ID'sinden havuz tipini dÃ¶ndÃ¼rÃ¼r
         */
        function poolTypeFromContainer(containerId) {
            if (containerId.includes('dunyevi')) return 'dunyevi';
            if (containerId.includes('ilmi')) return 'ilmi';
            if (containerId.includes('haftalik')) return 'haftalik';
            return null;
        }

        /**
         * KullanÄ±cÄ±ya modal iÃ§inde mesaj gÃ¶sterir
         */
        function showMessage(title, message) {
            const modalTitle = $("#modal-title");
            const modalMessage = $("#modal-message");
            const modal = $("#message-modal");

            if (modalTitle && modalMessage && modal) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.error("Modal elementleri bulunamadÄ±. Mesaj gÃ¶sterilemedi:", title, message);
            }
        }
        
        /**
         * Bir tarih objesinden hafta ID'si (YYYY-WW) oluÅŸturur
         */
        function getWeekId(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`; // GÃœNCELLENDÄ°: W Eklendi
        }
        
        /**
         * DosyayÄ± Base64 string'e Ã§evirir (NÃ¶bet Ã§izelgesi iÃ§in)
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * YENÄ°: DosyayÄ± Base64 URL'ye (data:image/...) Ã§evirir (Arka plan iÃ§in)
         */
        function fileToBase64Url(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * YENÄ°: GÃ¼nlÃ¼k Ayet/Hadis/SÃ¶z'Ã¼ ayarlar (Ä°stek 7)
         */
        function setDailyQuote() {
            try {
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                const index = dayOfYear % GUNLUK_SOZLER.length;
                
                const sozler = GUNLUK_SOZLER[index];

                $("#quote-ayet").textContent = `"${sozler.ayet.text}"`;
                $("#quote-ayet-source").textContent = `â€” ${sozler.ayet.source}`;
                
                $("#quote-hadis").textContent = `"${sozler.hadis.text}"`;
                $("#quote-hadis-source").textContent = `â€” ${sozler.hadis.source}`;
                
                $("#quote-soz").textContent = `"${sozler.soz.text}"`;
                $("#quote-soz-source").textContent = `â€” ${sozler.soz.source}`;

            } catch (error) {
                console.error("GÃ¼nÃ¼n sÃ¶zÃ¼ yÃ¼klenemedi:", error);
                $("#quote-ayet").textContent = "GÃ¼nÃ¼n sÃ¶zÃ¼ yÃ¼klenirken bir hata oluÅŸtu.";
            }
        }
        
        /**
         * YENÄ°: BaÅŸlangÄ±Ã§ta kayÄ±tlÄ± veya varsayÄ±lan arka planÄ± ayarlar
         */
        function setDailyBackground() {
            try {
                const savedBg = lsGet('settings_userBackground', null);
                if (savedBg) {
                    document.body.style.backgroundImage = `url('${savedBg}')`;
                } else {
                    // KayÄ±tlÄ± bir ÅŸey yoksa, varsayÄ±lanlardan ilkini ayarla
                    document.body.style.backgroundImage = `url('${DEFAULT_FALLBACK_BG}')`;
                }
            } catch (error) {
                console.error("Arka plan yÃ¼klenemedi:", error);
                document.body.style.backgroundColor = '#f3f4f6'; // bg-gray-100
            }
        }

        // --- YAPAY ZEKA VE YEREL YÃœKLEME FONKSÄ°YONLARI ---
        
        /**
         * YENÄ°: Yerel Dosya YÃ¼kleme Ä°ÅŸleyicisi
         */
        async function handleLocalBackgroundUpload() {
            const fileInput = $("#local-bg-upload");
            const uploadStatus = $("#upload-status");
            if (fileInput.files.length === 0) {
                showMessage("Hata", "LÃ¼tfen Ã¶nce bilgisayarÄ±nÄ±zdan bir resim dosyasÄ± seÃ§in.");
                return;
            }

            const file = fileInput.files[0];
            uploadStatus.textContent = "YÃ¼kleniyor...";
            uploadStatus.classList.remove('hidden');

            try {
                // DosyayÄ± Base64 URL'ye Ã§evir (bu link hatalarÄ±nÄ± Ã§Ã¶zer)
                const base64Url = await fileToBase64Url(file);
                
                // Arka planÄ± ayarla
                document.body.style.backgroundImage = `url('${base64Url}')`;
                lsSet('settings_userBackground', base64Url); // Base64 URL'yi kaydet

                showMessage("BaÅŸarÄ±lÄ±", "Yerel resminiz arka plan olarak ayarlandÄ± ve kaydedildi!");
            } catch (error) {
                console.error("Yerel arka plan yÃ¼kleme hatasÄ±:", error);
                showMessage("YÃ¼kleme HatasÄ±", "Resim yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen dosya tipini kontrol edin.");
            } finally {
                uploadStatus.classList.add('hidden');
            }
        }

        /**
         * NÃ¶bet Ã§izelgesi resmini iÅŸler (Ä°stek 8)
         * GÃœNCELLENDÄ°: ArtÄ±k her Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r ve rota adÄ±nÄ± kontrol eder.
         */
        async function processRota() {
            const fileInput = $("#rota-upload");
            
            // HATA DÃœZELTMESÄ°: Global referanslarÄ± kullan ve DOM'da bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et.
            if (!rotaLoader || !rotaOutput) {
                // Kritik DOM elemanlarÄ± yÃ¼kleme sÄ±rasÄ±nda alÄ±namadÄ±ysa bu hatayÄ± verir.
                console.error("processRota: Kritik DOM elemanlarÄ± (loader/output) yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
                showMessage("Hata", "NÃ¶bet arayÃ¼zÃ¼ tam yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
                return; 
            }
            
            // Ä°stek 2: Her zaman nÃ¶bet adÄ±nÄ± kontrol et
            const rotaName = lsGet('settings_rotaName', '').trim();
            const apiKey = lsGet('settings_apiKey', '');
            
            if (!apiKey) {
                showMessage("Hata", "Yapay zeka Ã¶zelliÄŸini kullanmak iÃ§in lÃ¼tfen 'Ayarlar' bÃ¶lÃ¼mÃ¼nden API anahtarÄ±nÄ±zÄ± girin.");
                return;
            }
            if (!rotaName) {
                showMessage("Hata", "LÃ¼tfen 'NÃ¶bet Takibi' bÃ¶lÃ¼mÃ¼nden aranacak bir isim girin.");
                return;
            }
            if (fileInput.files.length === 0) {
                showMessage("Hata", "LÃ¼tfen Ã¶nce bir resim dosyasÄ± seÃ§in.");
                return;
            }

            const file = fileInput.files[0];
            const mimeType = file.type;
            
            // UI'Ä± sÄ±fÄ±rla ve yÃ¼klemeyi baÅŸlat
            rotaLoader.classList.remove('hidden');
            rotaOutput.innerHTML = ""; // Ã–nceki sonucu temizle
            
            try {
                const base64Data = await fileToBase64(file);
                const model = "gemini-2.5-flash-preview-09-2025";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: `Bu bir hastane nÃ¶bet Ã§izelgesidir. GÃ¶rÃ¼ntÃ¼deki '${rotaName}' ismine ait tÃ¼m nÃ¶bet gÃ¼nlerini tarihleri (GG.AA.YYYY formatÄ±nda) ve haftanÄ±n gÃ¼nÃ¼ (Pazartesi, SalÄ±, vb.) olarak Ã§Ä±kar. Sadece bu ayÄ±n tarihlerini listele. NÃ¶betler arasÄ±ndaki boÅŸ gÃ¼n sayÄ±sÄ±nÄ± hesapla. Sonucu sade ve anlaÅŸÄ±lÄ±r bir liste olarak TÃ¼rkÃ§e ver.` },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API hatasÄ±: ${response.statusText}`);
                }
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
                
                // Sonucu yerel depolamaya kaydet
                lsSet('metadata_rotaInfo', {
                    text: text,
                    updatedAt: new Date().toISOString()
                });

            } catch (error) {
                console.error("NÃ¶bet iÅŸleme hatasÄ±:", error);
                rotaOutput.innerHTML = `<p class="text-red-500">NÃ¶bet listesi iÅŸlenemedi. ${error.message}</p>`;
            } finally {
                rotaLoader.classList.add('hidden');
            }
        }
        
        // --- YENÄ°: VERÄ° YEDEKLEME FONKSÄ°YONLARI ---

        /**
         * TÃ¼m uygulama verilerini (LS_PREFIX ile baÅŸlayan) bir JSON dosyasÄ± olarak indirir.
         */
        function exportData() {
            try {
                console.log("Veriler dÄ±ÅŸa aktarÄ±lÄ±yor...");
                const backupData = {};
                
                // localStorage'daki tÃ¼m anahtarlarÄ± dolaÅŸ
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Sadece bizim uygulamamÄ±za ait olanlarÄ± al
                    if (key.startsWith(LS_PREFIX)) {
                        // DeÄŸer zaten lsSet tarafÄ±ndan stringify edildiÄŸi iÃ§in ham deÄŸeri alÄ±yoruz.
                        backupData[key] = localStorage.getItem(key);
                    }
                }
                
                if (Object.keys(backupData).length === 0) {
                    showMessage("Bilgi", "Yedeklenecek hiÃ§bir veri bulunamadÄ±.");
                    return;
                }

                // JSON verisini string'e Ã§evir (okunaklÄ± olmasÄ± iÃ§in 2 boÅŸluklu formatlama)
                const jsonString = JSON.stringify(backupData, null, 2);
                // Bir dosya "blob"u oluÅŸtur
                const blob = new Blob([jsonString], { type: "application/json" });
                // Bu blob iÃ§in geÃ§ici bir URL oluÅŸtur
                const url = URL.createObjectURL(blob);
                
                // Ä°ndirmeyi tetiklemek iÃ§in gÃ¶rÃ¼nmez bir link (<a>) oluÅŸtur
                const a = document.createElement('a');
                a.href = url;
                a.download = `ya-sahibez-zaman-yedek-${currentDayStr}.json`; // Dosya adÄ±
                document.body.appendChild(a); // Linki sayfaya ekle
                a.click(); // Linke tÄ±kla (indirmeyi baÅŸlat)
                document.body.removeChild(a); // Linki kaldÄ±r
                URL.revokeObjectURL(url); // GeÃ§ici URL'yi temizle
                
                showMessage("BaÅŸarÄ±lÄ±", "TÃ¼m verileriniz JSON dosyasÄ± olarak indiriliyor.");
            } catch (error) {
                console.error("DÄ±ÅŸa aktarma hatasÄ±:", error);
                showMessage("Hata", "Veriler dÄ±ÅŸa aktarÄ±lÄ±rken bir sorun oluÅŸtu.");
            }
        }

        /**
         * KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi bir JSON yedek dosyasÄ±nÄ± okur ve localStorage'a geri yÃ¼kler.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // KullanÄ±cÄ± dosya seÃ§mekten vazgeÃ§ti
            }
            
            const reader = new FileReader();
            
            // Dosya okuma tamamlandÄ±ÄŸÄ±nda...
            reader.onload = function(e) {
                try {
                    const jsonString = e.target.result;
                    // Okunan metni JSON olarak ayrÄ±ÅŸtÄ±r
                    const backupData = JSON.parse(jsonString);
                    
                    if (Object.keys(backupData).length === 0) {
                        showMessage("Hata", "Yedek dosyasÄ± boÅŸ veya geÃ§ersiz.");
                        return;
                    }

                    let validKeyFound = false;
                    
                    // JSON iÃ§indeki her anahtar/deÄŸer Ã§ifti iÃ§in...
                    for (const key in backupData) {
                        // EÄŸer anahtar bizim Ã¶nekimizle baÅŸlÄ±yorsa (doÄŸru dosya mÄ± diye kontrol)
                        if (key.startsWith(LS_PREFIX)) {
                            const value = backupData[key];
                            // DeÄŸer (zaten string) doÄŸrudan localStorage'a yazÄ±lÄ±r.
                            localStorage.setItem(key, value);
                            validKeyFound = true;
                        }
                    }

                    if (!validKeyFound) {
                        showMessage("Hata", "Bu dosya, bu uygulamaya ait geÃ§erli bir yedek dosyasÄ± deÄŸil.");
                        return;
                    }
                    
                    showMessage("BaÅŸarÄ±lÄ±", "Veriler baÅŸarÄ±yla geri yÃ¼klendi! Uygulama yenileniyor...");
                    
                    // Verilerin dÃ¼zgÃ¼n yÃ¼klenmesi iÃ§in sayfayÄ± yeniden baÅŸlat
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // 2 saniye bekle (kullanÄ±cÄ± mesajÄ± gÃ¶rsÃ¼n)

                } catch (error) {
                    console.error("Ä°Ã§e aktarma hatasÄ±:", error);
                    showMessage("Hata", "Yedek dosyasÄ± okunurken bir hata oluÅŸtu. Dosya bozuk veya JSON formatÄ±nda deÄŸil.");
                } finally {
                    // AynÄ± dosyayÄ± tekrar seÃ§ebilmek iÃ§in input'u sÄ±fÄ±rla
                    event.target.value = null;
                }
            };
            
            // DosyayÄ± metin olarak oku
            reader.readAsText(file);
        }

    </script>
</body>
</html>