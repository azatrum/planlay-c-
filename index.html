<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya Sahibez Zaman</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter ve s√ºsl√º bir font) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <!-- YENƒ∞: Chart.js K√ºt√ºphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* √ñzel stiller */
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }

        /* Ba≈ülƒ±k i√ßin s√ºsl√º font */
        .fancy-title {
            font-family: 'Dancing Script', cursive;
        }

        /* Yarƒ± saydam arka planlar (ƒ∞stek 13) */
        .glass-bg {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* G√∂rev kutucuklarƒ± i√ßin sarma≈üƒ±k/√ßi√ßek benzeri kenarlƒ±k (ƒ∞stek 15) */
        .task-box, .pool-box {
            border: 2px solid;
            border-image-slice: 1;
            border-width: 2px;
            border-image-source: linear-gradient(to right, #fbc2eb, #a6c1ee);
            transition: all 0.3s ease;
        }

        /* YENƒ∞: Ana kutucuklar i√ßin dinamik hover (ƒ∞stek 1) */
        .task-box:hover, .pool-box:hover {
            transform: scale(1.01); /* Hafif b√ºy√ºme */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Hafif g√∂lge */
        }

        /* YENƒ∞: Temel g√∂rev/havuz item stilleri (ƒ∞stek 14/2) */
        .task-item, .pool-item {
            transition: all 0.2s ease-in-out; /* Hƒ±zlandƒ±rƒ±ldƒ± */
            opacity: 0.95; /* Hafif soluk */
        }

        /* Hover efekti (ƒ∞stek 14 / G√úNCELLENDƒ∞) */
        .task-item:hover, .pool-item:hover {
            transform: scale(1.04); /* Biraz daha b√ºy√ºt√ºld√º */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); /* G√∂lge belirginle≈ütirildi */
            opacity: 1; /* Tam opak */
            z-index: 10; /* √úste √ßƒ±ksƒ±n */
            position: relative; /* Hover anƒ±nda √ºste √ßƒ±ksƒ±n */
        }
        
        /* Havuz itemlerine √∂zel (tƒ±klanabilir hissi i√ßin) (ƒ∞stek 2) */
        .pool-item {
            cursor: pointer;
        }
        
        /* G√∂rev durumu ikonlarƒ± (ƒ∞stek 4) */
        .status-btn {
            cursor: pointer;
            font-size: 1.5rem; /* 24px */
            transition: transform 0.2s;
        }
        .status-btn:hover {
            transform: scale(1.2);
        }
        /* 0: Yapƒ±lmadƒ± (Bo≈ü), 1: Yarƒ±m (Ay), 2: Tam (G√ºne≈ü/Yƒ±ldƒ±z) */
        .status-0::before { content: 'üî≤'; color: #cbd5e1; }
        .status-1::before { content: 'üåó'; color: #f59e0b; }
        .status-2::before { content: '‚úÖ'; color: #10b981; }

        /* Y√ºkleme g√∂stergesi (Spinner) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a6c1ee;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* √ñzel Kaydƒ±rma √áubuƒüu */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #fbc2eb, #a6c1ee);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            transform: scale(1.05);
        }

        /* YENƒ∞: Arka plan galeri stilleri */
        .bg-thumbnail {
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem; /* 8px */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bg-thumbnail:hover {
            transform: scale(1.05);
            border-color: #fbc2eb; /* Pembe */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* YENƒ∞: Tema Kategori Butonlarƒ± */
        .theme-btn {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #374151; /* gray-700 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .theme-btn:hover {
            background-color: white;
            color: #db2777; /* pink-600 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Havuz butonu √∂zel animasyonlu stil */
        .pool-open-btn {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: white;
            font-weight: 700;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            box-shadow: 0 10px 25px rgba(166, 193, 238, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-position 0.25s ease;
            background-size: 200% 200%;
            background-position: 50% 50%;
        }
        .pool-open-btn:hover {
            transform: scale(1.08);
            background-position: 100% 0%;
            box-shadow: 0 14px 32px rgba(251, 194, 235, 0.45);
        }

        /* 2D Havuz ve Ta≈üƒ±yƒ±cƒ± Animasyonlarƒ± */
        .progress-scene { position: relative; min-height: 140px; }
        .pool {
            position: relative; width: 180px; height: 90px;
            border: 3px solid rgba(0,0,0,0.08);
            border-radius: 0.75rem 0.75rem 1.2rem 1.2rem;
            overflow: hidden; margin: 0 auto;
            background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.9));
        }
        .pool-water { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.6s ease; }
        .pool-water.daily { background: linear-gradient(180deg, rgba(16,185,129,0.7), rgba(16,185,129,0.9)); }
        .pool-water.weekly { background: linear-gradient(180deg, rgba(59,130,246,0.7), rgba(59,130,246,0.9)); }
        .carrier { position: absolute; bottom: 0; font-size: 1.6rem; animation: 4s ease-in-out infinite; display: inline-flex; align-items: center; gap: 6px; }
        .carrier-left { left: 0; animation-name: walk-left; }
        .carrier-right { right: 0; animation-name: walk-right; }
        @keyframes walk-left { 0%{transform:translateX(0)} 50%{transform:translateX(40%)} 100%{transform:translateX(0)} }
        @keyframes walk-right { 0%{transform:translateX(0)} 50%{transform:translateX(-40%)} 100%{transform:translateX(0)} }

        /* Bucket + pour arc */
        .bucket { width: 16px; height: 16px; border: 2px solid #4fd1c5; border-top-color: transparent; border-radius: 3px; position: relative; display: inline-block; }
        .bucket::after { content: ""; position: absolute; right: -4px; top: 2px; width: var(--drop-size,6px); height: var(--drop-size,6px); border-radius: 50%; background: #4fd1c5; opacity: 0; transform: translate(0,0); }
        .carrier.pour .bucket { transform: rotate(-12deg); transition: transform 200ms ease; }
        .carrier.pour .bucket::after { opacity: 1; animation: drop-arc var(--drop-time,700ms) ease-in forwards; }
        @keyframes drop-arc { 0% { transform: translate(0,0); opacity: 1; } 60% { transform: translate(var(--arc-x,22px),var(--arc-y,-22px)); opacity: 1; } 100% { transform: translate(calc(var(--arc-x,22px)*2),0); opacity: 0; } }
        .pool::before { content: ""; position: absolute; left: 50%; bottom: 6px; width: 0; height: 0; border-radius: 50%; background: rgba(79,209,197,0.35); transform: translateX(-50%); opacity: 0; }
        .pool.ripple::before { animation: ripple 600ms ease-out; }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 0.7; } 100% { width: 140px; height: 44px; opacity: 0; } }

        /* Damla animasyonu (havuz √ºzerine d√º≈üen su) */
        .droplet-container { position: absolute; top: 0; left: 50%; width: 120px; height: 90px; transform: translateX(-50%); pointer-events: none; }
        .droplet { position: absolute; top: -10px; width: 8px; height: 12px; background: rgba(59,130,246,0.8); border-radius: 50% 50% 60% 60%; opacity: 0.0; animation: drop 1.6s linear infinite; }
        .droplet.green { background: rgba(16,185,129,0.8); }
        @keyframes drop { 0%{ top:-10px; opacity:0 } 20%{ opacity:1 } 80%{ opacity:1 } 100%{ top:70px; opacity:0 } }

        /* E≈üiklerde sƒ±√ßrama animasyonu */
        .splash-container { position: absolute; bottom: 0; left: 50%; width: 160px; height: 40px; transform: translateX(-50%); pointer-events: none; }
        .splash { position: absolute; bottom: 0; width: 6px; height: 6px; background: rgba(59,130,246,0.85); border-radius: 50%; opacity: 0; }
        .splash.green { background: rgba(16,185,129,0.85); }
        .splash.show { animation: splashUp 0.9s ease-out forwards; }
        @keyframes splashUp {
            0% { transform: translateY(0) scale(0.6); opacity: 0.0; }
            30% { opacity: 1; }
            60% { transform: translateY(-16px) scale(1.2); opacity: 1; }
            100% { transform: translateY(0) scale(0.8); opacity: 0; }
        }

        /* Celebration Modal */
        .celebrate-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .celebrate-modal { position: relative; width: 90%; max-width: 640px; background: linear-gradient(180deg, #fff, #fff7fb); border: 2px solid #fbc2eb; border-radius: 1rem; box-shadow: 0 20px 60px rgba(166,193,238,0.35); overflow: hidden; }
        .celebrate-header { background: linear-gradient(135deg, #fbc2eb, #a6c1ee); color: white; padding: 14px 18px; font-weight: 800; font-size: 1.35rem; letter-spacing: 0.5px; display:flex; align-items:center; justify-content:space-between; }
        .celebrate-body { padding: 16px; }
        .celebrate-message { position: relative; font-size: 1.1rem; color: #374151; line-height: 1.7; background: #fff; border: 1px solid #f3e8ff; border-radius: 0.75rem; padding: 12px 14px; box-shadow: 0 8px 20px rgba(166,193,238,0.18); }
        .celebrate-source { margin-top: 8px; font-size: 0.9rem; color: #6b7280; }
        /* Aura sparks orbiting the message */
        .aura { position: absolute; inset: -8px; pointer-events: none; }
        .aura .dot { position: absolute; width: 4px; height: 4px; border-radius: 50%; background: radial-gradient(circle,#fff,#fbc2eb); opacity: 0.0; animation: drift 6s ease-in-out infinite; }
        .aura .dot:nth-child(3n){ background: radial-gradient(circle,#fff,#a6c1ee); }
        @keyframes drift {
            0% { transform: translate(0,0); opacity: 0; }
            10% { opacity: 0.6; }
            50% { transform: translate(var(--dx, 12px), var(--dy, -8px)); opacity: 0.9; }
            100% { transform: translate(0,0); opacity: 0; }
        }
        .celebrate-close { position: absolute; top: 8px; right: 12px; color: #fff; font-weight: 700; cursor: pointer; }
        /* Fireworks */
        .fireworks { position: absolute; inset: 0; pointer-events: none; overflow:hidden; }
        .spark { position: absolute; width: var(--sz,4px); height: var(--sz,4px); background: var(--col,#ffd166); border-radius: 50%; opacity: 0; animation: pop var(--dur,1.6s) ease-out forwards; }
        @keyframes pop { 0% { transform: translate(0,0) scale(0.8); opacity: 0; } 18% { opacity: 1; } 60% { transform: translate(var(--fx, 120px), var(--fy, -160px)) scale(1.2); opacity: 1; } 100% { opacity: 0; }
        }
        /* Candles */
        .candles { display: flex; gap: 12px; justify-content: center; margin-top: 12px; }
        .candle { width: 10px; height: 32px; background: #ffe5b4; border-radius: 3px; position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .candle::before { content: ""; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 8px; height: 10px; background: radial-gradient(circle at 50% 60%, #fff59d, #ffcc80); border-radius: 50%; filter: blur(0.5px); animation: flicker 1.2s ease-in-out infinite; }
        @keyframes flicker { 0%,100% { transform: translateX(-50%) scale(1); opacity: 1; } 50% { transform: translateX(-50%) scale(1.08); opacity: 0.85; } }
        /* Confetti Canvas */
        #confetti { position:absolute; inset:0; pointer-events:none; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-4 max-w-screen-2xl">
        
        <!-- Ba≈ülƒ±k ve Tarih -->
        <header class="text-center my-6">
            <h1 class="fancy-title text-6xl font-bold text-pink-500 drop-shadow-md">Ya Sahibez Zaman</h1>
            <p id="current-date" class="text-xl text-gray-600 mt-2"></p>
            <div class="flex items-center justify-center gap-3 mt-2">
                <button id="prev-day-btn" class="bg-white/80 hover:bg-white text-gray-700 font-bold py-1 px-3 rounded-lg shadow-sm">‚óÄ</button>
                <div id="active-date-label" class="text-sm text-gray-600"></div>
                <button id="next-day-btn" class="bg-white/80 hover:bg-white text-gray-700 font-bold py-1 px-3 rounded-lg shadow-sm">‚ñ∂</button>
                <button id="open-pool-btn" class="pool-open-btn ml-3" title="G√∂rev Havuzunu A√ß">G√∂rev Havuzu</button>
            </div>
        </header>

        <!-- Ana ƒ∞√ßerik Izgarasƒ± -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Sol/Orta Panel (G√∂revler) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Ge√ßmi≈ü G√ºnler Butonu -->
                <div class="flex justify-start">
                    <button id="show-history-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        Ge√ßmi≈ü G√ºnler
                    </button>
                </div>

                <!-- Ba≈üarƒ± Oranlarƒ± √ºst ≈üerit kaldƒ±rƒ±ldƒ±; ba≈üarƒ± havuzlarƒ± s√ºtun ba≈ülƒ±klarƒ±na ta≈üƒ±ndƒ± -->

                <!-- G√∂rev D√ºzenleme Modal (Yeni) -->
                <div id="task-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <h3 class="text-2xl font-bold text-pink-600 mb-4">G√∂revi D√ºzenle</h3>
                        
                        <div class="space-y-4">
                            <!-- G√∂rev Adƒ± -->
                            <div>
                                <label class="block text-sm font-semibold mb-1">G√∂rev Adƒ±</label>
                                <input type="text" id="edit-task-title" placeholder="G√∂rev adƒ±..." class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>

                            <!-- Tekrar Sayƒ±sƒ± (sadece g√ºnl√ºk g√∂revler i√ßin) -->
                            <div id="edit-repetition-section" class="hidden">
                                <label class="block text-sm font-semibold mb-1">G√ºnde Ka√ß Defa Yapƒ±lsƒ±n?</label>
                                <input type="number" id="edit-task-repetition" min="1" value="1" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>

                            <!-- Alt G√∂revler -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold">Alt G√∂revler (Opsiyonel)</label>
                                    <button id="add-subtask-btn" class="text-sm bg-green-400 hover:bg-green-500 text-white px-3 py-1 rounded">+ Alt G√∂rev Ekle</button>
                                </div>
                                <div id="edit-subtasks-list" class="space-y-2 ml-2 border-l-2 border-pink-200 pl-3">
                                    <p class="text-gray-400 italic text-sm">Alt g√∂rev eklenmedi</p>
                                </div>
                            </div>

                            <!-- Alt G√∂revlerin Puanlandƒ±rƒ±lmasƒ± (sadece alt g√∂rev varsa g√∂r√ºn) -->
                            <div id="edit-subtask-scoring-section" class="hidden p-3 bg-pink-50 rounded-lg border border-pink-200">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="subtask-scoring" value="grouped" checked class="w-4 h-4">
                                    <span class="text-sm">Alt g√∂revlerin hepsi birlikte 1 puan ver (g√∂revin par√ßalarƒ±)</span>
                                </label>
                                <label class="flex items-center space-x-2 mt-2">
                                    <input type="radio" name="subtask-scoring" value="individual" class="w-4 h-4">
                                    <span class="text-sm">Her alt g√∂rev ayrƒ± ayrƒ± puan ver (baƒüƒ±msƒ±z g√∂revler)</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button id="edit-task-cancel-btn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">ƒ∞ptal</button>
                            <button id="edit-task-save-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Kaydet</button>
                        </div>
                    </div>
                </div>

                

            </div>

            <!-- Saƒü Panel (K√ºmeler ve Diƒüerleri) -->
            <div class="lg:col-span-1 space-y-6">

                

                <!-- Ali Murtaza Ko√ßak N√∂bet Takibi (ƒ∞stek 8) - G√úNCELLENDƒ∞ -->
                <div id="rota-card" class="glass-bg pool-box rounded-xl shadow-lg p-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-3">N√∂bet Takibi</h2>
                    
                    <!-- YENƒ∞: N√∂bet ismi giri≈üi -->
                    <div class="mb-3">
                        <label for="rota-name-input" class="text-sm font-medium text-gray-600">√áizelgede Aranacak ƒ∞sim (ƒ∞stek 3)</label>
                        <input type="text" id="rota-name-input" placeholder="√ñrn: Ali Murtaza Ko√ßak" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                    </div>

                    <p class="text-sm mb-3">N√∂bet listesini (resim) y√ºkleyin:</p>
                    <input type="file" id="rota-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                    <button id="rota-process-btn" class="w-full mt-3 bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        N√∂betleri ƒ∞≈üle
                    </button>
                    <div id="rota-output" class="mt-4 p-3 bg-white/70 rounded-lg min-h-[50px]">
                        <p class="text-gray-500 text-sm">Kaydedilmi≈ü n√∂bet bilgisi yok veya yeni liste y√ºklenmedi.</p>
                        <!-- Y√ºkleniyor ikonu -->
                        <div id="rota-loader" class="hidden loader mx-auto my-2"></div>
                    </div>
                </div>

                
            </div>

        </main>

        <!-- √ú√ß S√ºtun G√∂rev Takip Alanƒ± -->
        <section class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- G√ºnl√ºk D√ºnyevi -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border border-blue-300">
                <div class="flex items-center justify-between mb-3 bg-gradient-to-r from-blue-100 to-blue-50 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üè°</span>
                        <h2 class="text-2xl font-bold text-blue-700">D√ºnyevi G√∂revler</h2>
                    </div>
                    <span class="text-xs font-semibold text-blue-700 bg-white/70 rounded-full px-2 py-1 shadow-sm">G√ºnl√ºk</span>
                </div>
                <!-- D√ºnyevi Ba≈üarƒ± Havuzu (s√ºtunla hizalƒ±) -->
                <div class="progress-scene mb-3">
                    <div id="daily-dunyevi-carrier-left" class="carrier carrier-left"><span>üßï</span><span class="bucket"></span></div>
                    <div id="daily-dunyevi-carrier-right" class="carrier carrier-right"><span>üßï</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="daily-dunyevi-pool-water" class="pool-water daily"></div>
                        <div class="droplet-container">
                            <span class="droplet green" style="left:10px; animation-delay:0s"></span>
                            <span class="droplet green" style="left:40px; animation-delay:0.4s"></span>
                            <span class="droplet green" style="left:70px; animation-delay:0.8s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="daily-dunyevi-splash-25" class="splash green" style="left:20px"></span>
                            <span id="daily-dunyevi-splash-50" class="splash green" style="left:60px"></span>
                            <span id="daily-dunyevi-splash-75" class="splash green" style="left:100px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-green-900/80">
                        <span id="daily-dunyevi-success-rate">0%</span>
                    </div>
                </div>
                <div id="dunyevi-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-dunyevi-btn" class="text-2xl text-blue-600 hover:scale-110 transition">Ôºã</button>
                    <input type="text" id="add-dunyevi-input" placeholder="Yeni d√ºnyevi g√∂rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <input type="number" id="add-dunyevi-count" min="1" value="1" title="G√ºnde ka√ß kez" class="hidden w-16 ml-2 p-2 border rounded-lg">
                    <button id="add-dunyevi-confirm" class="hidden ml-2 px-3 py-2 bg-blue-600 text-white rounded">Ekle</button>
                </div>
            </div>
            <!-- G√ºnl√ºk ƒ∞lmi -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border border-purple-300">
                <div class="flex items-center justify-between mb-3 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìö</span>
                        <h2 class="text-2xl font-bold text-purple-700">ƒ∞lmi G√∂revler</h2>
                    </div>
                    <span class="text-xs font-semibold text-purple-700 bg-white/70 rounded-full px-2 py-1 shadow-sm">G√ºnl√ºk</span>
                </div>
                <!-- ƒ∞lmi Ba≈üarƒ± Havuzu (s√ºtunla hizalƒ±) -->
                <div class="progress-scene mb-3">
                    <div id="daily-ilmi-carrier-left" class="carrier carrier-left"><span>üßï</span><span class="bucket"></span></div>
                    <div id="daily-ilmi-carrier-right" class="carrier carrier-right"><span>üßï</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="daily-ilmi-pool-water" class="pool-water daily"></div>
                        <div class="droplet-container">
                            <span class="droplet indigo" style="left:10px; animation-delay:0.1s"></span>
                            <span class="droplet indigo" style="left:45px; animation-delay:0.5s"></span>
                            <span class="droplet indigo" style="left:80px; animation-delay:0.9s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="daily-ilmi-splash-25" class="splash indigo" style="left:20px"></span>
                            <span id="daily-ilmi-splash-50" class="splash indigo" style="left:60px"></span>
                            <span id="daily-ilmi-splash-75" class="splash indigo" style="left:100px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-indigo-900/80">
                        <span id="daily-ilmi-success-rate">0%</span>
                    </div>
                </div>
                <div id="ilmi-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-ilmi-btn" class="text-2xl text-purple-600 hover:scale-110 transition">Ôºã</button>
                    <input type="text" id="add-ilmi-input" placeholder="Yeni ilmi g√∂rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <input type="number" id="add-ilmi-count" min="1" value="1" title="G√ºnde ka√ß kez" class="hidden w-16 ml-2 p-2 border rounded-lg">
                    <button id="add-ilmi-confirm" class="hidden ml-2 px-3 py-2 bg-purple-600 text-white rounded">Ekle</button>
                </div>
            </div>
            <!-- Haftalƒ±k -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border-green-300">
                <div class="flex items-center justify-between mb-3 bg-gradient-to-r from-green-100 to-green-50 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üóìÔ∏è</span>
                        <h2 class="text-2xl font-bold text-green-700">Haftalƒ±k G√∂revler</h2>
                    </div>
                    <span class="text-xs font-semibold text-green-700 bg-white/70 rounded-full px-2 py-1 shadow-sm">Haftalƒ±k</span>
                </div>
                <!-- Haftalƒ±k Ba≈üarƒ± Havuzu (s√ºtunla hizalƒ±) -->
                <div class="progress-scene mb-3">
                    <div id="weekly-carrier-left" class="carrier carrier-left"><span>üßï</span><span class="bucket"></span></div>
                    <div id="weekly-carrier-right" class="carrier carrier-right"><span>üßï</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="weekly-pool-water" class="pool-water weekly"></div>
                        <div class="droplet-container">
                            <span class="droplet" style="left:20px; animation-delay:0.2s"></span>
                            <span class="droplet" style="left:60px; animation-delay:0.6s"></span>
                            <span class="droplet" style="left:90px; animation-delay:1s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="weekly-splash-25" class="splash" style="left:25px"></span>
                            <span id="weekly-splash-50" class="splash" style="left:80px"></span>
                            <span id="weekly-splash-75" class="splash" style="left:120px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-blue-900/80">
                        <span id="weekly-success-rate">0%</span>
                    </div>
                </div>
                <div id="haftalik-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-haftalik-btn" class="text-2xl text-green-600 hover:scale-110 transition">Ôºã</button>
                    <input type="text" id="add-haftalik-input" placeholder="Yeni haftalƒ±k g√∂rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-300">
                    <input type="number" id="add-haftalik-count" min="1" value="1" title="Haftada ka√ß kez" class="hidden w-20 ml-2 p-2 border rounded-lg">
                    <button id="add-haftalik-confirm" class="hidden ml-2 px-3 py-2 bg-green-600 text-white rounded">Ekle</button>
                </div>
            </div>
        </section>

        <!-- Celebration Modal -->
        <div id="celebrate-backdrop" class="celebrate-backdrop">
            <div class="celebrate-modal">
                <div class="celebrate-header">
                    <span>Tebrikler! G√ºn√ºn T√ºm G√∂revleri Tamamlandƒ± üéâ</span>
                    <button id="celebrate-close" class="celebrate-close">‚úï</button>
                </div>
                <div class="celebrate-body">
                    <div id="celebrate-message" class="celebrate-message">
                        <div class="aura" id="celebrate-aura"></div>
                        <div id="celebrate-text"></div>
                        <div id="celebrate-source" class="celebrate-source"></div>
                    </div>
                    <div class="candles">
                        <div class="candle"></div>
                        <div class="candle"></div>
                        <div class="candle"></div>
                    </div>
                    <canvas id="confetti"></canvas>
                    <div class="fireworks" id="fireworks"></div>
                </div>
            </div>
        </div>

        <!-- G√∂rsel ayƒ±rƒ±cƒ± -->
        <hr class="mt-8 border-gray-300">
        <!-- Alt ikili b√∂l√ºm: N√∂bet ve G√ºn√ºn S√∂z√º yan yana -->
        <section id="bottom-duo" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></section>

        <!-- Alt B√∂l√ºm -->
        <footer class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- G√ºn√ºn S√∂z√º (ƒ∞stek 7) - YER DEƒûƒ∞≈ûTƒ∞RDƒ∞ (ƒ∞stek 1) -->
            <div id="quote-box" class="glass-bg task-box rounded-xl shadow-lg p-6 min-h-[150px] flex flex-col justify-center space-y-4">
                <!-- Ayet -->
                <div class="text-center">
                    <p id="quote-ayet" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-ayet-source" class="text-md font-semibold text-pink-500 mt-1">‚Äî ...</p>
                </div>
                <hr class="border-pink-200">
                <!-- Hadis -->
                <div class="text-center">
                    <p id="quote-hadis" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-hadis-source" class="text-md font-semibold text-blue-500 mt-1">‚Äî ...</p>
                </div>
                <hr class="border-blue-200">
                <!-- G√ºzel S√∂z -->
                <div class="text-center">
                    <p id="quote-soz" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-soz-source" class="text-md font-semibold text-purple-500 mt-1">‚Äî ...</p>
                </div>
            </div>

            <!-- Arka Plan Galerisi (ƒ∞stek 16) - YER DEƒûƒ∞≈ûTƒ∞RDƒ∞ (ƒ∞stek 1) -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-3 text-pink-600">Arka Plan Galerisi</h3>
                
                <!-- YENƒ∞: Yerel Dosya Y√ºkleme Kƒ±smƒ± -->
                <div class="mb-4 p-3 bg-pink-50 rounded-lg border border-pink-100">
                    <h4 class="font-semibold text-pink-600 mb-2">Bilgisayardan Arka Plan Se√ß</h4>
                    <input type="file" id="local-bg-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-200 file:text-pink-800 hover:file:bg-pink-300">
                    <button id="upload-bg-btn" class="w-full mt-3 bg-purple-400 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        Arka Planƒ± Y√ºkle ve Kaydet
                    </button>
                    <p id="upload-status" class="text-xs text-gray-500 mt-2 hidden">Y√ºkleniyor...</p>
                </div>

                <p class="text-sm text-gray-600 mb-2">Veya hazƒ±r (stabil) temalardan birini se√ßin:</p>
                
                <!-- Statik arka plan se√ßici galeri -->
                <div id="bg-results-grid" class="grid grid-cols-3 gap-2 h-64 overflow-y-auto pr-2">
                    <!-- Arka planlar buraya JavaScript ile y√ºklenecek -->
                </div>
            </div>
            
            <!-- Ayarlar (AI/N√∂bet) - YER DEƒûƒ∞≈ûTƒ∞RDƒ∞ (ƒ∞stek 1) -->
            <div class="glass-bg pool-box rounded-xl shadow-lg p-4">
                <h2 class="text-2xl font-bold text-gray-700 mb-3">Ayarlar (AI/N√∂bet)</h2>
                <div class="space-y-3">
                    <div>
                        <label for="api-key-input" class="text-sm font-medium text-gray-600">Google AI API Anahtarƒ±</label>
                        <input type="password" id="api-key-input" placeholder="API Anahtarƒ±nƒ±zƒ± buraya yapƒ±≈ütƒ±rƒ±n..." class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button id="api-key-save-btn" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Anahtarƒ± Kaydet
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 italic">API Anahtarƒ±, n√∂bet listesi okuma i√ßin gereklidir.</p>
                </div>

                <!-- YENƒ∞: Veri Yedekleme B√∂l√ºm√º -->
                <hr class="my-4 border-pink-200">
                <div>
                    <h4 class="text-sm font-medium text-gray-600 mb-2">Veri Yedekleme</h4>
                    <p class="text-xs text-gray-500 italic mb-2">T√ºm g√∂revlerinizi ve ayarlarƒ±nƒ±zƒ± bir dosyaya yedekleyin veya yedeƒüi geri y√ºkleyin.</p>
                    <div class="flex gap-2">
                        <button id="export-data-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri Dƒ±≈üa Aktar (Yedekle)
                        </button>
                        <button id="import-data-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri ƒ∞√ße Aktar (Geri Y√ºkle)
                        </button>
                    </div>
                    <!-- ƒ∞√ße aktarma i√ßin gizli dosya giri≈üi -->
                    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt">
                </div>
                <!-- / Veri Yedekleme B√∂l√ºm√º -->

            </div>


        </footer>
    </div>
    
    <!-- Modal (Mesajlar i√ßin) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="modal-close-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-6 rounded-lg">Kapat</button>
        </div>
    </div>
    
    <!-- G√∂rev Havuzu Modal -->
    <div id="pool-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-pink-600">G√∂rev Havuzu</h3>
                <button id="pool-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="flex border-b border-gray-300 mb-4">
                <button class="pool-tab-btn active-tab py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600" data-pool-tab="modal-dunyevi-pool">D√ºnyevi</button>
                <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="modal-ilmi-pool">ƒ∞lmi</button>
                <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="modal-haftalik-pool">Haftalƒ±k</button>
            </div>
            <div id="modal-dunyevi-pool" class="pool-tab-content space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div id="modal-ilmi-pool" class="pool-tab-content hidden space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div id="modal-haftalik-pool" class="pool-tab-content hidden space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>
    
    <!-- Ge√ßmi≈ü G√ºnler Modal (ƒ∞stek 9) -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full h-[70vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-pink-600">Ge√ßmi≈ü G√ºnler</h3>
                <button id="history-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="history-list" class="space-y-2 overflow-y-auto h-[calc(70vh-100px)] pr-2">
                <p class="text-gray-500">Y√ºklenecek ge√ßmi≈ü g√ºn kaydƒ± bulunamadƒ±.</p>
            </div>
        </div>
    </div>


    <!-- Firebase SDK (Gerekli) -->
    <script type="module">
        // --- GLOBAL DEƒûƒ∞≈ûKENLER VE SABƒ∞TLER ---
        
        // Local tarih anahtarƒ± (YYYY-MM-DD) - zaman dilimi hatalarƒ±nƒ± √∂nlemek i√ßin toISOString kullanmƒ±yoruz
        function formatDateKey(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let currentDayStr = formatDateKey(new Date());
        let currentWeekStr = getWeekId(new Date());
        // Aktif d√ºzenlenen tarih (varsayƒ±lan: bug√ºn). Kullanƒ±cƒ± √∂nceki g√ºnlere gezinebilir.
        let activeDateStr = currentDayStr;
        // Ka√ß g√ºne kadar geriye d√ºzenleme izni var
        const EDITABLE_DAYS = Infinity; // Ge√ßmi≈üe sƒ±nƒ±rsƒ±z d√ºzenleme izni

        // Yerel Depolama i√ßin anahtar √∂neki
        const LS_PREFIX = 'YSZ_';
        
        // YENƒ∞: N√∂bet Takibi DOM referanslarƒ± (Mod√ºl Kapsamƒ±nda Tanƒ±mlandƒ±)
        let rotaLoader = null; 
        let rotaOutput = null;
        
        // YENƒ∞: Chart.js i√ßin global deƒüi≈ükenler (√ßift render'ƒ± √∂nlemek i√ßin)
        let dailyChartInstance = null;
        let weeklyChartInstance = null;

        // G√úNCELLENDƒ∞: Statik √ái√ßek Arka Planlarƒ± (Daha stabil, non-Unsplash placeholderlar)
        const FLOWER_BACKGROUND_PRESETS = [
            { url: 'https://placehold.co/800x450/f9a8d4/ffffff?text=1.+Pastel+Laleler', style: 'Pastel Pembe Laleler' },
            { url: 'https://placehold.co/800x450/a5b4fc/ffffff?text=2.+Sulu+Boya+G√ºller', style: 'Soyut Sulu Boya G√ºller (√áizim)' },
            { url: 'https://placehold.co/800x450/ef4444/ffffff?text=3.+Ger√ßek√ßi+G√ºller', style: 'Ger√ßek√ßi Kƒ±rmƒ±zƒ± G√ºller' },
            { url: 'https://placehold.co/800x450/c4b5fd/ffffff?text=4.+Mor+Pembe+Desen', style: 'Yumu≈üak Pembe/Mor √ái√ßek Desen' },
            { url: 'https://placehold.co/800x450/4ade80/ffffff?text=5.+Canlƒ±+Bahar+√ái√ßekleri', style: 'Canlƒ± Karƒ±≈üƒ±k Bahar √ái√ßekleri' }
            // Kendi Base64 resimlerinizi buraya ekleyebilirsiniz: 
            // { url: 'data:image/jpeg;base64,.....KENDƒ∞ BASE64 VERƒ∞Nƒ∞Z.....', style: 'Kendi Resminiz' }
        ];

        // Varsayƒ±lan arka plan (ilk a√ßƒ±lƒ±≈üta kullanƒ±lƒ±r)
        const DEFAULT_FALLBACK_BG = FLOWER_BACKGROUND_PRESETS[0].url;

        // YENƒ∞: G√ºnl√ºk S√∂zler Veri Listesi (Eksikti, Hata D√ºzeltmesi)
        const GUNLUK_SOZLER = [
            {
                ayet: { text: "≈û√ºphesiz, Allah sabredenlerle beraberdir.", source: "Bakara, 153" },
                hadis: { text: "Kolayla≈ütƒ±rƒ±nƒ±z, zorla≈ütƒ±rmayƒ±nƒ±z; m√ºjdeleyiniz, nefret ettirmeyiniz.", source: "Buh√¢r√Æ, ƒ∞lim, 11" },
                soz: { text: "ƒ∞ki g√ºn√º bir olan ziyandadƒ±r.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "Sizin en hayƒ±rlƒ±nƒ±z, Kur'an'ƒ± √∂ƒürenen ve √∂ƒüretendir.", source: "Tirmiz√Æ, Fed√¢il√º'l-Kur'an, 15" },
                hadis: { text: "ƒ∞lim √∂ƒürenmek, her M√ºsl√ºmana farzdƒ±r.", source: "ƒ∞bn M√¢ce, Mukaddime, 17" },
                soz: { text: "Bana bir harf √∂ƒüretenin kƒ±rk yƒ±l k√∂lesi olurum.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "Hi√ß bilenlerle bilmeyenler bir olur mu?", source: "Z√ºmer, 9" },
                hadis: { text: "Allah kimin i√ßin hayƒ±r dilerse, onu dinde f√¢kih (derin anlayƒ±≈ü sahibi) kƒ±lar.", source: "Buh√¢r√Æ, ƒ∞lim, 13" },
                soz: { text: "Okumak, gƒ±dadƒ±r; okuyan insan, acƒ±kmaz.", source: "Cemil Meri√ß" }
            },
            {
                ayet: { text: "Rabbim, ilmimi artƒ±r de.", source: "T√¢h√¢, 114" },
                hadis: { text: "Be≈üikten mezara kadar ilim √∂ƒüreniniz.", source: "Had√Æs-i ≈ûer√Æf" },
                soz: { text: "En b√ºy√ºk sava≈ü, insanƒ±n kendi nefsiyle yaptƒ±ƒüƒ± sava≈ütanƒ±r.", source: "Hz. Muhammed (s.a.v.)" }
            },
            {
                ayet: { text: "O, (gece) karanlƒ±ƒüƒ± yarƒ±p sabahƒ± √ßƒ±karandƒ±r.", source: "En'√¢m, 96" },
                hadis: { text: "G√ºzel s√∂z sadakadƒ±r.", source: "M√ºslim, Zek√¢t, 56" },
                soz: { text: "Hayat, iman ve cihattƒ±r.", source: "Hz. H√ºseyin (r.a.)" }
            },
            {
                ayet: { text: "Allah, bir kimseyi ancak g√ºc√ºn√ºn yettiƒüi ≈üeyle y√ºk√ºml√º kƒ±lar.", source: "Bakara, 286" },
                hadis: { text: "Ameller niyetlere g√∂redir.", source: "Buh√¢r√Æ, Bed‚Äô√º‚Äôl-vahy, 1" },
                soz: { text: "Sabƒ±r, ba≈üarƒ±nƒ±n anahtarƒ±dƒ±r.", source: "Mevl√¢n√¢" }
            }
        ];

        // DOM Element Referanslarƒ±
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Tarihe g√ºn ekleyip ISO yyyy-mm-dd formatƒ±nda d√∂nd√ºr√ºr
        function addDays(dateStr, delta) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + delta);
            return formatDateKey(d);
        }

        // Yardƒ±mcƒ±: iki tarih arasƒ±ndaki g√ºn farkƒ±nƒ± (bug√ºn - target) olarak d√∂nd√ºr√ºr (tam sayƒ±ya yuvarlanmƒ±≈ü)
        function daysDifferenceFromToday(targetDateStr) {
            const msPerDay = 24 * 60 * 60 * 1000;
            const today = new Date(currentDayStr + 'T00:00:00');
            const target = new Date(targetDateStr + 'T00:00:00');
            return Math.round((today - target) / msPerDay);
        }

        function formatLongDate(dateStr) {
            try {
                return new Date(dateStr + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function isActiveDateEditable() {
            const diff = daysDifferenceFromToday(activeDateStr);
            return diff >= 0; // Ge√ßmi≈ü tarihler d√ºzenlenebilir, gelecek deƒüil
        }

        function updateDateDisplay() {
            // B√ºy√ºk tarih ba≈ülƒ±ƒüƒ± (sabit olarak bug√ºn√ºn uzun g√∂sterimi)
            $("#current-date").textContent = new Date(currentDayStr + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const label = $("#active-date-label");
            if (!label) return;
            if (activeDateStr === currentDayStr) {
                label.textContent = `Bug√ºn ‚Äî ${formatLongDate(activeDateStr)}`;
            } else {
                const editable = isActiveDateEditable();
                label.textContent = `${formatLongDate(activeDateStr)} ${editable ? '(D√ºzenlenebilir)' : '(Gelecek - Salt okunur)'} `;
            }

            // Form kontrollerini aktive/pasif yap
            const addBtn = $("#add-task-btn");
            const newTitle = $("#new-task-title");
            const newType = $("#new-task-type");
            const newFreq = $("#new-task-frequency");
            if (addBtn) addBtn.disabled = !isActiveDateEditable();
            if (newTitle) newTitle.disabled = !isActiveDateEditable();
            if (newType) newType.disabled = !isActiveDateEditable();
            if (newFreq) newFreq.disabled = !isActiveDateEditable();
        }

        function setActiveDate(dateStr) {
            // Tarihi sƒ±nƒ±rla: ileri gidemeziz (gelecek), geri ise sadece mantƒ±ksal limit g√∂sterilir
            const today = new Date(currentDayStr + 'T00:00:00');
            const candidate = new Date(dateStr + 'T00:00:00');
            if (candidate > today) {
                activeDateStr = currentDayStr;
            } else {
                activeDateStr = dateStr;
            }
            updateDateDisplay();
            loadDailyTasks();
        }

        // --- YEREL DEPOLAMA YARDIMCILARI ---

        /**
         * Yerel depolamadan veri okur (JSON.parse yapar)
         */
        function lsGet(key, defaultValue = null) {
            const value = localStorage.getItem(LS_PREFIX + key);
            if (value === null || value === undefined) {
                return defaultValue;
            }
            try {
                return JSON.parse(value);
            } catch (e) {
                console.error("Yerel depolama okuma hatasƒ± (JSON parse):", e);
                return defaultValue;
            }
        }

        /**
         * Yerel depolamaya veri yazar (JSON.stringify yapar)
         */
        function lsSet(key, value) {
            try {
                localStorage.setItem(LS_PREFIX + key, JSON.stringify(value));
            } catch (e) {
                console.error("Yerel depolama yazma hatasƒ±:", e);
                showMessage("Veri Kayƒ±t Hatasƒ±", "Verileriniz kaydedilemedi. Tarayƒ±cƒ±nƒ±za yer kalmamƒ±≈ü olabilir.");
            }
        }

        // --- UYGULAMA BA≈ûLANGI√á ---

        try {
            console.log("Uygulama ba≈ülƒ±yor (Yerel Depolama).");
            initializeApp(); // Direkt uygulamayƒ± ba≈ülat
        } catch (error) {
            console.error("Uygulama ba≈ülatƒ±lamadƒ±:", error); // Hata mesajƒ± d√ºzeltildi
            showMessage("Hata", "Uygulama ba≈ülatƒ±lamadƒ±. L√ºtfen sayfayƒ± yenileyin.");
        }

        async function initializeApp() {
            try {
                await checkDayChange(); // G√ºn√º kontrol et ve gerekirse verileri ta≈üƒ±
                loadStaticData(); // Statik verileri (n√∂bet, s√∂z, arka plan) y√ºkle
                loadAllDataAndSetupListeners(); // Veri dinleyicilerini ba≈ülat

            } catch (error) {
                console.error("Ba≈ülatma hatasƒ±:", error);
                showMessage("Ba≈ülatma Hatasƒ±", "Uygulama verileri y√ºklenirken bir hata olu≈ütu.");
            }
        }
        
        // G√úN VE HAFTA DEƒûƒ∞≈ûƒ∞Mƒ∞ FONKSƒ∞YONLARI BURADA KALDI (Hata D√ºzeltmeleri Yapƒ±lmƒ±≈ütƒ±)

        /**
         * G√∂revler, havuzlar vb. i√ßin t√ºm veri y√ºkleyicilerini ba≈ülatƒ±r (Yerel Depolama).
         */
        function loadAllDataAndSetupListeners() {
            loadDailyTasks();
            loadWeeklyTasks();
            loadPools();
            loadStats(); // G√úNCELLENDƒ∞: Artƒ±k grafikleri de √ßizecek
            loadSettings(); // YENƒ∞: Ayarlarƒ± y√ºkle

            // Event Listeners (UI)
            setupEventListeners();

            // N√∂bet ve G√ºn√ºn S√∂z√º kartlarƒ±nƒ± alt ikili b√∂l√ºme ta≈üƒ±
            try {
                const duo = document.getElementById('bottom-duo');
                const rotaCard = document.getElementById('rota-card');
                const quoteCard = document.getElementById('quote-box');
                if (duo && rotaCard && quoteCard) {
                    duo.appendChild(rotaCard);
                    duo.appendChild(quoteCard);
                }
            } catch (e) { console.warn('Alt ikili b√∂l√ºme ta≈üƒ±ma ba≈üarƒ±sƒ±z:', e); }

            // Eski havuz ve sekmeli g√∂rev kutularƒ±nƒ± gizle (temiz aray√ºz i√ßin)
            try {
                // Eski sekmeli g√∂rev kutusu: tab-btn i√ßerir
                const oldTabsBox = Array.from(document.querySelectorAll('.task-box')).find(box => box.querySelector('.tab-btn'));
                if (oldTabsBox) oldTabsBox.classList.add('hidden');

                // Eski havuz kutusu: pool-tab-btn i√ßerir
                const oldPoolBox = Array.from(document.querySelectorAll('.pool-box')).find(box => box.querySelector('.pool-tab-btn'));
                if (oldPoolBox) oldPoolBox.classList.add('hidden');
            } catch (e) { console.warn('Eski UI gizleme ba≈üarƒ±sƒ±z:', e); }
        }

        // Ba≈ülangƒ±√ßta aktif tarihi ayarla (UI ba≈ülatma)
        setActiveDate(currentDayStr);

        /**
         * G√ºn deƒüi≈üip deƒüi≈ümediƒüini kontrol eder. Deƒüi≈ütiyse, d√ºnk√º g√∂revleri
         * 'history' koleksiyonuna ta≈üƒ±r ve varsayƒ±lanlarƒ± yeni g√ºne ekler. (ƒ∞stek 9)
         */
        async function checkDayChange() {
            try {
                const lastLoginInfo = lsGet('metadata_lastLogin', { date: null, week: null });
                const lastLoginDate = lastLoginInfo.date;

                if (lastLoginDate && lastLoginDate !== currentDayStr) {
                    console.log(`G√ºn deƒüi≈üti. Eski g√ºn: ${lastLoginDate}, Yeni g√ºn: ${currentDayStr}`);
                    await archiveTasks(lastLoginDate); // D√ºnk√º g√∂revleri ar≈üivle (G√úNCELLENDƒ∞: artƒ±k istatistik de kaydeder)
                    await addDefaultTasksForNewDay(); // Yeni g√ºn i√ßin varsayƒ±lanlarƒ± ekle
                } else if (!lastLoginDate) {
                    console.log("ƒ∞lk giri≈ü, varsayƒ±lan g√∂revler ekleniyor.");
                    await addDefaultTasksForNewDay(); // ƒ∞lk giri≈üse de varsayƒ±lanlarƒ± ekle
                } else {
                    console.log("Aynƒ± g√ºn giri≈üi.");
                }

                const lastLoginWeek = lastLoginInfo.week;
                if(lastLoginWeek !== currentWeekStr) {
                    console.log(`Hafta deƒüi≈üti. Eski hafta: ${lastLoginWeek}, Yeni hafta: ${currentWeekStr}`);
                    await resetWeeklyTasks(lastLoginWeek); // G√úNCELLENDƒ∞: Artƒ±k eski haftayƒ± parametre olarak alƒ±r
                }
                
                lsSet('metadata_lastLogin', { date: currentDayStr, week: currentWeekStr });

                // G√ºncelle: tarih g√∂sterimini yenile
                updateDateDisplay();

            } catch (error) {
                console.error("G√ºn deƒüi≈ütirme kontrol hatasƒ±:", error);
            }
        }

        /**
         * YENƒ∞: G√ºnl√ºk g√∂revleri ge√ßmi≈üe ar≈üivler (Hata 1'i d√ºzeltir)
         * G√úNCELLENDƒ∞: Artƒ±k g√ºnl√ºk istatistikleri de kaydeder.
         */
        async function archiveTasks(dateToArchive) {
            console.log(`G√∂revler ar≈üivleniyor: ${dateToArchive}`);
            const dailyTasksKey = `tasks_daily_${dateToArchive}`;
            const tasks = lsGet(dailyTasksKey, []);
            
            if (tasks.length > 0) {
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // G√úNCELLENDƒ∞: Yeni stats yapƒ±sƒ±
                const allStats = lsGet('stats', { daily: {}, weekly: {} }); 
                allStats.daily[dateToArchive] = { success: successRate }; // 'daily' anahtarƒ± altƒ±na kaydet
                lsSet('stats', allStats);
                
                const allHistory = lsGet('history', {});
                allHistory[dateToArchive] = tasks;
                lsSet('history', allHistory);
            }
            localStorage.removeItem(LS_PREFIX + dailyTasksKey);
        }
        
        /**
         * YENƒ∞: Yeni g√ºn i√ßin varsayƒ±lan g√∂revleri ekler (Hata 1'i d√ºzeltir)
         */
        async function addDefaultTasksForNewDay() {
            console.log("Yeni g√ºn i√ßin varsayƒ±lan g√∂revler ekleniyor...");
            
            const dunyeviPool = lsGet('pools_dunyevi', []);
            const ilmiPool = lsGet('pools_ilmi', []);
            
            const defaultDunyevi = dunyeviPool.filter(t => t.isDefault).map(t => ({...t, type: 'dunyevi', status: 0}));
            const defaultIlmi = ilmiPool.filter(t => t.isDefault).map(t => ({...t, type: 'ilmi', status: 0}));
            
            const dailyKey = `tasks_daily_${currentDayStr}`;
            const dailyTasks = lsGet(dailyKey, []);
            
            const allDefaults = [...defaultDunyevi, ...defaultIlmi];
            allDefaults.forEach(defaultTask => {
                const exists = dailyTasks.some(t => t.title === defaultTask.title);
                if (!exists) {
                    dailyTasks.push({
                        id: Date.now().toString() + Math.random(), // Benzersiz ID
                        title: defaultTask.title,
                        type: defaultTask.type,
                        status: 0
                    });
                }
            });
            
            lsSet(dailyKey, dailyTasks);
            loadDailyTasks(); // UI'ƒ± yenile
        }
        
        /**
         * YENƒ∞: Yeni hafta i√ßin haftalƒ±k g√∂revleri sƒ±fƒ±rlar (tamamlanma durumlarƒ±nƒ±)
         * G√úNCELLENDƒ∞: Eski haftanƒ±n istatistiƒüini kaydeder.
         */
        async function resetWeeklyTasks(lastLoginWeek) {
            console.log("Haftalƒ±k g√∂revler sƒ±fƒ±rlanƒ±yor...");

            // YENƒ∞: Sƒ±fƒ±rlamadan √ñNCE, eski haftanƒ±n ba≈üarƒ±sƒ±nƒ± kaydet
            if (lastLoginWeek && lastLoginWeek !== currentWeekStr) {
                const oldWeeklyTasks = lsGet(`tasks_weekly_${lastLoginWeek}`, []);
                if (oldWeeklyTasks.length > 0) {
                    const finalWeeklySuccess = calculateWeeklySuccess(oldWeeklyTasks); // UI'ƒ± g√ºncelleme
                    
                    const allStats = lsGet('stats', { daily: {}, weekly: {} });
                    allStats.weekly[lastLoginWeek] = { success: finalWeeklySuccess };
                    lsSet('stats', allStats);
                    console.log(`Haftalƒ±k ba≈üarƒ± (${lastLoginWeek}) kaydedildi: ${finalWeeklySuccess}%`);
                    
                    // Eski haftanƒ±n g√∂revlerini sil (isteƒüe baƒülƒ±, ama yerel depolamayƒ± temiz tutar)
                    localStorage.removeItem(LS_PREFIX + `tasks_weekly_${lastLoginWeek}`);
                }
            }
            
            // Yeni hafta i√ßin varsayƒ±lanlarƒ± y√ºkle
            const weeklyKey = `tasks_weekly_${currentWeekStr}`;
            const weeklyPool = lsGet('pools_haftalik', []);
            
            const defaultWeekly = weeklyPool
                .filter(t => t.isDefault)
                .map(t => ({
                    id: Date.now().toString() + Math.random(),
                    title: t.title,
                    frequency: t.frequency || 1,
                    completed: 0
                }));
            
            lsSet(weeklyKey, defaultWeekly);
            loadWeeklyTasks(); // UI'ƒ± yenile
        }


        // --- YEREL DEPOLAMADAN Y√úKLEME FONKSƒ∞YONLARI ---
        function loadDailyTasks() {
            // Aktif tarihe g√∂re y√ºkle. Eƒüer aktif tarih i√ßin canlƒ± g√ºnl√ºk kayƒ±t yoksa, ar≈üivden oku (salt okunur).
            let tasks = lsGet(`tasks_daily_${activeDateStr}`, []);
            let readOnly = false;
            if (!tasks || tasks.length === 0) {
                const history = lsGet('history', {});
                if (history && history[activeDateStr]) {
                    tasks = history[activeDateStr];
                    // Ge√ßmi≈ü g√ºnler artƒ±k d√ºzenlenebilir, sadece gelecek g√ºnler salt okunur
                    readOnly = !isActiveDateEditable();
                }
            }
            tasks = tasks || [];
            const dunyevi = tasks.filter(t => t.type === 'dunyevi');
            const ilmi = tasks.filter(t => t.type === 'ilmi');
            renderDailyTasks(dunyevi, ilmi, readOnly);
            calculateSuccess(); // G√ºnl√ºk ba≈üarƒ±yƒ± hesapla/g√ºncelle
        }

        function loadWeeklyTasks() {
            const tasks = lsGet(`tasks_weekly_${currentWeekStr}`, []);
            renderWeeklyTasks(tasks);
            calculateWeeklySuccess(); // YENƒ∞: Haftalƒ±k ba≈üarƒ±yƒ± hesapla/g√ºncelle
        }

        function loadPools() {
            const dun = lsGet('pools_dunyevi', []);
            const ilm = lsGet('pools_ilmi', []);
            const haf = lsGet('pools_haftalik', []);
            // Render only modal pools (yeni aray√ºz)
            renderPool(dun, 'modal-dunyevi-pool');
            renderPool(ilm, 'modal-ilmi-pool');
            renderPool(haf, 'modal-haftalik-pool');
        }

        function loadStats() {
            // G√úNCELLENDƒ∞: Yeni stats yapƒ±sƒ±
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const dailyStats = allStats.daily || {};
            const weeklyStats = allStats.weekly || {};
            
            renderStats(dailyStats, weeklyStats); // renderStats'ƒ± yeni verilerle √ßaƒüƒ±r
        }

        function loadSettings() {
            const apiKey = lsGet('settings_apiKey', '');
            $('#api-key-input').value = apiKey;
            
            const rotaName = lsGet('settings_rotaName', 'Ali Murtaza Ko√ßak'); // Varsayƒ±lan isim
            $('#rota-name-input').value = rotaName;
        }

        /**
         * N√∂bet bilgisi, g√ºn√ºn s√∂z√º, arka plan gibi statik verileri y√ºkler
         */
        async function loadStaticData() {
            // G√ºn√ºn S√∂z√º (ƒ∞stek 7)
            setDailyQuote();
            // Varsayƒ±lan Arka Plan (ƒ∞stek 10)
            setDailyBackground(); 
            
            // YENƒ∞: Arka plan se√ßici galeriyi √ßiz (Statik √ái√ßekler)
            renderStaticBackgrounds();
            
            // YENƒ∞: Global DOM referanslarƒ±nƒ± kaydet
            rotaLoader = $("#rota-loader"); 
            rotaOutput = $("#rota-output");

            // Kayƒ±tlƒ± N√∂bet Bilgisi (ƒ∞stek 8)
            try {
                const rotaInfo = lsGet('metadata_rotaInfo');
                // DOM elemanlarƒ±nƒ±n varlƒ±ƒüƒ±nƒ± kontrol etmeye gerek yok, √ß√ºnk√º processRota i√ßinde kontrol edilecek.
                if (rotaOutput && rotaInfo && rotaInfo.text) {
                     rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${rotaInfo.text}</pre>`;
                }
            } catch (error) {
                console.error("Kayƒ±tlƒ± n√∂bet bilgisi y√ºklenemedi:", error);
            }
        }
        
        // --- RENDER (G√ñR√úN√úM) FONKSƒ∞YONLARI ---

        function renderDailyTasks(dunyevi, ilmi, readOnly = false) {
            const dunyeviContainer = document.querySelector("#dunyevi-tasks-col") || $("#dunyevi-tasks");
            const ilmiContainer = document.querySelector("#ilmi-tasks-col") || $("#ilmi-tasks");
            
            dunyeviContainer.innerHTML = dunyevi.length ? '' : '<p class="text-gray-400 italic">D√ºnyevi g√∂rev yok.</p>';
            ilmiContainer.innerHTML = ilmi.length ? '' : '<p class="text-gray-400 italic">ƒ∞lmi g√∂rev yok.</p>';

            dunyevi.forEach(task => dunyeviContainer.appendChild(createTaskElement(task, 'daily', readOnly)));
            ilmi.forEach(task => ilmiContainer.appendChild(createTaskElement(task, 'daily', readOnly)));
        }

        function renderWeeklyTasks(tasks) {
            const container = document.querySelector("#haftalik-tasks-col") || $("#haftalik-tasks");
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic">Haftalƒ±k g√∂rev yok.</p>';
            tasks.forEach(task => container.appendChild(createTaskElement(task, 'weekly')));
        }
        
        function renderPool(tasks, containerId) {
            const container = $(`#${containerId}`);
            if (!container) {
                console.error(`Havuz konteyneri bulunamadƒ±: #${containerId}`);
                return;
            }
            
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic text-sm">Bu havuzda g√∂rev yok.</p>';
            tasks.forEach(task => {
                const el = document.createElement('div');
                el.className = 'pool-item bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';
                el.dataset.id = task.id;
                el.dataset.title = task.title;
                
                const hasSubtasks = Array.isArray(task.subtasks) && task.subtasks.length > 0;
                const subtasksPreview = hasSubtasks
                    ? `<div class="mt-1 text-xs text-gray-500 leading-snug">‚Ä¢ ${task.subtasks.map(st => st.title).join(' ‚Ä¢ ')}</div>`
                    : '';

                el.innerHTML = `
                    <div class="flex-grow">
                        <span class="text-gray-700">${task.title}</span>
                        ${subtasksPreview}
                    </div>
                    <button class="toggle-default-btn text-lg ${task.isDefault ? 'text-yellow-500' : 'text-gray-300'}" title="Varsayƒ±lan olarak ayarla">
                        ${task.isDefault ? '‚òÖ' : '‚òÜ'}
                    </button>
                    <button class="delete-pool-btn text-red-400 hover:text-red-600 ml-2" title="Havuzdan sil">
                        &times;
                    </button>
                `;
                
                el.querySelector('span').onclick = () => handlePoolClick(task, containerId);
                el.querySelector('.toggle-default-btn').onclick = (e) => {
                    e.stopPropagation();
                    toggleTaskDefault(task.id, poolTypeFromContainer(containerId));
                };
                el.querySelector('.delete-pool-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteFromPool(task.id, poolTypeFromContainer(containerId));
                };
                
                container.appendChild(el);
            });
        }
        
        /**
         * G√úNCELLENDƒ∞: Artƒ±k Chart.js kullanarak grafikleri √ßizer
         */
        function renderStats(dailyStats, weeklyStats) {
            const dailyContainer = $("#daily-chart-tab");
            const weeklyContainer = $("#weekly-chart-tab");
            const noStatsMsg = $("#no-stats-message");

            if (!dailyContainer || !weeklyContainer || !noStatsMsg) {
                console.error("ƒ∞statistik canvas konteynerlarƒ± bulunamadƒ±.");
                return;
            }
            
            // √ñnceki chart'larƒ± yok et (varsa)
            if (dailyChartInstance) dailyChartInstance.destroy();
            if (weeklyChartInstance) weeklyChartInstance.destroy();

            const dailyEntries = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0])); // Tarihe g√∂re sƒ±rala
            const weeklyEntries = Object.entries(weeklyStats).sort((a, b) => a[0].localeCompare(b[0])); // Haftaya g√∂re sƒ±rala

            if (dailyEntries.length === 0 && weeklyEntries.length === 0) {
                noStatsMsg.classList.remove('hidden');
                dailyContainer.classList.add('hidden');
                weeklyContainer.classList.add('hidden');
                return;
            }
            
            noStatsMsg.classList.add('hidden');

            // --- G√ºnl√ºk Grafik ---
            if (dailyEntries.length > 0) {
                // Konteynerin i√ßini temizle (canvas'ƒ± yeniden olu≈ütur)
                dailyContainer.innerHTML = '<canvas id="daily-stats-chart"></canvas>';
                const dailyCtx = $('#daily-stats-chart').getContext('2d');
                
                const dailyLabels = dailyEntries.map(entry => {
                    const [date] = entry;
                    return new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                });
                const dailyData = dailyEntries.map(entry => entry[1].success);

                dailyChartInstance = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'G√ºnl√ºk Ba≈üarƒ± %',
                            data: dailyData,
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3 // Eƒüri i√ßin
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 dailyContainer.innerHTML = '<p class="text-gray-500 p-4">G√∂sterilecek g√ºnl√ºk istatistik verisi yok.</p>';
            }

            // --- Haftalƒ±k Grafik ---
            if (weeklyEntries.length > 0) {
                // Konteynerin i√ßini temizle (canvas'ƒ± yeniden olu≈ütur)
                weeklyContainer.innerHTML = '<canvas id="weekly-stats-chart"></canvas>';
                const weeklyCtx = $('#weekly-stats-chart').getContext('2d');
                
                const weeklyLabels = weeklyEntries.map(entry => entry[0]); // √ñrn: "2025-W45"
                const weeklyData = weeklyEntries.map(entry => entry[1].success);

                weeklyChartInstance = new Chart(weeklyCtx, {
                    type: 'line',
                    data: {
                        labels: weeklyLabels,
                        datasets: [{
                            label: 'Haftalƒ±k Ba≈üarƒ± %',
                            data: weeklyData,
                            borderColor: 'rgb(217, 70, 239)', // fuchsia-500
                            backgroundColor: 'rgba(217, 70, 239, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 weeklyContainer.innerHTML = '<p class="text-gray-500 p-4">G√∂sterilecek haftalƒ±k istatistik verisi yok.</p>';
            }
            
             // Grafikleri ilk y√ºklemede doƒüru sekmede g√∂ster
            $('#daily-chart-tab').classList.remove('hidden');
            $('#weekly-chart-tab').classList.add('hidden');
        }


        function createTaskElement(task, taskListType, readOnly = false) {
            const el = document.createElement('div');
            el.className = 'task-item bg-white p-4 rounded-lg shadow-md flex flex-col space-y-2';
            el.dataset.id = task.id;

            if (taskListType === 'daily') {
                // Ana g√∂rev ba≈ülƒ±ƒüƒ± satƒ±rƒ±
                const headerRow = document.createElement('div');
                headerRow.className = 'flex items-center space-x-4';
                
                if (readOnly) {
                    headerRow.innerHTML = `
                        <span class="status-btn status-${task.status}" data-status="${task.status}" title="Durumu (salt okunur)"></span>
                        <span class="flex-grow text-gray-800">${task.title}</span>
                    `;
                } else {
                    headerRow.innerHTML = `
                        <span class="status-btn status-${task.status}" data-status="${task.status}" title="Durumu deƒüi≈ütir"></span>
                        <span class="flex-grow text-gray-800">${task.title}</span>
                        <button class="edit-task-btn text-blue-400 hover:text-blue-600 text-lg" title="G√∂revi d√ºzenle">‚úé</button>
                        <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl" title="G√∂revi sil">&times;</button>
                    `;
                    headerRow.querySelector('.status-btn').onclick = () => updateTaskStatus(task.id, task.status);
                    headerRow.querySelector('.edit-task-btn').onclick = () => openTaskEditModal(task, activeDateStr);
                    headerRow.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'daily');
                }
                
                el.appendChild(headerRow);

                // Tekrar sayƒ±sƒ± (eƒüer > 1 ise g√∂ster)
                if (task.repetitionCount && task.repetitionCount > 1) {
                    const repRow = document.createElement('div');
                    repRow.className = 'ml-8 flex space-x-1 items-center';
                    const checkboxes = [];
                    for (let i = 0; i < task.repetitionCount; i++) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-5 h-5 repetition-checkbox';
                        checkbox.dataset.index = i;
                        checkbox.checked = i < (task.repetitionCompleted || 0);
                        if (!readOnly) {
                            checkbox.onchange = () => updateTaskRepetition(task.id, i);
                        } else {
                            checkbox.disabled = true;
                        }
                        repRow.appendChild(checkbox);
                    }
                    el.appendChild(repRow);
                }

                // Alt g√∂revler (eƒüer varsa)
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'ml-8 border-l-2 border-pink-200 pl-3 space-y-1';
                    task.subtasks.forEach((subtask, idx) => {
                        const subtaskEl = document.createElement('div');
                        subtaskEl.className = 'flex items-center space-x-2 text-sm';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-4 h-4 subtask-checkbox';
                        checkbox.dataset.index = idx;
                        checkbox.checked = subtask.completed || false;
                        if (!readOnly) {
                            checkbox.onchange = () => updateSubtask(task.id, idx);
                        } else {
                            checkbox.disabled = true;
                        }
                        subtaskEl.appendChild(checkbox);
                        const label = document.createElement('span');
                        label.className = 'text-gray-700';
                        if (subtask.completed) label.className += ' line-through opacity-60';
                        label.textContent = subtask.title;
                        subtaskEl.appendChild(label);
                        subtaskRow.appendChild(subtaskEl);
                    });
                    el.appendChild(subtaskRow);
                }
                
            } else if (taskListType === 'weekly') {
                el.className = 'task-item bg-white p-4 rounded-lg shadow-md flex flex-col space-y-2';
                
                // Ana g√∂rev ba≈ülƒ±ƒüƒ± satƒ±rƒ±
                const headerRow = document.createElement('div');
                headerRow.className = 'flex items-center space-x-4';
                headerRow.innerHTML = `
                    <span class="flex-grow text-gray-800">${task.title} (Haftada ${task.frequency} kez)</span>
                    <button class="edit-task-btn text-blue-400 hover:text-blue-600 text-lg" title="G√∂revi d√ºzenle">‚úé</button>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl" title="G√∂revi sil">&times;</button>
                `;
                
                headerRow.querySelector('.edit-task-btn').onclick = () => openWeeklyTaskEditModal(task, currentWeekStr);
                headerRow.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'weekly');
                
                el.appendChild(headerRow);

                // Frekans kutucuklarƒ±
                const repRow = document.createElement('div');
                repRow.className = 'ml-8 flex space-x-1 items-center';
                for (let i = 0; i < task.frequency; i++) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'w-5 h-5 weekly-checkbox';
                    checkbox.dataset.index = i;
                    checkbox.checked = i < task.completed;
                    checkbox.onchange = () => updateWeeklyTask(task.id);
                    repRow.appendChild(checkbox);
                }
                el.appendChild(repRow);

                // Alt g√∂revler (varsa)
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'ml-8 border-l-2 border-green-200 pl-3 space-y-1';
                    task.subtasks.forEach((subtask, idx) => {
                        const subtaskEl = document.createElement('div');
                        subtaskEl.className = 'flex items-center space-x-2 text-sm';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-4 h-4 subtask-checkbox';
                        checkbox.dataset.index = idx;
                        checkbox.checked = subtask.completed || false;
                        checkbox.onchange = () => updateWeeklySubtask(task.id, idx);
                        subtaskEl.appendChild(checkbox);
                        const label = document.createElement('span');
                        label.className = 'text-gray-700';
                        if (subtask.completed) label.className += ' line-through opacity-60';
                        label.textContent = subtask.title;
                        subtaskEl.appendChild(label);
                        subtaskRow.appendChild(subtaskEl);
                    });
                    el.appendChild(subtaskRow);
                }
            }
            return el;
        }

        /**
         * YENƒ∞: Statik arka plan listesini DOM'a √ßizer (√ái√ßekler)
         */
        function renderStaticBackgrounds() {
            const container = $("#bg-results-grid");
            if (!container) return;

            container.innerHTML = ""; // Temizle
            
            FLOWER_BACKGROUND_PRESETS.forEach(item => {
                container.appendChild(createThumbnail(item.url, item.style));
            });
        }
        
        /**
         * YENƒ∞: Tek bir k√º√ß√ºk resim (thumbnail) elementi olu≈üturur ve d√∂nd√ºr√ºr
         */
        function createThumbnail(url, title = "Arka planƒ± se√ß") {
            const thumb = document.createElement('div');
            thumb.className = 'bg-thumbnail';
            thumb.style.backgroundImage = `url('${url}')`;
            thumb.title = title; // Yeni title kullanƒ±mƒ±
            thumb.onclick = () => {
                document.body.style.backgroundImage = `url('${url}')`;
                lsSet('settings_userBackground', url); // Se√ßimi kaydet
            };
            return thumb;
        }


        // --- Dƒ∞ƒûER YARDIMCI VE ƒ∞≈ûLEM FONKSƒ∞YONLARI ---

        /**
         * T√ºm UI event listener'larƒ±nƒ± ayarlar.
         */
        function setupEventListeners() {
            // S√ºtun ba≈üƒ±na hƒ±zlƒ± ekleme
            const addDunyeviBtn = $("#add-dunyevi-btn");
            const addDunyeviInput = $("#add-dunyevi-input");
            const addDunyeviCount = $("#add-dunyevi-count");
            const addDunyeviConfirm = $("#add-dunyevi-confirm");
            if (addDunyeviBtn && addDunyeviInput) {
                // Step 1: Plus shows text input only
                addDunyeviBtn.onclick = () => {
                    addDunyeviInput.classList.remove('hidden');
                    if (addDunyeviCount) addDunyeviCount.classList.add('hidden');
                    if (addDunyeviConfirm) addDunyeviConfirm.classList.add('hidden');
                    addDunyeviInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it (single handler; remove conflicting legacy ones)
                addDunyeviInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addDunyeviInput.value.trim()) return;
                        if (addDunyeviCount) {
                            addDunyeviCount.classList.remove('hidden');
                            addDunyeviCount.focus();
                            addDunyeviCount.select();
                            if (addDunyeviConfirm) addDunyeviConfirm.classList.remove('hidden');
                        } else {
                            // Fallback: add with default count
                            quickAddDailyTask(addDunyeviInput.value.trim(), 'dunyevi', 1);
                        }
                    }
                };
                // Ensure no legacy handlers interfere
                addDunyeviInput.onkeydown = null;
                addDunyeviInput.onkeypress = null;
                addDunyeviInput.removeEventListener && addDunyeviInput.removeEventListener('compositionend', () => {});
                // Step 3: Enter on count adds the task
                if (addDunyeviCount) {
                    addDunyeviCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addDunyeviInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                            quickAddDailyTask(title, 'dunyevi', count);
                            if (addDunyeviConfirm) addDunyeviConfirm.classList.add('hidden');
                        }
                    };
                    // Fallback: blur or change also adds
                    addDunyeviCount.onchange = () => {
                        const title = addDunyeviInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                        quickAddDailyTask(title, 'dunyevi', count);
                    };
                    addDunyeviCount.onblur = () => {
                        const title = addDunyeviInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                        quickAddDailyTask(title, 'dunyevi', count);
                    };
                    if (addDunyeviConfirm) {
                        addDunyeviConfirm.onclick = () => {
                            const title = addDunyeviInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                            quickAddDailyTask(title, 'dunyevi', count);
                            addDunyeviConfirm.classList.add('hidden');
                        };
                    }
                }
            }
            const addIlmiBtn = $("#add-ilmi-btn");
            const addIlmiInput = $("#add-ilmi-input");
            const addIlmiCount = $("#add-ilmi-count");
            const addIlmiConfirm = $("#add-ilmi-confirm");
            if (addIlmiBtn && addIlmiInput) {
                // Step 1: Plus shows text input only
                addIlmiBtn.onclick = () => {
                    addIlmiInput.classList.remove('hidden');
                    if (addIlmiCount) addIlmiCount.classList.add('hidden');
                    if (addIlmiConfirm) addIlmiConfirm.classList.add('hidden');
                    addIlmiInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it (single handler)
                addIlmiInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addIlmiInput.value.trim()) return;
                        if (addIlmiCount) {
                            addIlmiCount.classList.remove('hidden');
                            addIlmiCount.focus();
                            addIlmiCount.select();
                            if (addIlmiConfirm) addIlmiConfirm.classList.remove('hidden');
                        } else {
                            quickAddDailyTask(addIlmiInput.value.trim(), 'ilmi', 1);
                        }
                    }
                };
                // Remove legacy interference
                addIlmiInput.onkeydown = null;
                addIlmiInput.onkeypress = null;
                addIlmiInput.removeEventListener && addIlmiInput.removeEventListener('compositionend', () => {});
                // Step 3: Enter on count adds the task
                if (addIlmiCount) {
                    addIlmiCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addIlmiInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                            quickAddDailyTask(title, 'ilmi', count);
                            if (addIlmiConfirm) addIlmiConfirm.classList.add('hidden');
                        }
                    };
                    addIlmiCount.onchange = () => {
                        const title = addIlmiInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                        quickAddDailyTask(title, 'ilmi', count);
                    };
                    addIlmiCount.onblur = () => {
                        const title = addIlmiInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                        quickAddDailyTask(title, 'ilmi', count);
                    };
                    if (addIlmiConfirm) {
                        addIlmiConfirm.onclick = () => {
                            const title = addIlmiInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                            quickAddDailyTask(title, 'ilmi', count);
                            addIlmiConfirm.classList.add('hidden');
                        };
                    }
                }
            }
            const addHaftalikBtn = $("#add-haftalik-btn");
            const addHaftalikInput = $("#add-haftalik-input");
            const addHaftalikCount = $("#add-haftalik-count");
            const addHaftalikConfirm = $("#add-haftalik-confirm");
            if (addHaftalikBtn && addHaftalikInput) {
                // Step 1: Plus shows text input only
                addHaftalikBtn.onclick = () => {
                    addHaftalikInput.classList.remove('hidden');
                    if (addHaftalikCount) addHaftalikCount.classList.add('hidden');
                    if (addHaftalikConfirm) addHaftalikConfirm.classList.add('hidden');
                    addHaftalikInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it
                addHaftalikInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addHaftalikInput.value.trim()) return;
                        if (addHaftalikCount) {
                            addHaftalikCount.classList.remove('hidden');
                            addHaftalikCount.focus();
                            addHaftalikCount.select();
                            if (addHaftalikConfirm) addHaftalikConfirm.classList.remove('hidden');
                        } else {
                            quickAddWeeklyTask(addHaftalikInput.value.trim(), 1);
                        }
                    }
                };
                // Step 3: Enter/change/blur on count adds the task
                if (addHaftalikCount) {
                    addHaftalikCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addHaftalikInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                            quickAddWeeklyTask(title, count);
                        }
                    };
                    addHaftalikCount.onchange = () => {
                        const title = addHaftalikInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                        quickAddWeeklyTask(title, count);
                    };
                    addHaftalikCount.onblur = () => {
                        const title = addHaftalikInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                        quickAddWeeklyTask(title, count);
                    };
                    if (addHaftalikConfirm) {
                        addHaftalikConfirm.onclick = () => {
                            const title = addHaftalikInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                            quickAddWeeklyTask(title, count);
                        };
                    }
                }
            }
            
            // Ana Sekme Deƒüi≈üimi
            $$(".tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent'); // Pasif stil
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent'); // Aktif stil
                    
                    $$(".tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.tab + "-tab").classList.remove('hidden');
                };
            });
            
            // Havuz Sekme Deƒüi≈üimi
            $$(".pool-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".pool-tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent');
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent');
                    
                    $$(".pool-tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.poolTab).classList.remove('hidden');
                };
            });

            // YENƒ∞: ƒ∞statistik alt sekme deƒüi≈üimi
            $$(".stats-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    // T√ºm butonlarƒ± pasif yap
                    $$(".stats-tab-btn").forEach(b => {
                        b.classList.remove('text-indigo-600', 'border-indigo-600');
                        b.classList.add('text-gray-500');
                    });
                    // Tƒ±klananƒ± aktif yap
                    e.target.classList.add('text-indigo-600', 'border-indigo-600');
                    e.target.classList.remove('text-gray-500');
                    
                    // T√ºm i√ßerikleri gizle
                    $$(".stats-tab-content").forEach(c => c.classList.add('hidden'));
                    
                    // ƒ∞lgili i√ßeriƒüi g√∂ster
                    const tabId = e.target.dataset.statsTab + "-tab";
                    const contentTab = $("#" + tabId);
                    if (contentTab) {
                        contentTab.classList.remove('hidden');
                    }
                };
            });
            
            // N√∂bet ƒ∞≈üleme (ƒ∞stek 8)
            $("#rota-process-btn").onclick = processRota;
            
            // YENƒ∞: Ayar kaydetme butonlarƒ±
            $("#api-key-save-btn").onclick = saveApiKey;
            $('#rota-name-input').onblur = saveRotaName; // ƒ∞sim kutusundan √ßƒ±kƒ±nca kaydet
            
            // YENƒ∞: Yerel Arka Plan Y√ºkleme
            $("#upload-bg-btn").onclick = handleLocalBackgroundUpload;

            // Modal Kapatma
            $("#modal-close-btn").onclick = () => $("#message-modal").classList.add('hidden');
            
            // Ge√ßmi≈ü Modal
            $("#show-history-btn").onclick = showHistoryModal;
            $("#history-modal-close-btn").onclick = () => $("#history-modal").classList.add('hidden');

            // Havuz Modal a√ß/kapat
            const openPoolBtn = $("#open-pool-btn");
            if (openPoolBtn) openPoolBtn.onclick = () => {
                $("#pool-modal").classList.remove('hidden');
                loadPools();
            };
            const poolCloseBtn = $("#pool-modal-close-btn");
            if (poolCloseBtn) poolCloseBtn.onclick = () => $("#pool-modal").classList.add('hidden');
            const poolModal = document.getElementById("pool-modal");
            if (poolModal) poolModal.onclick = (e) => { if (e.target.id === "pool-modal") poolModal.classList.add('hidden'); };

            // Tarih gezinme butonlarƒ±
            const prevBtn = $("#prev-day-btn");
            const nextBtn = $("#next-day-btn");
            if (prevBtn) prevBtn.onclick = () => setActiveDate(addDays(activeDateStr, -1));
            if (nextBtn) nextBtn.onclick = () => setActiveDate(addDays(activeDateStr, 1));
            
            // YENƒ∞: Veri Yedekleme Event Listeners
            $("#export-data-btn").onclick = exportData;
            $("#import-data-btn").onclick = () => $("#import-file-input").click(); // Gizli input'u tetikle
            $("#import-file-input").onchange = importData;

            // YENƒ∞: G√∂rev D√ºzenleme Modal Event Listeners
            $("#add-subtask-btn").onclick = addSubtaskToEdit;
            $("#edit-task-save-btn").onclick = saveTaskEdit;
            $("#edit-task-cancel-btn").onclick = closeTaskEditModal;
            // Modal dƒ±≈üƒ±nda bir yere tƒ±klanƒ±rsa kapat
            document.getElementById("task-edit-modal").onclick = (e) => {
                if (e.target.id === "task-edit-modal") closeTaskEditModal();
            };
        }

        // Hƒ±zlƒ± ekleme yardƒ±mcƒ±larƒ±
        function quickAddDailyTask(title, type, repetitionCount = 1) {
            if (!title) return;
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu tarih ar≈üivlenmi≈ü. Sadece ge√ßmi≈ü veya bug√ºn d√ºzenlenebilir.');
                return;
            }
            const key = `tasks_daily_${activeDateStr}`;
            const tasks = lsGet(key, []);
            const exists = tasks.some(t => t.title === title && t.type === type);
            if (exists) return;
            tasks.push({
                id: Date.now().toString(),
                title,
                type,
                status: 0,
                repetitionCount: Math.max(1, parseInt(repetitionCount, 10) || 1),
                repetitionCompleted: 0,
                subtasks: [],
                subtaskScoring: 'grouped'
            });
            persistDailyState(activeDateStr, tasks);
            loadDailyTasks();
            // Girdileri temizle ve gizle
            if (type === 'dunyevi') {
                const i = $("#add-dunyevi-input"); const c = $("#add-dunyevi-count");
                if (i) { i.value=''; i.classList.add('hidden'); }
                if (c) { c.value='1'; c.classList.add('hidden'); }
            }
            if (type === 'ilmi') {
                const i = $("#add-ilmi-input"); const c = $("#add-ilmi-count");
                if (i) { i.value=''; i.classList.add('hidden'); }
                if (c) { c.value='1'; c.classList.add('hidden'); }
            }
        }

        function quickAddWeeklyTask(title, frequency = 1) {
            if (!title) return;
            const key = `tasks_weekly_${currentWeekStr}`;
            const tasks = lsGet(key, []);
            const exists = tasks.some(t => t.title === title);
            if (exists) return;
            tasks.push({
                id: Date.now().toString(),
                title,
                frequency: Math.max(1, parseInt(frequency, 10) || 1),
                completed: 0,
                subtasks: [],
                subtaskScoring: 'grouped'
            });
            lsSet(key, tasks);
            calculateWeeklySuccess();
            loadWeeklyTasks();
            const i = $("#add-haftalik-input"); const c = $("#add-haftalik-count");
            if (i) { i.value=''; i.classList.add('hidden'); }
            if (c) { c.value='1'; c.classList.add('hidden'); }
        }

        // --- CRUD ƒ∞≈ûLEMLERƒ∞ ---

        /**
         * YENƒ∞: API Anahtarƒ±nƒ± kaydeder
         */
        function saveApiKey() {
            const apiKey = $("#api-key-input").value.trim();
            lsSet('settings_apiKey', apiKey);
            showMessage("Kaydedildi", "API Anahtarƒ±nƒ±z tarayƒ±cƒ±nƒ±za kaydedildi.");
        }

        /**
         * YENƒ∞: N√∂bet ismini kaydeder
         */
        function saveRotaName() {
            const rotaName = $("#rota-name-input").value.trim();
            lsSet('settings_rotaName', rotaName);
        }

        /**
         * Formdan aldƒ±ƒüƒ± veriye g√∂re yeni g√∂rev ekler (g√ºnl√ºk veya haftalƒ±k)
         */
        async function handleAddTask() {
            const title = $("#new-task-title").value.trim();
            const type = $("#new-task-type").value;
            const frequency = parseInt($("#new-task-frequency").value) || 1;
            
            if (!title) {
                showMessage("Hata", "L√ºtfen bir g√∂rev adƒ± girin.");
                return;
            }

            try {
                if (type === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        frequency: frequency,
                        completed: 0,
                        subtasks: [], // Alt g√∂revler (haftalƒ±k i√ßin de)
                        subtaskScoring: 'grouped'
                    });
                    lsSet(key, tasks);
                    loadWeeklyTasks(); // UI'ƒ± yenile (i√ßinde haftalƒ±k ba≈üarƒ± hesaplamasƒ± var)

                } else {
                    if (!isActiveDateEditable()) {
                        showMessage('Salt Okunur', 'Bu tarih ar≈üivlenmi≈ü. Sadece son 7 g√ºne kadar d√ºzenleyebilirsiniz.');
                        return;
                    }
                    const key = `tasks_daily_${activeDateStr}`;
                    const tasks = lsGet(key, []);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        type: type,
                        status: 0,
                        repetitionCount: 1, // Varsayƒ±lan: 1 kez
                        repetitionCompleted: 0, // Ka√ß kez tamamlandƒ±
                        subtasks: [], // Alt g√∂revler
                        subtaskScoring: 'grouped' // 'grouped' veya 'individual'
                    });
                    // Persist and update history/stats for this date
                    persistDailyState(activeDateStr, tasks);
                    loadDailyTasks(); // UI'ƒ± yenile (i√ßinde g√ºnl√ºk ba≈üarƒ± hesaplamasƒ± var)
                }
                
                // G√∂revi K√ºmeye de ekle (ƒ∞stek 1)
                const poolType = (type === 'haftalik') ? 'haftalik' : (type === 'dunyevi' ? 'dunyevi' : 'ilmi');
                const poolKey = `pools_${poolType}`;
                
                const poolTasks = lsGet(poolKey, []);
                const taskExists = poolTasks.some(task => task.title === title);
                
                if (!taskExists) {
                    poolTasks.push({
                        id: Date.now().toString(),
                        title: title,
                        isDefault: false,
                        ...(type === 'haftalik' && { frequency: frequency })
                    });
                    lsSet(poolKey, poolTasks);
                    loadPools(); // UI'ƒ± yenile
                }
                
                // Formu temizle
                $("#new-task-title").value = "";
                $("#new-task-frequency").value = "1";

            } catch (error) {
                console.error("G√∂rev ekleme hatasƒ±:", error);
                showMessage("Hata", "G√∂rev eklenirken bir sorun olu≈ütu.");
            }
        }
        
        /**
         * YENƒ∞: Havuzdan bir g√∂reve tƒ±klandƒ±ƒüƒ±nda onu g√ºnl√ºk listeye ekler
         */
        function handlePoolClick(task, containerId) {
            try {
                const poolType = poolTypeFromContainer(containerId);
                if (!poolType) return;
                
                if (poolType === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            frequency: task.frequency || 1,
                            completed: 0,
                            subtasks: task.subtasks || [],
                            subtaskScoring: task.subtaskScoring || 'grouped'
                        });
                        lsSet(key, tasks);
                        loadWeeklyTasks();
                    }
                } else {
                    if (!isActiveDateEditable()) {
                        showMessage('Salt Okunur', 'Bu tarih ar≈üivlenmi≈ü. Sadece son 7 g√ºne kadar d√ºzenleyebilirsiniz.');
                        return;
                    }
                    const key = `tasks_daily_${activeDateStr}`;
                    const tasks = lsGet(key, []);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            type: poolType,
                            status: 0,
                            repetitionCount: task.repetitionCount || 1,
                            repetitionCompleted: 0,
                            subtasks: task.subtasks || [],
                            subtaskScoring: task.subtaskScoring || 'grouped'
                        });
                        // Persist and update history/stats for this date
                        persistDailyState(activeDateStr, tasks);
                        loadDailyTasks();
                    }
                }
            } catch (error) {
                console.error("Havuzdan g√∂rev ekleme hatasƒ±:", error);
            }
        }

        // --- YENƒ∞: G√ñREV D√úZENLEME FONKSƒ∞YONLARI ---

        let editingTaskData = null; // Modal'da d√ºzenlenen g√∂revin ge√ßici verisi
        let editingTaskType = null; // 'daily' veya 'weekly'

        function openTaskEditModal(task, dateStr) {
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu tarih ar≈üivlenmi≈ü. Sadece son 7 g√ºne kadar d√ºzenleyebilirsiniz.');
                return;
            }

            editingTaskType = 'daily';
            editingTaskData = { ...task, dateStr }; // Ge√ßici kopya (orijinal deƒüi≈ütirilmemesi i√ßin)

            // Modal alanlarƒ±nƒ± doldur
            $("#edit-task-title").value = task.title;
            
            // Tekrar sayƒ±sƒ± (sadece g√ºnl√ºk g√∂revler i√ßin)
            if (task.type === 'haftalik') {
                $("#edit-repetition-section").classList.add('hidden');
            } else {
                $("#edit-repetition-section").classList.remove('hidden');
                $("#edit-task-repetition").value = task.repetitionCount || 1;
            }

            // Alt g√∂revleri listele
            renderEditSubtasksList();

            // Alt g√∂rev skorlamasƒ±
            if (task.subtasks && task.subtasks.length > 0) {
                $("#edit-subtask-scoring-section").classList.remove('hidden');
                document.querySelector(`input[name="subtask-scoring"][value="${task.subtaskScoring || 'grouped'}"]`).checked = true;
            } else {
                $("#edit-subtask-scoring-section").classList.add('hidden');
            }

            // Modal'ƒ± a√ß
            $("#task-edit-modal").classList.remove('hidden');
        }

        function openWeeklyTaskEditModal(task, weekStr) {
            editingTaskType = 'weekly';
            editingTaskData = { ...task, weekStr }; // Ge√ßici kopya

            // Modal alanlarƒ±nƒ± doldur
            $("#edit-task-title").value = task.title;
            $("#edit-repetition-section").classList.add('hidden'); // Haftalƒ±k i√ßin gizle
            
            // Alt g√∂revleri listele
            renderEditSubtasksList();

            // Alt g√∂rev skorlamasƒ±
            if (task.subtasks && task.subtasks.length > 0) {
                $("#edit-subtask-scoring-section").classList.remove('hidden');
                document.querySelector(`input[name="subtask-scoring"][value="${task.subtaskScoring || 'grouped'}"]`).checked = true;
            } else {
                $("#edit-subtask-scoring-section").classList.add('hidden');
            }

            // Modal'ƒ± a√ß
            $("#task-edit-modal").classList.remove('hidden');
        }

        function renderEditSubtasksList() {
            const container = $("#edit-subtasks-list");
            const subtasks = editingTaskData.subtasks || [];

            if (subtasks.length === 0) {
                container.innerHTML = '<p class="text-gray-400 italic text-sm">Alt g√∂rev eklenmedi</p>';
            } else {
                container.innerHTML = '';
                subtasks.forEach((subtask, idx) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center space-x-2 p-2 bg-gray-100 rounded';
                    el.innerHTML = `
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} disabled class="w-4 h-4">
                        <span class="flex-grow text-sm">${subtask.title}</span>
                        <button class="text-red-500 hover:text-red-700 text-sm">Sil</button>
                    `;
                    el.querySelector('button').onclick = () => {
                        editingTaskData.subtasks.splice(idx, 1);
                        renderEditSubtasksList();
                        updateEditSubtaskScoringVisibility();
                    };
                    container.appendChild(el);
                });
            }
        }

        function updateEditSubtaskScoringVisibility() {
            const section = $("#edit-subtask-scoring-section");
            const subtasks = editingTaskData.subtasks || [];
            if (subtasks.length > 0) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function addSubtaskToEdit() {
            const title = prompt("Alt g√∂rev adƒ± girin:");
            if (title && title.trim()) {
                editingTaskData.subtasks = editingTaskData.subtasks || [];
                editingTaskData.subtasks.push({
                    title: title.trim(),
                    completed: false
                });
                renderEditSubtasksList();
                updateEditSubtaskScoringVisibility();
            }
        }

        function saveTaskEdit() {
            if (!editingTaskData || !editingTaskType) return;

            const newTitle = $("#edit-task-title").value.trim();
            if (!newTitle) {
                showMessage("Hata", "G√∂rev adƒ± bo≈ü olamaz.");
                return;
            }
            // Havuz senkronizasyonu i√ßin eski ba≈ülƒ±ƒüƒ± sakla
            const oldTitle = editingTaskData.title;
            editingTaskData.title = newTitle;
            
            // Tekrar sayƒ±sƒ±nƒ± g√ºncelle (sadece g√ºnl√ºk g√∂revler i√ßin)
            if (editingTaskType === 'daily' && editingTaskData.type !== 'haftalik') {
                const rep = parseInt($("#edit-task-repetition").value) || 1;
                editingTaskData.repetitionCount = rep;
                // Eƒüer tekrar sayƒ±sƒ± azaldƒ±ysa, tamamlanan sayƒ±sƒ± da azalt
                if (editingTaskData.repetitionCompleted > rep) {
                    editingTaskData.repetitionCompleted = rep;
                }
            }

            // Alt g√∂rev skorlamasƒ±
            if (editingTaskData.subtasks && editingTaskData.subtasks.length > 0) {
                const scoringType = document.querySelector('input[name="subtask-scoring"]:checked').value;
                editingTaskData.subtaskScoring = scoringType;
            }

            // Verileri kaydet
            if (editingTaskType === 'daily') {
                const key = `tasks_daily_${editingTaskData.dateStr}`;
                let tasks = lsGet(key, []);
                const taskIndex = tasks.findIndex(t => t.id === editingTaskData.id);
                if (taskIndex > -1) {
                    tasks[taskIndex] = editingTaskData;
                    persistDailyState(editingTaskData.dateStr, tasks);
                    loadDailyTasks();
                    // G√ºnl√ºk g√∂revler i√ßin havuza senkronize et
                    const poolType = editingTaskData.type === 'ilmi' ? 'ilmi' : 'dunyevi';
                    syncTaskToPool(editingTaskData, poolType, oldTitle);
                }
            } else if (editingTaskType === 'weekly') {
                const key = `tasks_weekly_${editingTaskData.weekStr}`;
                let tasks = lsGet(key, []);
                const taskIndex = tasks.findIndex(t => t.id === editingTaskData.id);
                if (taskIndex > -1) {
                    tasks[taskIndex] = editingTaskData;
                    lsSet(key, tasks);
                    calculateWeeklySuccess();
                    loadWeeklyTasks();
                    // Haftalƒ±k g√∂revler i√ßin havuza senkronize et
                    syncTaskToPool(editingTaskData, 'haftalik', oldTitle);
                }
            }

            closeTaskEditModal();
        }

        function closeTaskEditModal() {
            $("#task-edit-modal").classList.add('hidden');
            editingTaskData = null;
            editingTaskType = null;
        }

        function updateSubtask(taskId, subtaskIndex) {
            const key = `tasks_daily_${activeDateStr}`;
            let tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                if (task.subtasks && task.subtasks[subtaskIndex]) {
                    task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                    persistDailyState(activeDateStr, tasks);
                    loadDailyTasks();
                }
            }
        }

        function updateTaskRepetition(taskId, repetitionIndex) {
            const key = `tasks_daily_${activeDateStr}`;
            let tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                // Eƒüer son kutucuk ise, tamamlanan sayƒ±sƒ±nƒ± o indexe ayarla + 1
                // Yani indexler 0-based; 3 adet varsa index 0, 1, 2 var; tƒ±klanƒ±p completed=1, 2, 3 olabilir
                let newCompleted = 0;
                const checkboxes = document.querySelectorAll(`[data-id="${taskId}"] .repetition-checkbox`);
                checkboxes.forEach((cb, idx) => {
                    if (cb.checked) newCompleted = idx + 1;
                });
                task.repetitionCompleted = newCompleted;
                persistDailyState(activeDateStr, tasks);
                // UI hemen g√ºncellemek yerine modal tetiklememek i√ßin sadece veri g√ºncelleyelim
                calculateSuccess();
                loadStats();
            }
        }

        function updateWeeklySubtask(taskId, subtaskIndex) {
            const key = `tasks_weekly_${currentWeekStr}`;
            let tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                if (task.subtasks && task.subtasks[subtaskIndex]) {
                    task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                    lsSet(key, tasks);
                    calculateWeeklySuccess();
                    loadWeeklyTasks();
                }
            }
        }
        
        /**
         * YENƒ∞: G√ºnl√ºk g√∂revin durumunu g√ºnceller (0, 1, 2)
         */
        async function updateTaskStatus(taskId, currentStatus) {
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu g√∂rev ar≈üivlenmi≈ü ve d√ºzenlenemez. Sadece son 7 g√ºne kadar d√ºzenleyebilirsiniz.');
                return;
            }
            const newStatus = (currentStatus + 1) % 3;
            const key = `tasks_daily_${activeDateStr}`;
            const tasks = lsGet(key, []);
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                tasks[taskIndex].status = newStatus;
                // Persist and update history/stats for this date
                persistDailyState(activeDateStr, tasks);
                loadDailyTasks(); // UI'ƒ± yenile (i√ßinde ba≈üarƒ± hesaplamasƒ± var)
            }
        }
        
        /**
         * YENƒ∞: Haftalƒ±k g√∂revin tamamlanma sayƒ±sƒ±nƒ± g√ºnceller
         */
        async function updateWeeklyTask(taskId) {
            const taskElement = document.querySelector(`.task-item[data-id="${taskId}"]`);
            if (!taskElement) return;
            
            const checkboxes = taskElement.querySelectorAll('.weekly-checkbox');
            const completedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            const key = `tasks_weekly_${currentWeekStr}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].completed = completedCount;
                lsSet(key, tasks);
                calculateWeeklySuccess(); // YENƒ∞: Haftalƒ±k ba≈üarƒ±yƒ± anƒ±nda g√ºncelle
            }
        }

        /**
         * YENƒ∞: Bir g√∂revi g√ºnl√ºk/haftalƒ±k listeden siler
         */
        async function deleteTask(taskId, taskType) {
            if (taskType === 'daily') {
                if (!isActiveDateEditable()) {
                    showMessage('Salt Okunur', 'Ar≈üivlenmi≈ü g√∂revler silinemez. Sadece son 7 g√ºne kadar d√ºzenleyebilirsiniz.');
                    return;
                }
                const key = `tasks_daily_${activeDateStr}`;
                let tasks = lsGet(key, []);
                tasks = tasks.filter(t => t.id !== taskId);
                // Persist and update history/stats for this date
                persistDailyState(activeDateStr, tasks);
                loadDailyTasks();
            } else if (taskType === 'weekly') {
                const key = `tasks_weekly_${currentWeekStr}`;
                let tasks = lsGet(key, []);
                tasks = tasks.filter(t => t.id !== taskId);
                lsSet(key, tasks);
                loadWeeklyTasks();
            }
        }

        /**
         * YENƒ∞: Bir g√∂revin havuzdaki varsayƒ±lan (isDefault) durumunu deƒüi≈ütirir
         */
        async function toggleTaskDefault(taskId, poolType) {
            const key = `pools_${poolType}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].isDefault = !tasks[taskIndex].isDefault;
                lsSet(key, tasks);
                loadPools(); // UI'ƒ± yenile
            }
        }

        /**
         * YENƒ∞: Bir g√∂revi havuzdan kalƒ±cƒ± olarak siler
         */
        async function deleteFromPool(taskId, poolType) {
            const key = `pools_${poolType}`;
            let tasks = lsGet(key, []);
            tasks = tasks.filter(t => t.id !== taskId);
            lsSet(key, tasks);
            loadPools(); // UI'ƒ± yenile
        }
        
        /**
         * YENƒ∞: Ba≈üarƒ± oranƒ±nƒ± hesaplar ve g√∂sterir
         */
        function calculateSuccess(tasks = null) {
            if (tasks === null) {
                tasks = lsGet(`tasks_daily_${activeDateStr}`, []);
                // Eƒüer aktif tarihte canlƒ± kayƒ±t yoksa ar≈üivden oku
                if ((!tasks || tasks.length === 0) && lsGet('history', {})[activeDateStr]) {
                    tasks = lsGet('history', {})[activeDateStr];
                }
            }
            
            const total = tasks.length;
            if (total === 0) {
                const rateEl = $("#success-rate");
                const waterEl = $("#daily-pool-water");
                const cL = $("#daily-carrier-left");
                const cR = $("#daily-carrier-right");
                if (rateEl) rateEl.textContent = "0%";
                if (waterEl) waterEl.style.height = "0%";
                if (cL) cL.style.animationDuration = '4s';
                if (cR) cR.style.animationDuration = '4s';
                return { total: 0, completed: 0 };
            }
            
            // Yarƒ±m yapƒ±lanlar 0.5, tam yapƒ±lanlar 1 puan
            const completed = tasks.reduce((sum, task) => {
                if (task.status === 1) return sum + 0.5;
                if (task.status === 2) return sum + 1;
                return sum;
            }, 0);
            
            const successRate = Math.round((completed / total) * 100);
            // Artƒ±k toplam g√ºnl√ºk ba≈üarƒ± yerine, t√ºr bazlƒ± iki ayrƒ± animasyon kullanƒ±yoruz.
            updateDailyTypeSuccess('dunyevi');
            updateDailyTypeSuccess('ilmi');
            
            return { total, completed };
        }

        /**
         * Helper: compute success percentage from a task list
         */
        function computeSuccessFromTasks(tasks) {
            const total = tasks.length;
            let completed = 0;
            if (total === 0) return { total: 0, completed: 0, success: 0 };
            
            completed = tasks.reduce((sum, task) => {
                let taskScore = 0;

                // Eƒüer alt g√∂revler varsa
                if (task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    if (task.subtaskScoring === 'individual') {
                        // Her alt g√∂rev ayrƒ± ayrƒ± puan
                        taskScore = completedSubtasks;
                        return sum + taskScore / task.subtasks.length; // Normalize et
                    } else {
                        // Hepsi birlikte 1 puan (grouped)
                        taskScore = completedSubtasks === task.subtasks.length ? 1 : (completedSubtasks > 0 ? 0.5 : 0);
                        return sum + taskScore;
                    }
                }

                // Tekrar sayƒ±sƒ± varsa
                if (task.repetitionCount && task.repetitionCount > 1) {
                    taskScore = task.repetitionCompleted / task.repetitionCount;
                    return sum + taskScore;
                }

                // Normal durum (status: 0, 1, 2)
                if (task.status === 1) taskScore = 0.5;
                if (task.status === 2) taskScore = 1;
                
                return sum + taskScore;
            }, 0);
            
            const success = Math.round((completed / total) * 100);
            return { total, completed, success };
        }

        /**
         * Persist daily tasks for a date and update history & stats immediately.
         * Ensures that edits to previous days are reflected in 'history' and 'stats'.
         */
        function persistDailyState(dateStr, tasks) {
            // Ensure tasks is an array
            tasks = tasks || [];
            // Save the live daily key
            lsSet(`tasks_daily_${dateStr}`, tasks);

            // Update history mapping
            const allHistory = lsGet('history', {});
            allHistory[dateStr] = tasks;
            lsSet('history', allHistory);

            // Update stats.daily
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const { success } = computeSuccessFromTasks(tasks);
            allStats.daily = allStats.daily || {};
            allStats.daily[dateStr] = { success };
            lsSet('stats', allStats);

            // If the persisted date is the currently active or current day, update UI elements
            if (dateStr === activeDateStr || dateStr === currentDayStr) {
                calculateSuccess();
                loadStats();
            }
        }

        /**
         * YENƒ∞: Haftalƒ±k ba≈üarƒ± oranƒ±nƒ± hesaplar.
         * tasks null ise, mevcut haftayƒ± LS'den okur ve UI'ƒ± g√ºnceller.
         * tasks doluysa, o g√∂rev listesi i√ßin oranƒ± hesaplar ve d√∂nd√ºr√ºr.
         */
        function calculateWeeklySuccess(tasks = null, weekId = null) {
            let updateUI = false;
            if (tasks === null) {
                weekId = weekId || currentWeekStr;
                tasks = lsGet(`tasks_weekly_${weekId}`, []);
                updateUI = true;
            }

            if (tasks.length === 0) {
                if(updateUI) {
                    const rateEl = $("#weekly-success-rate");
                    const waterEl = $("#weekly-pool-water");
                    const cL = $("#weekly-carrier-left");
                    const cR = $("#weekly-carrier-right");
                    if (rateEl) rateEl.textContent = "0%";
                    if (waterEl) waterEl.style.height = "0%";
                    if (cL) cL.style.animationDuration = '4s';
                    if (cR) cR.style.animationDuration = '4s';
                }
                return 0; // Ba≈üarƒ± oranƒ±
            }

            // Her g√∂revin ne kadar tamamlandƒ±ƒüƒ±nƒ± hesapla
            let totalScore = 0;
            let totalMaxScore = 0;

            tasks.forEach(task => {
                const freq = task.frequency || 1;
                totalMaxScore += freq;

                // Eƒüer alt g√∂revler varsa, onlara g√∂re hesapla
                if (task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    if (task.subtaskScoring === 'individual') {
                        // Her alt g√∂rev ayrƒ± ayrƒ± puan (normalize et)
                        totalScore += (completedSubtasks / task.subtasks.length) * freq;
                    } else {
                        // Hepsi birlikte 1 puan
                        const score = completedSubtasks === task.subtasks.length ? 1 : (completedSubtasks > 0 ? 0.5 : 0);
                        totalScore += score * freq;
                    }
                } else {
                    // Normal: completed vs frequency
                    totalScore += task.completed;
                }
            });

            if (totalMaxScore === 0) {
                if(updateUI) $("#weekly-success-rate").textContent = "0%";
                return 0;
            }
            
            const successRate = Math.round((totalScore / totalMaxScore) * 100);
            if (updateUI) {
                const rateEl = $("#weekly-success-rate");
                const waterEl = $("#weekly-pool-water");
                const cL = $("#weekly-carrier-left");
                const cR = $("#weekly-carrier-right");
                if (rateEl) rateEl.textContent = `${successRate}%`;
                if (waterEl) waterEl.style.height = `${successRate}%`;
                const dur = 4 - (successRate / 100) * 2;
                // Vary droplet size/arc/time based on delta
                window.__lastRates = window.__lastRates || { dunyevi: 0, ilmi: 0, weekly: 0 };
                const prevWeekly = window.__lastRates.weekly || 0;
                const delta = Math.abs(successRate - prevWeekly);
                const bucketL = cL ? cL.querySelector('.bucket') : null;
                const bucketR = cR ? cR.querySelector('.bucket') : null;
                const dropSize = `${Math.min(10, 6 + Math.floor(delta / 15))}px`;
                const dropTime = `${Math.max(500, 700 + delta * 10)}ms`;
                const arcX = `${Math.min(30, 22 + Math.floor(delta / 10))}px`;
                const arcY = `${-Math.min(28, 22 + Math.floor(delta / 10))}px`;
                if (bucketL) { bucketL.style.setProperty('--drop-size', dropSize); bucketL.style.setProperty('--drop-time', dropTime); bucketL.style.setProperty('--arc-x', arcX); bucketL.style.setProperty('--arc-y', arcY); }
                if (bucketR) { bucketR.style.setProperty('--drop-size', dropSize); bucketR.style.setProperty('--drop-time', dropTime); bucketR.style.setProperty('--arc-x', arcX); bucketR.style.setProperty('--arc-y', arcY); }
                // Stagger pours: left then right
                if (cL) { cL.style.animationDuration = `${dur}s`; setTimeout(() => cL.classList.add('pour'), 0); setTimeout(() => { cL.classList.remove('pour'); }, 900); }
                if (cR) { cR.style.animationDuration = `${dur}s`; setTimeout(() => cR.classList.add('pour'), 220); setTimeout(() => { cR.classList.remove('pour'); }, 1120); }
                const poolEl = waterEl ? waterEl.parentElement : null;
                if (poolEl) { poolEl.classList.add('ripple'); setTimeout(() => poolEl.classList.remove('ripple'), 650); }
                // Haftalƒ±k i√ßin timed burst
                triggerSplashBurst('weekly', 25, prevWeekly, successRate);
                triggerSplashBurst('weekly', 50, prevWeekly, successRate);
                triggerSplashBurst('weekly', 75, prevWeekly, successRate);
                window.__lastRates.weekly = successRate;
            }
            return successRate;
        }

        // Celebration messages (30-day cycle)
        // Themed messages (Quran verses and Sahaba examples) with citations
        const celebrationMessages = [
            { text: "ƒ∞nsan i√ßin ancak √ßalƒ±≈ütƒ±ƒüƒ± vardƒ±r.", source: "Kur‚Äôan, Necm 53:39" },
            { text: "Zorlukla beraber kolaylƒ±k vardƒ±r.", source: "Kur‚Äôan, ƒ∞n≈üirah 94:6" },
            { text: "Sabredenlerle beraber olun.", source: "Kur‚Äôan, Tevbe 9:119" },
            { text: "Hayƒ±rda yarƒ±≈üƒ±n.", source: "Kur‚Äôan, Bakara 2:148" },
            { text: "≈û√ºkrederseniz, elbette arttƒ±rƒ±rƒ±m.", source: "Kur‚Äôan, ƒ∞brahim 14:7" },
            { text: "G√ºzel s√∂z ve amel y√ºkselir.", source: "Kur‚Äôan, Fatƒ±r 35:10 (mefhumu)" },
            { text: "Az da olsa devamlƒ± olan makbuld√ºr.", source: "Hadis, Buhari (ed-Da‚Äôv√¢m) mefhumu" },
            { text: "Ameller niyetlere g√∂redir.", source: "Hadis, Buhari 1" },
            { text: "ƒ∞lim amel ile kem√¢l bulur.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞hlas, azim ve sabƒ±r: √º√ß tac.", source: "Sahabe Hikmetlerinden" },
            { text: "Denge: d√ºnyevi ve ilmi gayret.", source: "Sahabe Hikmetlerinden" },
            { text: "Azim, yolun yarƒ±sƒ±dƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayret eden yolunu bulur.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞stikamet istikrardan doƒüar.", source: "Sahabe Hikmetlerinden" },
            { text: "Ta≈ü √ºst√ºne ta≈ü: bina sebatla y√ºkselir.", source: "Sahabe √ñrneƒüi (Metafor)" },
            { text: "Sabƒ±rla zafer gelir.", source: "Sahabe Hikmetlerinden" },
            { text: "Niyet temizse yol kolayla≈üƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Bug√ºn gayretinle kapƒ±lar a√ßƒ±ldƒ±.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞yiyi √ßoƒüalt, k√∂t√ºl√ºkten sakƒ±n.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "√áaba duadƒ±r; neticesi rahmettir.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "Seni gayret ta≈üƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Niyet g√ºzel, netice g√ºzel.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayretini sev; yolun kƒ±ymetini bil.", source: "Sahabe Hikmetlerinden" },
            { text: "Bug√ºn tamamladƒ±n; yarƒ±n yeniden ba≈üla.", source: "Sahabe Hikmetlerinden" },
            { text: "Kalbe huzur veren emek.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞yilikte sebat et.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "Her g√ºn bir tuƒüla.", source: "Sahabe √ñrneƒüi (Metafor)" },
            { text: "ƒ∞limle amel, amelle ihlas.", source: "Sahabe Hikmetlerinden" },
            { text: "√áabalayana kolaylƒ±k gelir.", source: "Kur‚Äôan, ƒ∞n≈üirah 94 (mefhumu)" },
            { text: "G√ºzel niyetler g√ºzel sonu√ßlar doƒüurur.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞stikrar ba≈üarƒ±nƒ±n anahtarƒ±dƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Azim ve emek iz bƒ±rakƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Hayƒ±r i≈üte yarƒ±≈üƒ±n: bug√ºn √∂ndesin.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "K√º√ß√ºk adƒ±mlar b√ºy√ºk kapƒ±lar a√ßar.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞lhamƒ±nƒ± canlƒ± tut; istikrar seni ta≈üƒ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Bug√ºn iraden g√º√ßlendi.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayretin bereketi huzur verir.", source: "Sahabe Hikmetlerinden" },
            { text: "Hayƒ±rlƒ± i≈ü istikrarla b√ºy√ºr.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞lim ve amel dengesi.", source: "Sahabe Hikmetlerinden" },
            { text: "≈û√ºk√ºrle ta√ßlandƒ±r.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "Azimli kal; yola devam.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞yilikte istikrar: bug√ºn parlƒ±yor.", source: "Sahabe Hikmetlerinden" },
            { text: "Hedefe giden yolda sebat.", source: "Sahabe Hikmetlerinden" },
            { text: "√áaban kabul oldu.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "Niyet ve amel bereket getirir.", source: "Sahabe Hikmetlerinden" },
            { text: "Bug√ºn bir adƒ±m daha attƒ±n.", source: "Sahabe Hikmetlerinden" },
            { text: "ƒ∞yiye adƒ±m, k√∂t√ºl√ºkten uzak.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "ƒ∞stikametini koru.", source: "Sahabe Hikmetlerinden" },
            { text: "G√ºzel s√∂z, g√ºzel amel.", source: "Kur‚Äôan ilkelerine uygun √∂ƒü√ºt" },
            { text: "Gayret, kalbi diri tutar.", source: "Sahabe Hikmetlerinden" },
            { text: "Ta≈üƒ±dƒ±ƒüƒ±n emek, havuza d√∂k√ºld√º: bereket.", source: "Sahabe √ñrneƒüi (Metafor)" },
            { text: "G√ºn√ºn gayreti, yarƒ±nƒ±n umudu.", source: "Sahabe Hikmetlerinden" },
            { text: "Emek: g√∂r√ºnmeyen kahramanlƒ±k.", source: "Sahabe Hikmetlerinden" },
            { text: "≈û√ºk√ºr ve istikrar, yol arkada≈üƒ±n olsun.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayret, yolun rehberidir.", source: "Sahabe Hikmetlerinden" },
            { text: "Sabƒ±r ve sebatla ilerle.", source: "Sahabe Hikmetlerinden" },
            { text: "Bug√ºn bina y√ºkseldi.", source: "Sahabe √ñrneƒüi (Metafor)" },
            { text: "ƒ∞limle g√ºzelle≈üen amel.", source: "Sahabe Hikmetlerinden" }
        ];

        function showDailyCelebration() {
            const d = new Date(activeDateStr);
            const dayIndex = d.getDate() - 1;
            const monthOffset = d.getMonth() % 2; // vary a bit each month
            const idx = (dayIndex + monthOffset) % celebrationMessages.length;
            const textEl = document.getElementById('celebrate-text');
            const sourceEl = document.getElementById('celebrate-source');
            const auraEl = document.getElementById('celebrate-aura');
            const backdrop = document.getElementById('celebrate-backdrop');
            const msg = celebrationMessages[idx];
            if (textEl) textEl.textContent = msg.text;
            if (sourceEl) sourceEl.textContent = msg.source;
            if (auraEl) {
                auraEl.innerHTML = '';
                for (let i=0;i<16;i++) {
                    const dot = document.createElement('span');
                    dot.className = 'dot';
                    const dx = (Math.random()<0.5?-1:1) * (8 + Math.floor(Math.random()*10));
                    const dy = (Math.random()<0.5?-1:1) * (6 + Math.floor(Math.random()*8));
                    dot.style.left = Math.floor(Math.random()*95)+'%';
                    dot.style.top = Math.floor(Math.random()*95)+'%';
                    dot.style.setProperty('--dx', dx+'px');
                    dot.style.setProperty('--dy', dy+'px');
                    dot.style.animationDelay = (Math.random()*2)+'s';
                    auraEl.appendChild(dot);
                }
            }
            if (backdrop) backdrop.style.display = 'flex';
            launchFireworks();
            burstConfetti();
        }

        // Close celebration modal
        (function(){
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'celebrate-close') {
                    const backdrop = document.getElementById('celebrate-backdrop');
                    if (backdrop) backdrop.style.display = 'none';
                }
            });
        })();

        // Randomized fireworks
        function launchFireworks() {
            const fw = document.getElementById('fireworks');
            if (!fw) return;
            fw.innerHTML = '';
            const colors = ['#ffd166','#a6c1ee','#fbc2eb','#10b981','#60a5fa'];
            for (let i=0;i<24;i++) {
                const s = document.createElement('span');
                s.className = 'spark';
                const left = Math.floor(Math.random()*90)+5; // 5%-95%
                const top = Math.floor(Math.random()*40)+5;  // header area
                const fx = (Math.random()<0.5? -1:1) * (100 + Math.floor(Math.random()*80));
                const fy = - (120 + Math.floor(Math.random()*100));
                const sz = 3 + Math.floor(Math.random()*4);
                const dur = (1.2 + Math.random()*0.8)+'s';
                const col = colors[Math.floor(Math.random()*colors.length)];
                s.style.left = left+'%';
                s.style.top = top+'%';
                s.style.setProperty('--fx', fx+'px');
                s.style.setProperty('--fy', fy+'px');
                s.style.setProperty('--sz', sz+'px');
                s.style.setProperty('--dur', dur);
                s.style.setProperty('--col', col);
                fw.appendChild(s);
            }
        }

        // Lightweight confetti burst
        function burstConfetti() {
            const canvas = document.getElementById('confetti');
            if (!canvas) return;
            const modal = canvas.closest('.celebrate-modal');
            const rect = modal.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            const ctx = canvas.getContext('2d');
            const pieces = [];
            const cols = ['#f87171','#34d399','#60a5fa','#fbbf24','#a78bfa','#ec4899'];
            for (let i=0;i<120;i++) {
                pieces.push({
                    x: canvas.width/2 + (Math.random()*40-20),
                    y: canvas.height/3,
                    r: 2 + Math.random()*3,
                    c: cols[Math.floor(Math.random()*cols.length)],
                    vx: (Math.random()*2-1)*3,
                    vy: -(2 + Math.random()*3),
                    g: 0.06 + Math.random()*0.04,
                    a: 1
                });
            }
            let t = 0;
            function step() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += p.g; p.a -= 0.008;
                    ctx.globalAlpha = Math.max(0,p.a);
                    ctx.fillStyle = p.c;
                    ctx.beginPath();
                    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
                    ctx.fill();
                });
                t++;
                if (t<220) requestAnimationFrame(step);
                else { ctx.clearRect(0,0,canvas.width,canvas.height); }
            }
            step();
        }

        // Helper: show splash briefly when crossing thresholds
        function triggerSplashBurst(prefix, threshold, prev, current) {
            const el = document.querySelector(`#${prefix}-splash-${threshold}`);
            if (!el) return;
            const crossedUp = (prev || 0) < threshold && current >= threshold;
            if (!crossedUp) return;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 1200);
        }

        // Compute and update per-type daily success visuals
        function updateDailyTypeSuccess(type) {
            let tasks = lsGet(`tasks_daily_${activeDateStr}`, []);
            if ((!tasks || tasks.length === 0) && lsGet('history', {})[activeDateStr]) {
                tasks = lsGet('history', {})[activeDateStr];
            }
            const filtered = (tasks || []).filter(t => t.type === type);
            const { success: successRate } = computeSuccessFromTasks(filtered);
            const prefix = type === 'dunyevi' ? 'daily-dunyevi' : 'daily-ilmi';
            const rateEl = document.querySelector(`#${prefix}-success-rate`);
            const waterEl = document.querySelector(`#${prefix}-pool-water`);
            const cL = document.querySelector(`#${prefix}-carrier-left`);
            const cR = document.querySelector(`#${prefix}-carrier-right`);
            if (rateEl) rateEl.textContent = `${successRate}%`;
            if (waterEl) waterEl.style.height = `${successRate}%`;
            const dur = 4 - (successRate / 100) * 2;
            // Compute delta and set bucket CSS variables
            window.__lastRates = window.__lastRates || { dunyevi: 0, ilmi: 0, weekly: 0 };
            const prev = window.__lastRates[type] || 0;
            const delta = Math.abs(successRate - prev);
            const bucketL = cL ? cL.querySelector('.bucket') : null;
            const bucketR = cR ? cR.querySelector('.bucket') : null;
            const dropSize = `${Math.min(10, 6 + Math.floor(delta / 15))}px`;
            const dropTime = `${Math.max(500, 700 + delta * 10)}ms`;
            const arcX = `${Math.min(30, 22 + Math.floor(delta / 10))}px`;
            const arcY = `${-Math.min(28, 22 + Math.floor(delta / 10))}px`;
            if (bucketL) { bucketL.style.setProperty('--drop-size', dropSize); bucketL.style.setProperty('--drop-time', dropTime); bucketL.style.setProperty('--arc-x', arcX); bucketL.style.setProperty('--arc-y', arcY); }
            if (bucketR) { bucketR.style.setProperty('--drop-size', dropSize); bucketR.style.setProperty('--drop-time', dropTime); bucketR.style.setProperty('--arc-x', arcX); bucketR.style.setProperty('--arc-y', arcY); }
            // Stagger pours: left then right
            if (cL) { cL.style.animationDuration = `${dur}s`; setTimeout(() => cL.classList.add('pour'), 0); setTimeout(() => { cL.classList.remove('pour'); }, 900); }
            if (cR) { cR.style.animationDuration = `${dur}s`; setTimeout(() => cR.classList.add('pour'), 220); setTimeout(() => { cR.classList.remove('pour'); }, 1120); }
            const poolEl = waterEl ? waterEl.parentElement : null;
            if (poolEl) { poolEl.classList.add('ripple'); setTimeout(() => poolEl.classList.remove('ripple'), 650); }
            triggerSplashBurst(prefix, 25, prev, successRate);
            triggerSplashBurst(prefix, 50, prev, successRate);
            triggerSplashBurst(prefix, 75, prev, successRate);
            window.__lastRates[type] = successRate;

            // If both daily types reached 100%, trigger celebration (once per day)
            try {
                const rates = window.__lastRates || { dunyevi: 0, ilmi: 0 };
                const allDone = (rates.dunyevi === 100 && rates.ilmi === 100);
                const shownKey = `celebration_shown_${activeDateStr}`;
                if (allDone && !lsGet(shownKey, false)) {
                    showDailyCelebration();
                    lsSet(shownKey, true);
                }
            } catch (e) { /* no-op */ }
        }

        /**
         * Havuzdaki ilgili girdiyi d√ºzenlenen g√∂revle senkronize eder.
         * E≈üle≈ütirme √∂nceliƒüi: √∂nce eski ba≈ülƒ±kla, bulunamazsa mevcut ba≈ülƒ±kla.
         * G√ºnl√ºk i√ßin: title, subtasks, subtaskScoring, repetitionCount (varsayƒ±lan) senkronize edilir.
         * Haftalƒ±k i√ßin: title, subtasks, subtaskScoring (frequency dokunulmaz).
         */
        function syncTaskToPool(task, poolType, oldTitle = null) {
            try {
                const key = `pools_${poolType}`;
                const pool = lsGet(key, []);
                if (!Array.isArray(pool)) return;

                // ƒ∞lgili havuz girdisini bul
                let idx = -1;
                if (oldTitle) idx = pool.findIndex(p => p.title === oldTitle);
                if (idx === -1) idx = pool.findIndex(p => p.title === task.title);
                if (idx === -1) return; // Havuzda yoksa sessizce √ßƒ±k

                // Ortak alanlar
                pool[idx].title = task.title;
                pool[idx].subtasks = task.subtasks || [];
                pool[idx].subtaskScoring = task.subtaskScoring || 'grouped';

                // G√ºnl√ºk √∂zel: tekrar sayƒ±sƒ±
                if (poolType === 'dunyevi' || poolType === 'ilmi') {
                    pool[idx].repetitionCount = task.repetitionCount || 1;
                }

                lsSet(key, pool);
                loadPools();
            } catch (e) {
                console.error('Havuz senkronizasyon hatasƒ±:', e);
            }
        }
        
        /**
         * YENƒ∞: Ge√ßmi≈ü g√ºnleri modal'da g√∂sterir
         */
        function showHistoryModal() {
            const history = lsGet('history', {});
            const historyList = $("#history-list");
            const sortedDates = Object.keys(history).sort((a, b) => b.localeCompare(a)); // En yeni en √ºstte
            
            if (sortedDates.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500">G√∂sterilecek ge√ßmi≈ü g√ºn kaydƒ± yok.</p>';
                $("#history-modal").classList.remove('hidden');
                return;
            }
            
            historyList.innerHTML = "";
            sortedDates.forEach(date => {
                const tasks = history[date];
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const dateEl = document.createElement('div');
                dateEl.className = 'p-4 bg-gray-50 rounded-lg shadow-sm';
                const editable = daysDifferenceFromToday(date) >= 0; // Ge√ßmi≈ü/bug√ºn d√ºzenlenebilir
                dateEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-pink-500">${new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', day:'numeric', month:'long' })}</h4>
                            <p class="text-sm font-semibold text-green-600 mb-2">Ba≈üarƒ±: ${successRate}%</p>
                        </div>
                        <div>
                            ${editable ? `<button class="edit-day-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg">D√ºzenle</button>` : `<button class="bg-gray-200 text-gray-600 text-sm py-1 px-3 rounded-lg" disabled>Ar≈üiv</button>`}
                        </div>
                    </div>
                    <ul class="list-disc list-inside ml-2 mt-2">
                        ${tasks.map(t => `<li class="text-gray-700 ${t.status === 2 ? 'line-through' : ''} ${t.status === 0 ? 'opacity-60' : ''}">${t.title} (${t.type === 'ilmi' ? 'ƒ∞lmi' : 'D√ºnyevi'} - ${t.status === 2 ? 'Tamam' : (t.status === 1 ? 'Yarƒ±m' : 'Yapƒ±lmadƒ±')})</li>`).join('')}
                    </ul>
                `;

                if (editable) {
                    const btn = dateEl.querySelector('.edit-day-btn');
                    if (btn) btn.onclick = () => { setActiveDate(date); $("#history-modal").classList.add('hidden'); };
                }
                historyList.appendChild(dateEl);
            });
            
            $("#history-modal").classList.remove('hidden');
        }
        
        /**
         * YENƒ∞: Havuz konteyner ID'sinden havuz tipini d√∂nd√ºr√ºr
         */
        function poolTypeFromContainer(containerId) {
            if (containerId.includes('dunyevi')) return 'dunyevi';
            if (containerId.includes('ilmi')) return 'ilmi';
            if (containerId.includes('haftalik')) return 'haftalik';
            return null;
        }

        /**
         * Kullanƒ±cƒ±ya modal i√ßinde mesaj g√∂sterir
         */
        function showMessage(title, message) {
            const modalTitle = $("#modal-title");
            const modalMessage = $("#modal-message");
            const modal = $("#message-modal");

            if (modalTitle && modalMessage && modal) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.error("Modal elementleri bulunamadƒ±. Mesaj g√∂sterilemedi:", title, message);
            }
        }
        
        /**
         * Bir tarih objesinden hafta ID'si (YYYY-WW) olu≈üturur
         */
        function getWeekId(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`; // G√úNCELLENDƒ∞: W Eklendi
        }
        
        /**
         * Dosyayƒ± Base64 string'e √ßevirir (N√∂bet √ßizelgesi i√ßin)
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * YENƒ∞: Dosyayƒ± Base64 URL'ye (data:image/...) √ßevirir (Arka plan i√ßin)
         */
        function fileToBase64Url(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * YENƒ∞: G√ºnl√ºk Ayet/Hadis/S√∂z'√º ayarlar (ƒ∞stek 7)
         */
        function setDailyQuote() {
            try {
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                const index = dayOfYear % GUNLUK_SOZLER.length;
                
                const sozler = GUNLUK_SOZLER[index];

                $("#quote-ayet").textContent = `"${sozler.ayet.text}"`;
                $("#quote-ayet-source").textContent = `‚Äî ${sozler.ayet.source}`;
                
                $("#quote-hadis").textContent = `"${sozler.hadis.text}"`;
                $("#quote-hadis-source").textContent = `‚Äî ${sozler.hadis.source}`;
                
                $("#quote-soz").textContent = `"${sozler.soz.text}"`;
                $("#quote-soz-source").textContent = `‚Äî ${sozler.soz.source}`;

            } catch (error) {
                console.error("G√ºn√ºn s√∂z√º y√ºklenemedi:", error);
                $("#quote-ayet").textContent = "G√ºn√ºn s√∂z√º y√ºklenirken bir hata olu≈ütu.";
            }
        }
        
        /**
         * YENƒ∞: Ba≈ülangƒ±√ßta kayƒ±tlƒ± veya varsayƒ±lan arka planƒ± ayarlar
         */
        function setDailyBackground() {
            try {
                const savedBg = lsGet('settings_userBackground', null);
                if (savedBg) {
                    document.body.style.backgroundImage = `url('${savedBg}')`;
                } else {
                    // Kayƒ±tlƒ± bir ≈üey yoksa, varsayƒ±lanlardan ilkini ayarla
                    document.body.style.backgroundImage = `url('${DEFAULT_FALLBACK_BG}')`;
                }
            } catch (error) {
                console.error("Arka plan y√ºklenemedi:", error);
                document.body.style.backgroundColor = '#f3f4f6'; // bg-gray-100
            }
        }

        // --- YAPAY ZEKA VE YEREL Y√úKLEME FONKSƒ∞YONLARI ---
        
        /**
         * YENƒ∞: Yerel Dosya Y√ºkleme ƒ∞≈üleyicisi
         */
        async function handleLocalBackgroundUpload() {
            const fileInput = $("#local-bg-upload");
            const uploadStatus = $("#upload-status");
            if (fileInput.files.length === 0) {
                showMessage("Hata", "L√ºtfen √∂nce bilgisayarƒ±nƒ±zdan bir resim dosyasƒ± se√ßin.");
                return;
            }

            const file = fileInput.files[0];
            uploadStatus.textContent = "Y√ºkleniyor...";
            uploadStatus.classList.remove('hidden');

            try {
                // Dosyayƒ± Base64 URL'ye √ßevir (bu link hatalarƒ±nƒ± √ß√∂zer)
                const base64Url = await fileToBase64Url(file);
                
                // Arka planƒ± ayarla
                document.body.style.backgroundImage = `url('${base64Url}')`;
                lsSet('settings_userBackground', base64Url); // Base64 URL'yi kaydet

                showMessage("Ba≈üarƒ±lƒ±", "Yerel resminiz arka plan olarak ayarlandƒ± ve kaydedildi!");
            } catch (error) {
                console.error("Yerel arka plan y√ºkleme hatasƒ±:", error);
                showMessage("Y√ºkleme Hatasƒ±", "Resim y√ºklenirken bir hata olu≈ütu. L√ºtfen dosya tipini kontrol edin.");
            } finally {
                uploadStatus.classList.add('hidden');
            }
        }

        /**
         * N√∂bet √ßizelgesi resmini i≈üler (ƒ∞stek 8)
         * G√úNCELLENDƒ∞: Artƒ±k her √ßaƒürƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈üƒ±r ve rota adƒ±nƒ± kontrol eder.
         */
        async function processRota() {
            const fileInput = $("#rota-upload");
            
            // HATA D√úZELTMESƒ∞: Global referanslarƒ± kullan ve DOM'da bulunup bulunmadƒ±ƒüƒ±nƒ± kontrol et.
            if (!rotaLoader || !rotaOutput) {
                // Kritik DOM elemanlarƒ± y√ºkleme sƒ±rasƒ±nda alƒ±namadƒ±ysa bu hatayƒ± verir.
                console.error("processRota: Kritik DOM elemanlarƒ± (loader/output) y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.");
                showMessage("Hata", "N√∂bet aray√ºz√º tam y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.");
                return; 
            }
            
            // ƒ∞stek 2: Her zaman n√∂bet adƒ±nƒ± kontrol et
            const rotaName = lsGet('settings_rotaName', '').trim();
            const apiKey = lsGet('settings_apiKey', '');
            
            if (!apiKey) {
                showMessage("Hata", "Yapay zeka √∂zelliƒüini kullanmak i√ßin l√ºtfen 'Ayarlar' b√∂l√ºm√ºnden API anahtarƒ±nƒ±zƒ± girin.");
                return;
            }
            if (!rotaName) {
                showMessage("Hata", "L√ºtfen 'N√∂bet Takibi' b√∂l√ºm√ºnden aranacak bir isim girin.");
                return;
            }
            if (fileInput.files.length === 0) {
                showMessage("Hata", "L√ºtfen √∂nce bir resim dosyasƒ± se√ßin.");
                return;
            }

            const file = fileInput.files[0];
            const mimeType = file.type;
            
            // UI'ƒ± sƒ±fƒ±rla ve y√ºklemeyi ba≈ülat
            rotaLoader.classList.remove('hidden');
            rotaOutput.innerHTML = ""; // √ñnceki sonucu temizle
            
            try {
                const base64Data = await fileToBase64(file);
                const model = "gemini-2.5-flash-preview-09-2025";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: `Bu bir hastane n√∂bet √ßizelgesidir. G√∂r√ºnt√ºdeki '${rotaName}' ismine ait t√ºm n√∂bet g√ºnlerini tarihleri (GG.AA.YYYY formatƒ±nda) ve haftanƒ±n g√ºn√º (Pazartesi, Salƒ±, vb.) olarak √ßƒ±kar. Sadece bu ayƒ±n tarihlerini listele. N√∂betler arasƒ±ndaki bo≈ü g√ºn sayƒ±sƒ±nƒ± hesapla. Sonucu sade ve anla≈üƒ±lƒ±r bir liste olarak T√ºrk√ße ver.` },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API hatasƒ±: ${response.statusText}`);
                }
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
                
                // Sonucu yerel depolamaya kaydet
                lsSet('metadata_rotaInfo', {
                    text: text,
                    updatedAt: new Date().toISOString()
                });

            } catch (error) {
                console.error("N√∂bet i≈üleme hatasƒ±:", error);
                rotaOutput.innerHTML = `<p class="text-red-500">N√∂bet listesi i≈ülenemedi. ${error.message}</p>`;
            } finally {
                rotaLoader.classList.add('hidden');
            }
        }
        
        // --- YENƒ∞: VERƒ∞ YEDEKLEME FONKSƒ∞YONLARI ---

        /**
         * T√ºm uygulama verilerini (LS_PREFIX ile ba≈ülayan) bir JSON dosyasƒ± olarak indirir.
         */
        function exportData() {
            try {
                console.log("Veriler dƒ±≈üa aktarƒ±lƒ±yor...");
                const backupData = {};
                
                // localStorage'daki t√ºm anahtarlarƒ± dola≈ü
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Sadece bizim uygulamamƒ±za ait olanlarƒ± al
                    if (key.startsWith(LS_PREFIX)) {
                        // Deƒüer zaten lsSet tarafƒ±ndan stringify edildiƒüi i√ßin ham deƒüeri alƒ±yoruz.
                        backupData[key] = localStorage.getItem(key);
                    }
                }
                
                if (Object.keys(backupData).length === 0) {
                    showMessage("Bilgi", "Yedeklenecek hi√ßbir veri bulunamadƒ±.");
                    return;
                }

                // JSON verisini string'e √ßevir (okunaklƒ± olmasƒ± i√ßin 2 bo≈üluklu formatlama)
                const jsonString = JSON.stringify(backupData, null, 2);
                // Bir dosya "blob"u olu≈ütur
                const blob = new Blob([jsonString], { type: "application/json" });
                // Bu blob i√ßin ge√ßici bir URL olu≈ütur
                const url = URL.createObjectURL(blob);
                
                // ƒ∞ndirmeyi tetiklemek i√ßin g√∂r√ºnmez bir link (<a>) olu≈ütur
                const a = document.createElement('a');
                a.href = url;
                a.download = `ya-sahibez-zaman-yedek-${currentDayStr}.json`; // Dosya adƒ±
                document.body.appendChild(a); // Linki sayfaya ekle
                a.click(); // Linke tƒ±kla (indirmeyi ba≈ülat)
                document.body.removeChild(a); // Linki kaldƒ±r
                URL.revokeObjectURL(url); // Ge√ßici URL'yi temizle
                
                showMessage("Ba≈üarƒ±lƒ±", "T√ºm verileriniz JSON dosyasƒ± olarak indiriliyor.");
            } catch (error) {
                console.error("Dƒ±≈üa aktarma hatasƒ±:", error);
                showMessage("Hata", "Veriler dƒ±≈üa aktarƒ±lƒ±rken bir sorun olu≈ütu.");
            }
        }

        /**
         * Kullanƒ±cƒ±nƒ±n se√ßtiƒüi bir JSON yedek dosyasƒ±nƒ± okur ve localStorage'a geri y√ºkler.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // Kullanƒ±cƒ± dosya se√ßmekten vazge√ßti
            }
            
            const reader = new FileReader();
            
            // Dosya okuma tamamlandƒ±ƒüƒ±nda...
            reader.onload = function(e) {
                try {
                    const jsonString = e.target.result;
                    // Okunan metni JSON olarak ayrƒ±≈ütƒ±r
                    const backupData = JSON.parse(jsonString);
                    
                    if (Object.keys(backupData).length === 0) {
                        showMessage("Hata", "Yedek dosyasƒ± bo≈ü veya ge√ßersiz.");
                        return;
                    }

                    let validKeyFound = false;
                    
                    // JSON i√ßindeki her anahtar/deƒüer √ßifti i√ßin...
                    for (const key in backupData) {
                        // Eƒüer anahtar bizim √∂nekimizle ba≈ülƒ±yorsa (doƒüru dosya mƒ± diye kontrol)
                        if (key.startsWith(LS_PREFIX)) {
                            const value = backupData[key];
                            // Deƒüer (zaten string) doƒürudan localStorage'a yazƒ±lƒ±r.
                            localStorage.setItem(key, value);
                            validKeyFound = true;
                        }
                    }

                    if (!validKeyFound) {
                        showMessage("Hata", "Bu dosya, bu uygulamaya ait ge√ßerli bir yedek dosyasƒ± deƒüil.");
                        return;
                    }
                    
                    showMessage("Ba≈üarƒ±lƒ±", "Veriler ba≈üarƒ±yla geri y√ºklendi! Uygulama yenileniyor...");
                    
                    // Verilerin d√ºzg√ºn y√ºklenmesi i√ßin sayfayƒ± yeniden ba≈ülat
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // 2 saniye bekle (kullanƒ±cƒ± mesajƒ± g√∂rs√ºn)

                } catch (error) {
                    console.error("ƒ∞√ße aktarma hatasƒ±:", error);
                    showMessage("Hata", "Yedek dosyasƒ± okunurken bir hata olu≈ütu. Dosya bozuk veya JSON formatƒ±nda deƒüil.");
                } finally {
                    // Aynƒ± dosyayƒ± tekrar se√ßebilmek i√ßin input'u sƒ±fƒ±rla
                    event.target.value = null;
                }
            };
            
            // Dosyayƒ± metin olarak oku
            reader.readAsText(file);
        }

    </script>
</body>
</html>