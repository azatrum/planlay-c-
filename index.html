<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya Sahibez Zaman</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter ve sÃ¼slÃ¼ bir font) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <!-- YENÄ°: Chart.js KÃ¼tÃ¼phanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Ã–zel stiller */
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }

        /* UI Ã¶lÃ§ek deÄŸiÅŸkenleri */
        :root {
            --task-font-scale: 1;
            --task-checkbox-scale: 1;
        }
        /* GÃ¶rev Ã¶ÄŸelerinde Ã¶lÃ§ek uygulamasÄ± */
        .task-item { font-size: calc(0.95rem * var(--task-font-scale)); }
        .task-item .text-sm { font-size: calc(0.875rem * var(--task-font-scale)); }
        .task-item .text-xs { font-size: calc(0.75rem * var(--task-font-scale)); }
        /* GÃ¼nlÃ¼k tekrar ve haftalÄ±k tik kutularÄ± */
        .repetition-checkbox, .weekly-checkbox { transform: scale(var(--task-checkbox-scale)); transform-origin: left center; }
        /* Havuz ve modal iÃ§indeki kÃ¼Ã§Ã¼k metinler de Ã¶lÃ§eklensin */
        .pool-item { font-size: calc(0.95rem * var(--task-font-scale)); }

        /* BaÅŸlÄ±k iÃ§in sÃ¼slÃ¼ font */
        .fancy-title {
            font-family: 'Dancing Script', cursive;
        }

        /* YarÄ± saydam arka planlar (Ä°stek 13) */
        .glass-bg {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* GÃ¶rev kutucuklarÄ± iÃ§in sarmaÅŸÄ±k/Ã§iÃ§ek benzeri kenarlÄ±k (Ä°stek 15) */
        .task-box, .pool-box {
            border: 2px solid;
            border-image-slice: 1;
            border-width: 2px;
            border-image-source: linear-gradient(to right, #fbc2eb, #a6c1ee);
            transition: all 0.3s ease;
        }

        /* YENÄ°: Ana kutucuklar iÃ§in dinamik hover (Ä°stek 1) */
        .task-box:hover, .pool-box:hover {
            transform: scale(1.01); /* Hafif bÃ¼yÃ¼me */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Hafif gÃ¶lge */
        }

        /* YENÄ°: Temel gÃ¶rev/havuz item stilleri (Ä°stek 14/2) */
        .task-item, .pool-item {
            transition: all 0.2s ease-in-out; /* HÄ±zlandÄ±rÄ±ldÄ± */
            opacity: 0.95; /* Hafif soluk */
        }

        /* Hover efekti (Ä°stek 14 / GÃœNCELLENDÄ°) */
        .task-item:hover, .pool-item:hover {
            transform: scale(1.04); /* Biraz daha bÃ¼yÃ¼tÃ¼ldÃ¼ */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); /* GÃ¶lge belirginleÅŸtirildi */
            opacity: 1; /* Tam opak */
            z-index: 10; /* Ãœste Ã§Ä±ksÄ±n */
            position: relative; /* Hover anÄ±nda Ã¼ste Ã§Ä±ksÄ±n */
        }
        
        /* Havuz itemlerine Ã¶zel (tÄ±klanabilir hissi iÃ§in) (Ä°stek 2) */
        .pool-item {
            cursor: pointer;
        }
        
        /* GÃ¶rev durumu ikonlarÄ± (Ä°stek 4) */
        .status-btn {
            cursor: pointer;
            font-size: 1.5rem; /* 24px */
            transition: transform 0.2s;
        }
        .status-btn:hover {
            transform: scale(1.2);
        }
        /* 0: YapÄ±lmadÄ± (BoÅŸ), 1: YarÄ±m (Ay), 2: Tam (GÃ¼neÅŸ/YÄ±ldÄ±z) */
        .status-0::before { content: 'ğŸ”²'; color: #cbd5e1; }
        .status-1::before { content: 'ğŸŒ—'; color: #f59e0b; }
        .status-2::before { content: 'âœ…'; color: #10b981; }

        /* YÃ¼kleme gÃ¶stergesi (Spinner) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a6c1ee;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ã–zel KaydÄ±rma Ã‡ubuÄŸu */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #fbc2eb, #a6c1ee);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            transform: scale(1.05);
        }

        /* YENÄ°: Arka plan galeri stilleri */
        .bg-thumbnail {
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem; /* 8px */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .bg-thumbnail:hover {
            transform: scale(1.05);
            border-color: #fbc2eb; /* Pembe */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* YENÄ°: Tema Kategori ButonlarÄ± */
        .theme-btn {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #374151; /* gray-700 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .theme-btn:hover {
            background-color: white;
            color: #db2777; /* pink-600 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Havuz butonu Ã¶zel animasyonlu stil */
        .pool-open-btn {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: white;
            font-weight: 700;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            box-shadow: 0 10px 25px rgba(166, 193, 238, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-position 0.25s ease;
            background-size: 200% 200%;
            background-position: 50% 50%;
        }
        .pool-open-btn:hover {
            transform: scale(1.08);
            background-position: 100% 0%;
            box-shadow: 0 14px 32px rgba(251, 194, 235, 0.45);
        }

        /* 2D Havuz ve TaÅŸÄ±yÄ±cÄ± AnimasyonlarÄ± */
        .progress-scene { position: relative; min-height: 140px; }
        .pool {
            position: relative; width: 180px; height: 90px;
            border: 3px solid rgba(0,0,0,0.08);
            border-radius: 0.75rem 0.75rem 1.2rem 1.2rem;
            overflow: hidden; margin: 0 auto;
            background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.9));
        }
        .pool-water { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.6s ease; }
        .pool-water.daily { background: linear-gradient(180deg, rgba(16,185,129,0.7), rgba(16,185,129,0.9)); }
        .pool-water.weekly { background: linear-gradient(180deg, rgba(59,130,246,0.7), rgba(59,130,246,0.9)); }
        .carrier { position: absolute; bottom: 0; font-size: 1.6rem; animation: 4s ease-in-out infinite; display: inline-flex; align-items: center; gap: 6px; }
        .carrier-left { left: 0; animation-name: walk-left; }
        .carrier-right { right: 0; animation-name: walk-right; }
        /* SaÄŸdaki karakterin kovasÄ± havuza doÄŸru atsÄ±n (sola) */
        .carrier-right .bucket::after { --arc-x: -22px; }
        @keyframes walk-left { 0%{transform:translateX(0)} 50%{transform:translateX(40%)} 100%{transform:translateX(0)} }
        @keyframes walk-right { 0%{transform:translateX(0)} 50%{transform:translateX(-40%)} 100%{transform:translateX(0)} }

        /* Bucket + pour arc */
        .bucket { width: 16px; height: 16px; border: 2px solid #4fd1c5; border-top-color: transparent; border-radius: 3px; position: relative; display: inline-block; overflow: visible; }
        /* Kovadaki su dolgusu (atmadan Ã¶nce gÃ¶rÃ¼nÃ¼r, atarken boÅŸalÄ±r) */
        .bucket::before { content: ""; position: absolute; left: 1px; right: 1px; bottom: 1px; height: var(--bucket-fill, 70%); background: linear-gradient(180deg, rgba(79,209,197,0.9), rgba(79,209,197,0.7)); border-radius: 2px; transition: height 350ms ease, opacity 200ms ease; }
        .carrier.pour .bucket::before { height: 8%; opacity: 0.6; }
        .bucket::after { content: ""; position: absolute; right: -4px; top: 2px; width: var(--drop-size,6px); height: var(--drop-size,6px); border-radius: 50%; background: #4fd1c5; opacity: 0; transform: translate(0,0); }
        .carrier.pour .bucket { transform: rotate(-12deg); transition: transform 200ms ease; }
        .carrier.pour .bucket::after { opacity: 1; animation: drop-arc var(--drop-time,700ms) ease-in forwards; }
        /* Damla, havuza her zaman ulaÅŸsÄ±n; yÃ¶n deÄŸiÅŸkeni ile gÃ¼dÃ¼mlÃ¼ */
        @keyframes drop-arc { 0% { transform: translate(0,0); opacity: 1; } 60% { transform: translate(var(--arc-x,22px),var(--arc-y,-22px)); opacity: 1; } 100% { transform: translate(calc(var(--arc-x,22px)*2.6),0); opacity: 0; } }
        .pool::before { content: ""; position: absolute; left: 50%; bottom: 6px; width: 0; height: 0; border-radius: 50%; background: radial-gradient(circle, rgba(79,209,197,0.45), rgba(79,209,197,0.2)); transform: translateX(-50%); opacity: 0; }
        .pool.ripple::before { animation: ripple 900ms cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes ripple { 0% { width: 0; height: 0; opacity: 0.85; transform: translateX(-50%) scale(0.9); } 50% { opacity: 0.6; } 100% { width: 160px; height: 56px; opacity: 0; transform: translateX(-50%) scale(1.02); } }
        /* GÃ¼dÃ¼mlÃ¼ su damlasÄ± (kovadan havuza doÄŸru) */
        .guided-stream { position: absolute; width: 6px; height: 6px; border-radius: 50%; opacity: 0; pointer-events: none; }
        .guided-stream.daily { background: #10b981; }
        .guided-stream.weekly { background: #3b82f6; }
        .guided-stream.ilmi { background: #6366f1; }

        /* Damla animasyonu (havuz Ã¼zerine dÃ¼ÅŸen su) */
        .droplet-container { position: absolute; top: 0; left: 50%; width: 120px; height: 90px; transform: translateX(-50%); pointer-events: none; }
        .droplet { position: absolute; top: -10px; width: 8px; height: 12px; background: rgba(59,130,246,0.8); border-radius: 50% 50% 60% 60%; opacity: 0.0; animation: drop 1.6s linear infinite; }
        .droplet.green { background: rgba(16,185,129,0.8); }
        @keyframes drop { 0%{ top:-10px; opacity:0 } 20%{ opacity:1 } 80%{ opacity:1 } 100%{ top:70px; opacity:0 } }

        /* EÅŸiklerde sÄ±Ã§rama animasyonu */
        .splash-container { position: absolute; bottom: 0; left: 50%; width: 160px; height: 40px; transform: translateX(-50%); pointer-events: none; }
        .splash { position: absolute; bottom: 0; width: 6px; height: 6px; background: rgba(59,130,246,0.85); border-radius: 50%; opacity: 0; }
        .splash.green { background: rgba(16,185,129,0.85); }
        .splash.show { animation: splashUp 0.9s ease-out forwards; }
        @keyframes splashUp {
            0% { transform: translateY(0) scale(0.6); opacity: 0.0; }
            30% { opacity: 1; }
            60% { transform: translateY(-16px) scale(1.2); opacity: 1; }
            100% { transform: translateY(0) scale(0.8); opacity: 0; }
        }

        /* Celebration Modal */
        .celebrate-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .celebrate-modal { position: relative; width: 90%; max-width: 640px; background: linear-gradient(180deg, #fff, #fff7fb); border: 2px solid #fbc2eb; border-radius: 1rem; box-shadow: 0 20px 60px rgba(166,193,238,0.35); overflow: hidden; }
        .celebrate-header { background: linear-gradient(135deg, #fbc2eb, #a6c1ee); color: white; padding: 14px 18px; font-weight: 800; font-size: 1.35rem; letter-spacing: 0.5px; display:flex; align-items:center; justify-content:space-between; }
        .celebrate-body { padding: 16px; }
        .celebrate-message { position: relative; font-size: 1.1rem; color: #374151; line-height: 1.7; background: #fff; border: 1px solid #f3e8ff; border-radius: 0.75rem; padding: 12px 14px; box-shadow: 0 8px 20px rgba(166,193,238,0.18); }
        .celebrate-source { margin-top: 8px; font-size: 0.9rem; color: #6b7280; }
        /* Aura sparks orbiting the message */
        .aura { position: absolute; inset: -8px; pointer-events: none; }
        .aura .dot { position: absolute; width: 4px; height: 4px; border-radius: 50%; background: radial-gradient(circle,#fff,#fbc2eb); opacity: 0.0; animation: drift 6s ease-in-out infinite; }
        .aura .dot:nth-child(3n){ background: radial-gradient(circle,#fff,#a6c1ee); }
        @keyframes drift {
            0% { transform: translate(0,0); opacity: 0; }
            10% { opacity: 0.6; }
            50% { transform: translate(var(--dx, 12px), var(--dy, -8px)); opacity: 0.9; }
            100% { transform: translate(0,0); opacity: 0; }
        }
        .celebrate-close { position: absolute; top: 8px; right: 12px; color: #fff; font-weight: 700; cursor: pointer; }
        /* Fireworks */
        .fireworks { position: absolute; inset: 0; pointer-events: none; overflow:hidden; }
        .spark { position: absolute; width: var(--sz,4px); height: var(--sz,4px); background: var(--col,#ffd166); border-radius: 50%; opacity: 0; animation: pop var(--dur,1.6s) ease-out forwards; }
        @keyframes pop { 0% { transform: translate(0,0) scale(0.8); opacity: 0; } 18% { opacity: 1; } 60% { transform: translate(var(--fx, 120px), var(--fy, -160px)) scale(1.2); opacity: 1; } 100% { opacity: 0; }
        }
        /* Candles */
        .candles { display: flex; gap: 12px; justify-content: center; margin-top: 12px; }
        .candle { width: 10px; height: 32px; background: #ffe5b4; border-radius: 3px; position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .candle::before { content: ""; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 8px; height: 10px; background: radial-gradient(circle at 50% 60%, #fff59d, #ffcc80); border-radius: 50%; filter: blur(0.5px); animation: flicker 1.2s ease-in-out infinite; }
        @keyframes flicker { 0%,100% { transform: translateX(-50%) scale(1); opacity: 1; } 50% { transform: translateX(-50%) scale(1.08); opacity: 0.85; } }
        /* Confetti Canvas */
        #confetti { position:absolute; inset:0; pointer-events:none; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-4 max-w-screen-2xl">
        
        <!-- BaÅŸlÄ±k ve Tarih -->
        <header class="text-center my-6">
            <h1 class="fancy-title text-6xl font-bold text-pink-500 drop-shadow-md">Ya Sahibez Zaman</h1>
            <p id="current-date" class="text-xl text-gray-600 mt-2"></p>
            <div class="flex items-center justify-center gap-3 mt-2">
                <button id="prev-day-btn" class="bg-white/80 hover:bg-white text-gray-700 font-bold py-1 px-3 rounded-lg shadow-sm">â—€</button>
                <div id="active-date-label" class="text-sm text-gray-600"></div>
                <button id="next-day-btn" class="bg-white/80 hover:bg-white text-gray-700 font-bold py-1 px-3 rounded-lg shadow-sm">â–¶</button>
                <button id="open-pool-btn" class="pool-open-btn ml-3" title="GÃ¶rev Havuzunu AÃ§">GÃ¶rev Havuzu</button>
            </div>
        </header>

        <!-- Ana Ä°Ã§erik IzgarasÄ± -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Sol/Orta Panel (GÃ¶revler) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- GeÃ§miÅŸ GÃ¼nler Butonu -->
                <div class="flex justify-start gap-3">
                    <button id="show-history-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        GeÃ§miÅŸ GÃ¼nler
                    </button>
                    <button id="show-stats-btn" class="bg-indigo-400 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        ğŸ“Š Analiz
                    </button>
                </div>

                <!-- BaÅŸarÄ± OranlarÄ± Ã¼st ÅŸerit kaldÄ±rÄ±ldÄ±; baÅŸarÄ± havuzlarÄ± sÃ¼tun baÅŸlÄ±klarÄ±na taÅŸÄ±ndÄ± -->

                <!-- GÃ¶rev DÃ¼zenleme Modal (Yeni) -->
                <div id="task-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                        <h3 class="text-2xl font-bold text-pink-600 mb-4">GÃ¶revi DÃ¼zenle</h3>
                        
                        <div class="space-y-4">
                            <!-- GÃ¶rev AdÄ± -->
                            <div>
                                <label class="block text-sm font-semibold mb-1">GÃ¶rev AdÄ±</label>
                                <input type="text" id="edit-task-title" placeholder="GÃ¶rev adÄ±..." class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>

                            <!-- Tekrar SayÄ±sÄ± (sadece gÃ¼nlÃ¼k gÃ¶revler iÃ§in) -->
                            <div id="edit-repetition-section" class="hidden">
                                <label class="block text-sm font-semibold mb-1">GÃ¼nde KaÃ§ Defa YapÄ±lsÄ±n?</label>
                                <input type="number" id="edit-task-repetition" min="1" value="1" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>

                            <!-- Alt GÃ¶revler -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold">Alt GÃ¶revler (Opsiyonel)</label>
                                    <button id="add-subtask-btn" class="text-sm bg-green-400 hover:bg-green-500 text-white px-3 py-1 rounded">+ Alt GÃ¶rev Ekle</button>
                                </div>
                                <div id="edit-subtasks-list" class="space-y-2 ml-2 border-l-2 border-pink-200 pl-3">
                                    <p class="text-gray-400 italic text-sm">Alt gÃ¶rev eklenmedi</p>
                                </div>
                            </div>

                            <!-- Alt GÃ¶revlerin PuanlandÄ±rÄ±lmasÄ± (sadece alt gÃ¶rev varsa gÃ¶rÃ¼n) -->
                            <div id="edit-subtask-scoring-section" class="hidden p-3 bg-pink-50 rounded-lg border border-pink-200">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="subtask-scoring" value="grouped" checked class="w-4 h-4">
                                    <span class="text-sm">Alt gÃ¶revlerin hepsi birlikte 1 puan ver (gÃ¶revin parÃ§alarÄ±)</span>
                                </label>
                                <label class="flex items-center space-x-2 mt-2">
                                    <input type="radio" name="subtask-scoring" value="individual" class="w-4 h-4">
                                    <span class="text-sm">Her alt gÃ¶rev ayrÄ± ayrÄ± puan ver (baÄŸÄ±msÄ±z gÃ¶revler)</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button id="edit-task-cancel-btn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Ä°ptal</button>
                            <button id="edit-task-save-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Kaydet</button>
                        </div>
                    </div>
                </div>

                

            </div>

            <!-- SaÄŸ Panel (KÃ¼meler ve DiÄŸerleri) -->
            <div class="lg:col-span-1 space-y-6">

                

                <!-- Ali Murtaza KoÃ§ak NÃ¶bet Takibi (Ä°stek 8) - GÃœNCELLENDÄ° -->
                <div id="rota-card" class="glass-bg pool-box rounded-xl shadow-lg p-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-3">NÃ¶bet Takibi</h2>
                    
                    <!-- YENÄ°: NÃ¶bet ismi giriÅŸi -->
                    <div class="mb-3">
                        <label for="rota-name-input" class="text-sm font-medium text-gray-600">Ã‡izelgede Aranacak Ä°sim (Ä°stek 3)</label>
                        <input type="text" id="rota-name-input" placeholder="Ã–rn: Ali Murtaza KoÃ§ak" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                    </div>

                    <p class="text-sm mb-3">NÃ¶bet listesini (resim) yÃ¼kleyin:</p>
                    <input type="file" id="rota-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
                    <button id="rota-process-btn" class="w-full mt-3 bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        NÃ¶betleri Ä°ÅŸle
                    </button>
                    <div id="rota-output" class="mt-4 p-3 bg-white/70 rounded-lg min-h-[50px]">
                        <p class="text-gray-500 text-sm">KaydedilmiÅŸ nÃ¶bet bilgisi yok veya yeni liste yÃ¼klenmedi.</p>
                        <!-- YÃ¼kleniyor ikonu -->
                        <div id="rota-loader" class="hidden loader mx-auto my-2"></div>
                    </div>
                </div>

                
            </div>

        </main>

        <!-- ÃœÃ§ SÃ¼tun GÃ¶rev Takip AlanÄ± -->
        <section class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- GÃ¼nlÃ¼k DÃ¼nyevi -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border border-blue-300">
                <div class="flex items-center justify-between mb-3 bg-gradient-to-r from-blue-100 to-blue-50 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ¡</span>
                        <h2 class="text-2xl font-bold text-blue-700">DÃ¼nyevi GÃ¶revler</h2>
                    </div>
                    <span class="text-xs font-semibold text-blue-700 bg-white/70 rounded-full px-2 py-1 shadow-sm">GÃ¼nlÃ¼k</span>
                </div>
                <!-- DÃ¼nyevi BaÅŸarÄ± Havuzu (sÃ¼tunla hizalÄ±) -->
                <div class="progress-scene mb-3">
                    <div id="daily-dunyevi-carrier-left" class="carrier carrier-left"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div id="daily-dunyevi-carrier-right" class="carrier carrier-right"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="daily-dunyevi-pool-water" class="pool-water daily"></div>
                        <div class="droplet-container">
                            <span class="droplet green" style="left:10px; animation-delay:0s"></span>
                            <span class="droplet green" style="left:40px; animation-delay:0.4s"></span>
                            <span class="droplet green" style="left:70px; animation-delay:0.8s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="daily-dunyevi-splash-25" class="splash green" style="left:20px"></span>
                            <span id="daily-dunyevi-splash-50" class="splash green" style="left:60px"></span>
                            <span id="daily-dunyevi-splash-75" class="splash green" style="left:100px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-green-900/80">
                        <span id="daily-dunyevi-success-rate">0%</span>
                    </div>
                </div>
                <div id="dunyevi-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-dunyevi-btn" class="text-2xl text-blue-600 hover:scale-110 transition">ï¼‹</button>
                    <input type="text" id="add-dunyevi-input" placeholder="Yeni dÃ¼nyevi gÃ¶rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <input type="number" id="add-dunyevi-count" min="1" value="1" title="GÃ¼nde kaÃ§ kez" class="hidden w-16 ml-2 p-2 border rounded-lg">
                    <button id="add-dunyevi-confirm" class="hidden ml-2 px-3 py-2 bg-blue-600 text-white rounded">Ekle</button>
                </div>
            </div>
            <!-- GÃ¼nlÃ¼k Ä°lmi -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border border-purple-300">
                <div class="flex items-center justify-between mb-3 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg px-3 py-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ“š</span>
                        <h2 class="text-2xl font-bold text-purple-700">Ä°lmi GÃ¶revler</h2>
                    </div>
                    <span class="text-xs font-semibold text-purple-700 bg-white/70 rounded-full px-2 py-1 shadow-sm">GÃ¼nlÃ¼k</span>
                </div>
                <!-- Ä°lmi BaÅŸarÄ± Havuzu (sÃ¼tunla hizalÄ±) -->
                <div class="progress-scene mb-3">
                    <div id="daily-ilmi-carrier-left" class="carrier carrier-left"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div id="daily-ilmi-carrier-right" class="carrier carrier-right"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="daily-ilmi-pool-water" class="pool-water daily"></div>
                        <div class="droplet-container">
                            <span class="droplet indigo" style="left:10px; animation-delay:0.1s"></span>
                            <span class="droplet indigo" style="left:45px; animation-delay:0.5s"></span>
                            <span class="droplet indigo" style="left:80px; animation-delay:0.9s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="daily-ilmi-splash-25" class="splash indigo" style="left:20px"></span>
                            <span id="daily-ilmi-splash-50" class="splash indigo" style="left:60px"></span>
                            <span id="daily-ilmi-splash-75" class="splash indigo" style="left:100px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-indigo-900/80">
                        <span id="daily-ilmi-success-rate">0%</span>
                    </div>
                </div>
                <div id="ilmi-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-ilmi-btn" class="text-2xl text-purple-600 hover:scale-110 transition">ï¼‹</button>
                    <input type="text" id="add-ilmi-input" placeholder="Yeni ilmi gÃ¶rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <input type="number" id="add-ilmi-count" min="1" value="1" title="GÃ¼nde kaÃ§ kez" class="hidden w-16 ml-2 p-2 border rounded-lg">
                    <button id="add-ilmi-confirm" class="hidden ml-2 px-3 py-2 bg-purple-600 text-white rounded">Ekle</button>
                </div>
            </div>
            <!-- HaftalÄ±k -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-4 border-green-300">
                <div class="flex flex-col mb-2 bg-gradient-to-r from-green-100 to-green-50 rounded-lg px-2 py-2">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ—“ï¸</span>
                            <h2 class="text-xl font-bold text-green-700">HaftalÄ±k</h2>
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="weekly-prev-btn" class="text-[10px] leading-none font-semibold text-green-700 bg-white/70 rounded-full px-2 py-1 shadow-sm hover:bg-white" title="Ã–nceki Hafta">â†</button>
                            <button id="weekly-jump-current" class="text-[10px] leading-none font-semibold text-green-700 bg-white/70 rounded-full px-2 py-1 shadow-sm hover:bg-white" title="Bu Hafta">â—</button>
                            <button id="weekly-next-btn" class="text-[10px] leading-none font-semibold text-green-700 bg-white/70 rounded-full px-2 py-1 shadow-sm hover:bg-white" title="Sonraki Hafta">â†’</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <span id="weekly-date-range" class="text-[11px] font-medium text-green-800">Pazartesi - Pazar</span>
                    </div>
                </div>
                <!-- HaftalÄ±k BaÅŸarÄ± Havuzu (sÃ¼tunla hizalÄ±) -->
                <div class="progress-scene mb-3">
                    <div id="weekly-carrier-left" class="carrier carrier-left"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div id="weekly-carrier-right" class="carrier carrier-right"><span>ğŸ§•</span><span class="bucket"></span></div>
                    <div class="mx-auto pool">
                        <div id="weekly-pool-water" class="pool-water weekly"></div>
                        <div class="droplet-container">
                            <span class="droplet" style="left:20px; animation-delay:0.2s"></span>
                            <span class="droplet" style="left:60px; animation-delay:0.6s"></span>
                            <span class="droplet" style="left:90px; animation-delay:1s"></span>
                        </div>
                        <div class="splash-container">
                            <span id="weekly-splash-25" class="splash" style="left:25px"></span>
                            <span id="weekly-splash-50" class="splash" style="left:80px"></span>
                            <span id="weekly-splash-75" class="splash" style="left:120px"></span>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-xs text-blue-900/80">
                        <span id="weekly-success-rate">0%</span>
                    </div>
                </div>
                <div id="haftalik-tasks-col" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
                <div class="mt-3 flex items-center gap-2">
                    <button id="add-haftalik-btn" class="text-2xl text-green-600 hover:scale-110 transition">ï¼‹</button>
                    <input type="text" id="add-haftalik-input" placeholder="Yeni haftalÄ±k gÃ¶rev..." class="hidden flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-300">
                    <input type="number" id="add-haftalik-count" min="1" value="1" title="Haftada kaÃ§ kez" class="hidden w-20 ml-2 p-2 border rounded-lg">
                    <button id="add-haftalik-confirm" class="hidden ml-2 px-3 py-2 bg-green-600 text-white rounded">Ekle</button>
                </div>
            </div>
        </section>

        <!-- Celebration Modal -->
        <div id="celebrate-backdrop" class="celebrate-backdrop">
            <div class="celebrate-modal">
                <div class="celebrate-header">
                    <span>Tebrikler! GÃ¼nÃ¼n TÃ¼m GÃ¶revleri TamamlandÄ± ğŸ‰</span>
                    <button id="celebrate-close" class="celebrate-close">âœ•</button>
                </div>
                <div class="celebrate-body">
                    <div id="celebrate-message" class="celebrate-message">
                        <div class="aura" id="celebrate-aura"></div>
                        <div id="celebrate-text"></div>
                        <div id="celebrate-source" class="celebrate-source"></div>
                    </div>
                    <div class="candles">
                        <div class="candle"></div>
                        <div class="candle"></div>
                        <div class="candle"></div>
                    </div>
                    <canvas id="confetti"></canvas>
                    <div class="fireworks" id="fireworks"></div>
                </div>
            </div>
        </div>

        <!-- GÃ¶rsel ayÄ±rÄ±cÄ± -->
        <hr class="mt-8 border-gray-300">
        <!-- Alt ikili bÃ¶lÃ¼m: NÃ¶bet ve GÃ¼nÃ¼n SÃ¶zÃ¼ yan yana -->
        <section id="bottom-duo" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></section>

        <!-- Alt BÃ¶lÃ¼m -->
        <footer class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- GÃ¼nÃ¼n SÃ¶zÃ¼ (Ä°stek 7) - YER DEÄÄ°ÅTÄ°RDÄ° (Ä°stek 1) -->
            <div id="quote-box" class="glass-bg task-box rounded-xl shadow-lg p-6 min-h-[150px] flex flex-col justify-center space-y-4">
                <!-- Ayet -->
                <div class="text-center">
                    <p id="quote-ayet" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-ayet-source" class="text-md font-semibold text-pink-500 mt-1">â€” ...</p>
                </div>
                <hr class="border-pink-200">
                <!-- Hadis -->
                <div class="text-center">
                    <p id="quote-hadis" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-hadis-source" class="text-md font-semibold text-blue-500 mt-1">â€” ...</p>
                </div>
                <hr class="border-blue-200">
                <!-- GÃ¼zel SÃ¶z -->
                <div class="text-center">
                    <p id="quote-soz" class="text-lg italic text-gray-700">"..."</p>
                    <p id="quote-soz-source" class="text-md font-semibold text-purple-500 mt-1">â€” ...</p>
                </div>
            </div>

            <!-- Arka Plan Galerisi (Ä°stek 16) - YER DEÄÄ°ÅTÄ°RDÄ° (Ä°stek 1) -->
            <div class="glass-bg task-box rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-3 text-pink-600">Arka Plan Galerisi</h3>
                
                <!-- YENÄ°: Yerel Dosya YÃ¼kleme KÄ±smÄ± -->
                <div class="mb-4 p-3 bg-pink-50 rounded-lg border border-pink-100">
                    <h4 class="font-semibold text-pink-600 mb-2">Bilgisayardan Arka Plan SeÃ§</h4>
                    <input type="file" id="local-bg-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-200 file:text-pink-800 hover:file:bg-pink-300">
                    <button id="upload-bg-btn" class="w-full mt-3 bg-purple-400 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                        Arka PlanÄ± YÃ¼kle ve Kaydet
                    </button>
                    <p id="upload-status" class="text-xs text-gray-500 mt-2 hidden">YÃ¼kleniyor...</p>
                </div>

                <p class="text-sm text-gray-600 mb-2">Veya hazÄ±r (stabil) temalardan birini seÃ§in:</p>
                
                <!-- Statik arka plan seÃ§ici galeri -->
                <div id="bg-results-grid" class="grid grid-cols-3 gap-2 h-64 overflow-y-auto pr-2">
                    <!-- Arka planlar buraya JavaScript ile yÃ¼klenecek -->
                </div>
            </div>
            
            <!-- Ayarlar (AI/NÃ¶bet) - YER DEÄÄ°ÅTÄ°RDÄ° (Ä°stek 1) -->
            <div class="glass-bg pool-box rounded-xl shadow-lg p-4">
                <h2 class="text-2xl font-bold text-gray-700 mb-3">Ayarlar (AI/NÃ¶bet)</h2>
                <div class="space-y-3">
                    <div>
                        <label for="api-key-input" class="text-sm font-medium text-gray-600">Google AI API AnahtarÄ±</label>
                        <input type="password" id="api-key-input" placeholder="API AnahtarÄ±nÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n..." class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button id="api-key-save-btn" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            AnahtarÄ± Kaydet
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 italic">API AnahtarÄ±, nÃ¶bet listesi okuma iÃ§in gereklidir.</p>
                </div>

                <!-- YENÄ°: Veri Yedekleme BÃ¶lÃ¼mÃ¼ -->
                <hr class="my-4 border-pink-200">
                <div>
                    <h4 class="text-sm font-medium text-gray-600 mb-2">Veri Yedekleme</h4>
                    <p class="text-xs text-gray-500 italic mb-2">TÃ¼m gÃ¶revlerinizi ve ayarlarÄ±nÄ±zÄ± bir dosyaya yedekleyin veya yedeÄŸi geri yÃ¼kleyin.</p>
                    <div class="flex gap-2">
                        <button id="export-data-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri DÄ±ÅŸa Aktar (Yedekle)
                        </button>
                        <button id="import-data-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300">
                            Verileri Ä°Ã§e Aktar (Geri YÃ¼kle)
                        </button>
                    </div>
                    <!-- Ä°Ã§e aktarma iÃ§in gizli dosya giriÅŸi -->
                    <input type="file" id="import-file-input" class="hidden" accept=".json, .txt">
                </div>
                <!-- / Veri Yedekleme BÃ¶lÃ¼mÃ¼ -->

            </div>


        </footer>
    </div>
    
    <!-- Modal (Mesajlar iÃ§in) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="modal-close-btn" class="bg-pink-400 hover:bg-pink-500 text-white font-bold py-2 px-6 rounded-lg">Kapat</button>
        </div>
    </div>
    
    <!-- GÃ¶rev Havuzu Modal -->
    <div id="pool-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-pink-600">GÃ¶rev Havuzu</h3>
                <button id="pool-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="flex border-b border-gray-300 mb-4">
                <button class="pool-tab-btn active-tab py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600" data-pool-tab="modal-dunyevi-pool">DÃ¼nyevi</button>
                <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="modal-ilmi-pool">Ä°lmi</button>
                <button class="pool-tab-btn py-2 px-4 font-semibold text-gray-500" data-pool-tab="modal-haftalik-pool">HaftalÄ±k</button>
            </div>
            <div class="flex items-center justify-end mb-2">
                <button id="add-all-dunyevi-favorites" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Favorileri Ekle</button>
            </div>
            <div id="modal-dunyevi-pool" class="pool-tab-content space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="flex items-center justify-end mb-2">
                <button id="add-all-ilmi-favorites" class="text-xs bg-purple-600 text-white px-2 py-1 rounded">Favorileri Ekle</button>
            </div>
            <div id="modal-ilmi-pool" class="pool-tab-content hidden space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div class="flex items-center justify-end mb-2">
                <button id="add-all-haftalik-favorites" class="text-xs bg-green-600 text-white px-2 py-1 rounded">Favorileri Ekle</button>
            </div>
            <div id="modal-haftalik-pool" class="pool-tab-content hidden space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>
    
    <!-- UI Ã–lÃ§ek ButonlarÄ± (SaÄŸ Ã¼st kÃ¶ÅŸe) -->
    <div id="ui-scale-controls" class="fixed top-2 right-2 z-50 flex items-center gap-1">
        <button id="ui-scale-dec" class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded shadow">âˆ’</button>
        <button id="ui-scale-inc" class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded shadow">ï¼‹</button>
    </div>
    
    <!-- GeÃ§miÅŸ GÃ¼nler Modal (Ä°stek 9) -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full h-[70vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-pink-600">GeÃ§miÅŸ GÃ¼nler</h3>
                <button id="history-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="history-list" class="space-y-2 overflow-y-auto h-[calc(70vh-100px)] pr-2">
                <p class="text-gray-500">YÃ¼klenecek geÃ§miÅŸ gÃ¼n kaydÄ± bulunamadÄ±.</p>
            </div>
        </div>
    </div>

    <!-- Ä°statistik/Analiz Modal (YENÄ°) -->
    <div id="stats-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-indigo-600">ğŸ“Š BaÅŸarÄ± Analizi</h3>
                <button id="stats-modal-close-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            
            <!-- Sekme ButonlarÄ± (GÃ¼nlÃ¼k / HaftalÄ±k) -->
            <div class="flex border-b border-gray-300 mb-4">
                <button class="stats-tab-btn text-indigo-600 border-b-2 border-indigo-600 py-2 px-4 font-semibold" data-stats-tab="daily-chart">GÃ¼nlÃ¼k</button>
                <button class="stats-tab-btn text-gray-500 py-2 px-4 font-semibold" data-stats-tab="weekly-chart">HaftalÄ±k</button>
            </div>
            
            <!-- Grafik iÃ§erikleri -->
            <div id="stats-content" class="min-h-[400px]">
                <!-- GÃ¼nlÃ¼k Grafik -->
                <div id="daily-chart-tab" class="stats-tab-content">
                    <canvas id="daily-stats-chart"></canvas>
                </div>
                
                <!-- HaftalÄ±k Grafik -->
                <div id="weekly-chart-tab" class="stats-tab-content hidden">
                    <canvas id="weekly-stats-chart"></canvas>
                </div>
                
                <!-- Veri yoksa mesaj -->
                <div id="no-stats-message" class="hidden text-center text-gray-500 py-8">
                    <p>HenÃ¼z istatistik verisi yok. GÃ¶revlerinizi tamamlayÄ±n ve zaman iÃ§inde ilerlemenizi gÃ¶rÃ¼n!</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK (Gerekli) -->
    <script type="module">
        // --- GLOBAL DEÄÄ°ÅKENLER VE SABÄ°TLER ---
        
        // Local tarih anahtarÄ± (YYYY-MM-DD) - zaman dilimi hatalarÄ±nÄ± Ã¶nlemek iÃ§in toISOString kullanmÄ±yoruz
        function formatDateKey(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        let currentDayStr = formatDateKey(new Date());
        let currentWeekStr = getWeekId(new Date());
        // Aktif dÃ¼zenlenen tarih (varsayÄ±lan: bugÃ¼n). KullanÄ±cÄ± Ã¶nceki gÃ¼nlere gezinebilir.
        let activeDateStr = currentDayStr;
        // KaÃ§ gÃ¼ne kadar geriye dÃ¼zenleme izni var
        const EDITABLE_DAYS = Infinity; // GeÃ§miÅŸe sÄ±nÄ±rsÄ±z dÃ¼zenleme izni

        // Yerel Depolama iÃ§in anahtar Ã¶neki
        const LS_PREFIX = 'YSZ_';
        
        // YENÄ°: NÃ¶bet Takibi DOM referanslarÄ± (ModÃ¼l KapsamÄ±nda TanÄ±mlandÄ±)
        let rotaLoader = null; 
        let rotaOutput = null;
        
        // YENÄ°: Chart.js iÃ§in global deÄŸiÅŸkenler (Ã§ift render'Ä± Ã¶nlemek iÃ§in)
        let dailyChartInstance = null;
        let weeklyChartInstance = null;

        // GÃœNCELLENDÄ°: Statik Ã‡iÃ§ek Arka PlanlarÄ± (Daha stabil, non-Unsplash placeholderlar)
        const FLOWER_BACKGROUND_PRESETS = [
            { url: 'https://placehold.co/800x450/f9a8d4/ffffff?text=1.+Pastel+Laleler', style: 'Pastel Pembe Laleler' },
            { url: 'https://placehold.co/800x450/a5b4fc/ffffff?text=2.+Sulu+Boya+GÃ¼ller', style: 'Soyut Sulu Boya GÃ¼ller (Ã‡izim)' },
            { url: 'https://placehold.co/800x450/ef4444/ffffff?text=3.+GerÃ§ekÃ§i+GÃ¼ller', style: 'GerÃ§ekÃ§i KÄ±rmÄ±zÄ± GÃ¼ller' },
            { url: 'https://placehold.co/800x450/c4b5fd/ffffff?text=4.+Mor+Pembe+Desen', style: 'YumuÅŸak Pembe/Mor Ã‡iÃ§ek Desen' },
            { url: 'https://placehold.co/800x450/4ade80/ffffff?text=5.+CanlÄ±+Bahar+Ã‡iÃ§ekleri', style: 'CanlÄ± KarÄ±ÅŸÄ±k Bahar Ã‡iÃ§ekleri' }
            // Kendi Base64 resimlerinizi buraya ekleyebilirsiniz: 
            // { url: 'data:image/jpeg;base64,.....KENDÄ° BASE64 VERÄ°NÄ°Z.....', style: 'Kendi Resminiz' }
        ];

        // VarsayÄ±lan arka plan (ilk aÃ§Ä±lÄ±ÅŸta kullanÄ±lÄ±r)
        const DEFAULT_FALLBACK_BG = FLOWER_BACKGROUND_PRESETS[0].url;

        // YENÄ°: GÃ¼nlÃ¼k SÃ¶zler Veri Listesi (Eksikti, Hata DÃ¼zeltmesi)
        const GUNLUK_SOZLER = [
            {
                ayet: { text: "ÅÃ¼phesiz, Allah sabredenlerle beraberdir.", source: "Bakara, 153" },
                hadis: { text: "KolaylaÅŸtÄ±rÄ±nÄ±z, zorlaÅŸtÄ±rmayÄ±nÄ±z; mÃ¼jdeleyiniz, nefret ettirmeyiniz.", source: "BuhÃ¢rÃ®, Ä°lim, 11" },
                soz: { text: "Ä°ki gÃ¼nÃ¼ bir olan ziyandadÄ±r.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "Sizin en hayÄ±rlÄ±nÄ±z, Kur'an'Ä± Ã¶ÄŸrenen ve Ã¶ÄŸretendir.", source: "TirmizÃ®, FedÃ¢ilÃ¼'l-Kur'an, 15" },
                hadis: { text: "Ä°lim Ã¶ÄŸrenmek, her MÃ¼slÃ¼mana farzdÄ±r.", source: "Ä°bn MÃ¢ce, Mukaddime, 17" },
                soz: { text: "Bana bir harf Ã¶ÄŸretenin kÄ±rk yÄ±l kÃ¶lesi olurum.", source: "Hz. Ali (r.a.)" }
            },
            {
                ayet: { text: "HiÃ§ bilenlerle bilmeyenler bir olur mu?", source: "ZÃ¼mer, 9" },
                hadis: { text: "Allah kimin iÃ§in hayÄ±r dilerse, onu dinde fÃ¢kih (derin anlayÄ±ÅŸ sahibi) kÄ±lar.", source: "BuhÃ¢rÃ®, Ä°lim, 13" },
                soz: { text: "Okumak, gÄ±dadÄ±r; okuyan insan, acÄ±kmaz.", source: "Cemil MeriÃ§" }
            },
            {
                ayet: { text: "Rabbim, ilmimi artÄ±r de.", source: "TÃ¢hÃ¢, 114" },
                hadis: { text: "BeÅŸikten mezara kadar ilim Ã¶ÄŸreniniz.", source: "HadÃ®s-i ÅerÃ®f" },
                soz: { text: "En bÃ¼yÃ¼k savaÅŸ, insanÄ±n kendi nefsiyle yaptÄ±ÄŸÄ± savaÅŸtanÄ±r.", source: "Hz. Muhammed (s.a.v.)" }
            },
            {
                ayet: { text: "O, (gece) karanlÄ±ÄŸÄ± yarÄ±p sabahÄ± Ã§Ä±karandÄ±r.", source: "En'Ã¢m, 96" },
                hadis: { text: "GÃ¼zel sÃ¶z sadakadÄ±r.", source: "MÃ¼slim, ZekÃ¢t, 56" },
                soz: { text: "Hayat, iman ve cihattÄ±r.", source: "Hz. HÃ¼seyin (r.a.)" }
            },
            {
                ayet: { text: "Allah, bir kimseyi ancak gÃ¼cÃ¼nÃ¼n yettiÄŸi ÅŸeyle yÃ¼kÃ¼mlÃ¼ kÄ±lar.", source: "Bakara, 286" },
                hadis: { text: "Ameller niyetlere gÃ¶redir.", source: "BuhÃ¢rÃ®, Bedâ€™Ã¼â€™l-vahy, 1" },
                soz: { text: "SabÄ±r, baÅŸarÄ±nÄ±n anahtarÄ±dÄ±r.", source: "MevlÃ¢nÃ¢" }
            }
        ];

        // DOM Element ReferanslarÄ±
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Tarihe gÃ¼n ekleyip ISO yyyy-mm-dd formatÄ±nda dÃ¶ndÃ¼rÃ¼r
        function addDays(dateStr, delta) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + delta);
            return formatDateKey(d);
        }

        // YardÄ±mcÄ±: iki tarih arasÄ±ndaki gÃ¼n farkÄ±nÄ± (bugÃ¼n - target) olarak dÃ¶ndÃ¼rÃ¼r (tam sayÄ±ya yuvarlanmÄ±ÅŸ)
        function daysDifferenceFromToday(targetDateStr) {
            const msPerDay = 24 * 60 * 60 * 1000;
            const today = new Date(currentDayStr + 'T00:00:00');
            const target = new Date(targetDateStr + 'T00:00:00');
            return Math.round((today - target) / msPerDay);
        }

        function formatLongDate(dateStr) {
            try {
                return new Date(dateStr + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function isActiveDateEditable() {
            const diff = daysDifferenceFromToday(activeDateStr);
            return diff >= 0; // GeÃ§miÅŸ tarihler dÃ¼zenlenebilir, gelecek deÄŸil
        }

        function updateDateDisplay() {
            // BÃ¼yÃ¼k tarih baÅŸlÄ±ÄŸÄ± (sabit olarak bugÃ¼nÃ¼n uzun gÃ¶sterimi)
            $("#current-date").textContent = new Date(currentDayStr + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const label = $("#active-date-label");
            if (!label) return;
            if (activeDateStr === currentDayStr) {
                label.textContent = `BugÃ¼n â€” ${formatLongDate(activeDateStr)}`;
            } else {
                const editable = isActiveDateEditable();
                label.textContent = `${formatLongDate(activeDateStr)} ${editable ? '(DÃ¼zenlenebilir)' : '(Gelecek - Salt okunur)'} `;
            }

            // Form kontrollerini aktive/pasif yap
            const addBtn = $("#add-task-btn");
            const newTitle = $("#new-task-title");
            const newType = $("#new-task-type");
            const newFreq = $("#new-task-frequency");
            if (addBtn) addBtn.disabled = !isActiveDateEditable();
            if (newTitle) newTitle.disabled = !isActiveDateEditable();
            if (newType) newType.disabled = !isActiveDateEditable();
            if (newFreq) newFreq.disabled = !isActiveDateEditable();
        }

        function setActiveDate(dateStr) {
            // Tarihi sÄ±nÄ±rla: ileri gidemeziz (gelecek), geri ise sadece mantÄ±ksal limit gÃ¶sterilir
            const today = new Date(currentDayStr + 'T00:00:00');
            const candidate = new Date(dateStr + 'T00:00:00');
            if (candidate > today) {
                activeDateStr = currentDayStr;
            } else {
                activeDateStr = dateStr;
            }
            updateDateDisplay();
            loadDailyTasks();
        }

        // --- YEREL DEPOLAMA YARDIMCILARI ---

        /**
         * YENÄ°: GÃ¼nlÃ¼k gÃ¶revleri getirir (CanlÄ± veya GeÃ§miÅŸten)
         * Bu fonksiyon, "donmuÅŸ" gÃ¼n sorununu Ã§Ã¶zer.
         */
        function getEditableDailyTasks(dateStr) {
            let tasks = lsGet(`tasks_daily_${dateStr}`, []);
            if (!tasks || tasks.length === 0) {
                const history = lsGet('history', {});
                if (history && history[dateStr]) {
                    return history[dateStr];
                }
            }
            return tasks || [];
        }

        /**
         * Yerel depolamadan veri okur (JSON.parse yapar)
         */
        function lsGet(key, defaultValue = null) {
            const value = localStorage.getItem(LS_PREFIX + key);
            if (value === null || value === undefined) {
                return defaultValue;
            }
            try {
                return JSON.parse(value);
            } catch (e) {
                console.error("Yerel depolama okuma hatasÄ± (JSON parse):", e);
                return defaultValue;
            }
        }

        /**
         * Yerel depolamaya veri yazar (JSON.stringify yapar)
         */
        function lsSet(key, value) {
            try {
                localStorage.setItem(LS_PREFIX + key, JSON.stringify(value));
            } catch (e) {
                console.error("Yerel depolama yazma hatasÄ±:", e);
                showMessage("Veri KayÄ±t HatasÄ±", "Verileriniz kaydedilemedi. TarayÄ±cÄ±nÄ±za yer kalmamÄ±ÅŸ olabilir.");
            }
        }

        // --- UYGULAMA BAÅLANGIÃ‡ ---

        try {
            console.log("Uygulama baÅŸlÄ±yor (Yerel Depolama).");
            initializeApp(); // Direkt uygulamayÄ± baÅŸlat
        } catch (error) {
            console.error("Uygulama baÅŸlatÄ±lamadÄ±:", error); // Hata mesajÄ± dÃ¼zeltildi
            showMessage("Hata", "Uygulama baÅŸlatÄ±lamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        }

        async function initializeApp() {
            try {
                await checkDayChange(); // GÃ¼nÃ¼ kontrol et ve gerekirse verileri taÅŸÄ±
                loadStaticData(); // Statik verileri (nÃ¶bet, sÃ¶z, arka plan) yÃ¼kle
                loadAllDataAndSetupListeners(); // Veri dinleyicilerini baÅŸlat

            } catch (error) {
                console.error("BaÅŸlatma hatasÄ±:", error);
                showMessage("BaÅŸlatma HatasÄ±", "Uygulama verileri yÃ¼klenirken bir hata oluÅŸtu.");
            }
        }
        
        // GÃœN VE HAFTA DEÄÄ°ÅÄ°MÄ° FONKSÄ°YONLARI BURADA KALDI (Hata DÃ¼zeltmeleri YapÄ±lmÄ±ÅŸtÄ±)

        /**
         * GÃ¶revler, havuzlar vb. iÃ§in tÃ¼m veri yÃ¼kleyicilerini baÅŸlatÄ±r (Yerel Depolama).
         */
        function loadAllDataAndSetupListeners() {
            loadDailyTasks();
            ensureWeeklyRollOver();
            loadWeeklyTasks();
            loadPools();
            loadStats(); // GÃœNCELLENDÄ°: ArtÄ±k grafikleri de Ã§izecek
            loadSettings(); // YENÄ°: AyarlarÄ± yÃ¼kle

            // Event Listeners (UI)
            setupEventListeners();
            setupWeeklyNavigation();


        function setupWeeklyNavigation() {
            const prevBtn = document.getElementById('weekly-prev-btn');
            const nextBtn = document.getElementById('weekly-next-btn');
            const jumpBtn = document.getElementById('weekly-jump-current');
            
            /**
             * Bir hafta ID'sine gÃ¶re hafta deÄŸiÅŸtirir ve verileri yÃ¼kler
             */
            const changeWeek = (newWeekId) => {
                currentWeekStr = newWeekId;
                loadWeeklyTasks(); // GÃ¶revleri, baÅŸarÄ± yÃ¼zdesini ve tarih aralÄ±ÄŸÄ±nÄ± gÃ¼nceller
            };
            
            /**
             * Hafta ID'sine delta ekler/Ã§Ä±karÄ±r
             */
            const addWeeks = (weekId, delta) => {
                const start = new Date(getWeekStartDate(weekId) + 'T00:00:00');
                start.setUTCDate(start.getUTCDate() + delta * 7);
                return getWeekId(new Date(start));
            };
            
            // Ã–nceki hafta butonu
            if (prevBtn) {
                prevBtn.onclick = () => {
                    const newWeek = addWeeks(currentWeekStr, -1);
                    changeWeek(newWeek);
                };
            }
            
            // Sonraki hafta butonu
            if (nextBtn) {
                nextBtn.onclick = () => {
                    const newWeek = addWeeks(currentWeekStr, 1);
                    changeWeek(newWeek);
                };
            }
            
            // Bu haftaya dÃ¶n butonu
            if (jumpBtn) {
                jumpBtn.onclick = () => {
                    const todayWeek = getWeekId(new Date());
                    changeWeek(todayWeek);
                };
            }
        }
            // NÃ¶bet ve GÃ¼nÃ¼n SÃ¶zÃ¼ kartlarÄ±nÄ± alt ikili bÃ¶lÃ¼me taÅŸÄ±
            try {
                const duo = document.getElementById('bottom-duo');
                const rotaCard = document.getElementById('rota-card');
                const quoteCard = document.getElementById('quote-box');
                if (duo && rotaCard && quoteCard) {
                    duo.appendChild(rotaCard);
                    duo.appendChild(quoteCard);
                }
            } catch (e) { console.warn('Alt ikili bÃ¶lÃ¼me taÅŸÄ±ma baÅŸarÄ±sÄ±z:', e); }

            // Eski havuz ve sekmeli gÃ¶rev kutularÄ±nÄ± gizle (temiz arayÃ¼z iÃ§in)
            try {
                // Eski sekmeli gÃ¶rev kutusu: tab-btn iÃ§erir
                const oldTabsBox = Array.from(document.querySelectorAll('.task-box')).find(box => box.querySelector('.tab-btn'));
                if (oldTabsBox) oldTabsBox.classList.add('hidden');

                // Eski havuz kutusu: pool-tab-btn iÃ§erir
                const oldPoolBox = Array.from(document.querySelectorAll('.pool-box')).find(box => box.querySelector('.pool-tab-btn'));
                if (oldPoolBox) oldPoolBox.classList.add('hidden');
            } catch (e) { console.warn('Eski UI gizleme baÅŸarÄ±sÄ±z:', e); }
        }

        // BaÅŸlangÄ±Ã§ta aktif tarihi ayarla (UI baÅŸlatma)
        setActiveDate(currentDayStr);

        /**
         * GÃ¼n deÄŸiÅŸip deÄŸiÅŸmediÄŸini kontrol eder. DeÄŸiÅŸtiyse, dÃ¼nkÃ¼ gÃ¶revleri
         * 'history' koleksiyonuna taÅŸÄ±r ve varsayÄ±lanlarÄ± yeni gÃ¼ne ekler. (Ä°stek 9)
         */
        async function checkDayChange() {
            try {
                const lastLoginInfo = lsGet('metadata_lastLogin', { date: null, week: null });
                const lastLoginDate = lastLoginInfo.date;

                if (lastLoginDate && lastLoginDate !== currentDayStr) {
                    console.log(`GÃ¼n deÄŸiÅŸti. Eski gÃ¼n: ${lastLoginDate}, Yeni gÃ¼n: ${currentDayStr}`);
                    await archiveTasks(lastLoginDate); // DÃ¼nkÃ¼ gÃ¶revleri arÅŸivle (GÃœNCELLENDÄ°: artÄ±k istatistik de kaydeder)
                    await addDefaultTasksForNewDay(); // Yeni gÃ¼n iÃ§in varsayÄ±lanlarÄ± ekle
                } else if (!lastLoginDate) {
                    console.log("Ä°lk giriÅŸ, varsayÄ±lan gÃ¶revler ekleniyor.");
                    await addDefaultTasksForNewDay(); // Ä°lk giriÅŸse de varsayÄ±lanlarÄ± ekle
                } else {
                    console.log("AynÄ± gÃ¼n giriÅŸi.");
                }

                const lastLoginWeek = lastLoginInfo.week;
                if(lastLoginWeek !== currentWeekStr) {
                    console.log(`Hafta deÄŸiÅŸti. Eski hafta: ${lastLoginWeek}, Yeni hafta: ${currentWeekStr}`);
                    await resetWeeklyTasks(lastLoginWeek); // GÃœNCELLENDÄ°: ArtÄ±k eski haftayÄ± parametre olarak alÄ±r
                }
                
                lsSet('metadata_lastLogin', { date: currentDayStr, week: currentWeekStr });

                // GÃ¼ncelle: tarih gÃ¶sterimini yenile
                updateDateDisplay();

            } catch (error) {
                console.error("GÃ¼n deÄŸiÅŸtirme kontrol hatasÄ±:", error);
            }
        }

        /**
         * YENÄ°: GÃ¼nlÃ¼k gÃ¶revleri geÃ§miÅŸe arÅŸivler (Hata 1'i dÃ¼zeltir)
         * GÃœNCELLENDÄ°: ArtÄ±k gÃ¼nlÃ¼k istatistikleri de kaydeder.
         */
        async function archiveTasks(dateToArchive) {
            console.log(`GÃ¶revler arÅŸivleniyor: ${dateToArchive}`);
            const dailyTasksKey = `tasks_daily_${dateToArchive}`;
            const tasks = lsGet(dailyTasksKey, []);
            
            if (tasks.length > 0) {
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // GÃœNCELLENDÄ°: Yeni stats yapÄ±sÄ±
                const allStats = lsGet('stats', { daily: {}, weekly: {} }); 
                allStats.daily[dateToArchive] = { success: successRate }; // 'daily' anahtarÄ± altÄ±na kaydet
                lsSet('stats', allStats);
                
                const allHistory = lsGet('history', {});
                allHistory[dateToArchive] = tasks;
                lsSet('history', allHistory);
            }
            localStorage.removeItem(LS_PREFIX + dailyTasksKey);
        }
        
        /**
         * YENÄ°: Yeni gÃ¼n iÃ§in varsayÄ±lan gÃ¶revleri ekler (Hata 1'i dÃ¼zeltir)
         */
        async function addDefaultTasksForNewDay() {
            console.log("Yeni gÃ¼n iÃ§in varsayÄ±lan gÃ¶revler ekleniyor...");
            
            const dunyeviPool = lsGet('pools_dunyevi', []);
            const ilmiPool = lsGet('pools_ilmi', []);
            
            const defaultDunyevi = dunyeviPool.filter(t => t.isDefault).map(t => ({
                title: t.title,
                type: 'dunyevi',
                status: 0,
                repetitionCount: t.repetitionCount || 1,
                repetitionCompleted: 0,
                subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(st => ({ title: st.title, completed: false })) : [],
                subtaskScoring: t.subtaskScoring || 'grouped'
            }));
            const defaultIlmi = ilmiPool.filter(t => t.isDefault).map(t => ({
                title: t.title,
                type: 'ilmi',
                status: 0,
                repetitionCount: t.repetitionCount || 1,
                repetitionCompleted: 0,
                subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(st => ({ title: st.title, completed: false })) : [],
                subtaskScoring: t.subtaskScoring || 'grouped'
            }));
            
            const dailyKey = `tasks_daily_${currentDayStr}`;
            const dailyTasks = lsGet(dailyKey, []);
            
            const allDefaults = [...defaultDunyevi, ...defaultIlmi];
            allDefaults.forEach(defaultTask => {
                const exists = dailyTasks.some(t => t.title === defaultTask.title);
                if (!exists) {
                    dailyTasks.push({
                        id: Date.now().toString() + Math.random(), // Benzersiz ID
                        title: defaultTask.title,
                        type: defaultTask.type,
                        status: 0,
                        repetitionCount: defaultTask.repetitionCount,
                        repetitionCompleted: 0,
                        subtasks: defaultTask.subtasks,
                        subtaskScoring: defaultTask.subtaskScoring
                    });
                }
            });
            
            lsSet(dailyKey, dailyTasks);
            loadDailyTasks(); // UI'Ä± yenile
        }
        
        /**
         * YENÄ°: Yeni hafta iÃ§in haftalÄ±k gÃ¶revleri sÄ±fÄ±rlar (tamamlanma durumlarÄ±nÄ±)
         * GÃœNCELLENDÄ°: Eski haftanÄ±n istatistiÄŸini kaydeder.
         */
        async function resetWeeklyTasks(lastLoginWeek) {
            console.log("HaftalÄ±k gÃ¶revler sÄ±fÄ±rlanÄ±yor...");

            // YENÄ°: SÄ±fÄ±rlamadan Ã–NCE, eski haftanÄ±n baÅŸarÄ±sÄ±nÄ± kaydet
            if (lastLoginWeek && lastLoginWeek !== currentWeekStr) {
                const oldWeeklyTasks = lsGet(`tasks_weekly_${lastLoginWeek}`, []);
                if (oldWeeklyTasks.length > 0) {
                    const finalWeeklySuccess = calculateWeeklySuccess(oldWeeklyTasks); // UI'Ä± gÃ¼ncelleme
                    
                    const allStats = lsGet('stats', { daily: {}, weekly: {} });
                    allStats.weekly[lastLoginWeek] = { success: finalWeeklySuccess };
                    lsSet('stats', allStats);
                    console.log(`HaftalÄ±k baÅŸarÄ± (${lastLoginWeek}) kaydedildi: ${finalWeeklySuccess}%`);
                    
                    // Eski haftanÄ±n gÃ¶revlerini sil (isteÄŸe baÄŸlÄ±, ama yerel depolamayÄ± temiz tutar)
                    localStorage.removeItem(LS_PREFIX + `tasks_weekly_${lastLoginWeek}`);
                }
            }
            
            // Yeni hafta iÃ§in varsayÄ±lanlarÄ± yÃ¼kle
            const weeklyKey = `tasks_weekly_${currentWeekStr}`;
            const weeklyPool = lsGet('pools_haftalik', []);
            
            const defaultWeekly = weeklyPool
                .filter(t => t.isDefault)
                .map(t => ({
                    id: Date.now().toString() + Math.random(),
                    title: t.title,
                    frequency: t.frequency || 1,
                    completed: 0,
                    subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(st => ({ title: st.title, completed: false })) : [],
                    subtaskScoring: t.subtaskScoring || 'grouped'
                }));
            
            lsSet(weeklyKey, defaultWeekly);
            loadWeeklyTasks(); // UI'Ä± yenile
        }


        // --- YEREL DEPOLAMADAN YÃœKLEME FONKSÄ°YONLARI ---
        function loadDailyTasks() {
            // Aktif tarihe gÃ¶re yÃ¼kle. EÄŸer aktif tarih iÃ§in canlÄ± gÃ¼nlÃ¼k kayÄ±t yoksa, arÅŸivden oku (salt okunur).
            let tasks = getEditableDailyTasks(activeDateStr);
            let readOnly = !isActiveDateEditable();
            
            tasks = tasks || [];
            const dunyevi = tasks.filter(t => t.type === 'dunyevi');
            const ilmi = tasks.filter(t => t.type === 'ilmi');
            renderDailyTasks(dunyevi, ilmi, readOnly);
            
            // YENÄ°: Her iki tÃ¼r iÃ§in baÅŸarÄ± oranÄ± ve havuz animasyonunu gÃ¼ncelle
            updateDailyTypeSuccess('dunyevi');
            updateDailyTypeSuccess('ilmi');
        }

        function loadWeeklyTasks() {
            const tasks = lsGet(`tasks_weekly_${currentWeekStr}`, []);
            renderWeeklyTasks(tasks);
            calculateWeeklySuccess(); // YENÄ°: HaftalÄ±k baÅŸarÄ±yÄ± hesapla/gÃ¼ncelle
            updateWeeklyDateRange(); // YENÄ°: Hafta tarih aralÄ±ÄŸÄ±nÄ± gÃ¼ncelle
        }

        function loadPools() {
            const dun = lsGet('pools_dunyevi', []);
            const ilm = lsGet('pools_ilmi', []);
            const haf = lsGet('pools_haftalik', []);
            // Render only modal pools (yeni arayÃ¼z)
            renderPool(dun, 'modal-dunyevi-pool');
            renderPool(ilm, 'modal-ilmi-pool');
            renderPool(haf, 'modal-haftalik-pool');
        }

        function loadStats() {
            // GÃœNCELLENDÄ°: Yeni stats yapÄ±sÄ±
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const dailyStats = allStats.daily || {};
            const weeklyStats = allStats.weekly || {};
            
            renderStats(dailyStats, weeklyStats); // renderStats'Ä± yeni verilerle Ã§aÄŸÄ±r
        }

        function loadSettings() {
            const apiKey = lsGet('settings_apiKey', '');
            $('#api-key-input').value = apiKey;
            
            const rotaName = lsGet('settings_rotaName', 'Ali Murtaza KoÃ§ak'); // VarsayÄ±lan isim
            $('#rota-name-input').value = rotaName;
        }

        /**
         * NÃ¶bet bilgisi, gÃ¼nÃ¼n sÃ¶zÃ¼, arka plan gibi statik verileri yÃ¼kler
         */
        async function loadStaticData() {
            // GÃ¼nÃ¼n SÃ¶zÃ¼ (Ä°stek 7)
            setDailyQuote();
            // VarsayÄ±lan Arka Plan (Ä°stek 10)
            setDailyBackground(); 
            
            // YENÄ°: Arka plan seÃ§ici galeriyi Ã§iz (Statik Ã‡iÃ§ekler)
            renderStaticBackgrounds();
            
            // YENÄ°: Global DOM referanslarÄ±nÄ± kaydet
            rotaLoader = $("#rota-loader"); 
            rotaOutput = $("#rota-output");

            // KayÄ±tlÄ± NÃ¶bet Bilgisi (Ä°stek 8)
            try {
                const rotaInfo = lsGet('metadata_rotaInfo');
                // DOM elemanlarÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol etmeye gerek yok, Ã§Ã¼nkÃ¼ processRota iÃ§inde kontrol edilecek.
                if (rotaOutput && rotaInfo && rotaInfo.text) {
                     rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${rotaInfo.text}</pre>`;
                }
            } catch (error) {
                console.error("KayÄ±tlÄ± nÃ¶bet bilgisi yÃ¼klenemedi:", error);
            }
        }
        
        // --- RENDER (GÃ–RÃœNÃœM) FONKSÄ°YONLARI ---

        // UI Ã¶lÃ§eklendirme: yazÄ± puntolarÄ± ve tik boyutlarÄ±
        (function setupUiScale() {
            try {
                const saved = lsGet('settings_uiScale', { font: 1.0, tick: 1.0 });
                applyUiScale(saved);
                const decBtn = document.getElementById('ui-scale-dec');
                const incBtn = document.getElementById('ui-scale-inc');
                if (decBtn) decBtn.onclick = () => {
                    const cur = lsGet('settings_uiScale', { font: 1.0, tick: 1.0 });
                    const next = { font: Math.max(0.8, +(cur.font - 0.1).toFixed(2)), tick: Math.max(0.8, +(cur.tick - 0.1).toFixed(2)) };
                    lsSet('settings_uiScale', next);
                    applyUiScale(next);
                };
                if (incBtn) incBtn.onclick = () => {
                    const cur = lsGet('settings_uiScale', { font: 1.0, tick: 1.0 });
                    const next = { font: Math.min(1.4, +(cur.font + 0.1).toFixed(2)), tick: Math.min(1.4, +(cur.tick + 0.1).toFixed(2)) };
                    lsSet('settings_uiScale', next);
                    applyUiScale(next);
                };
            } catch (e) { /* no-op */ }
        })();

        function applyUiScale(scale) {
            try {
                const root = document.documentElement;
                root.style.setProperty('--task-font-scale', String(scale.font || 1));
                root.style.setProperty('--task-checkbox-scale', String(scale.tick || 1));
            } catch (e) { /* no-op */ }
        }

        function renderDailyTasks(dunyevi, ilmi, readOnly = false) {
            const dunyeviContainer = document.querySelector("#dunyevi-tasks-col") || $("#dunyevi-tasks");
            const ilmiContainer = document.querySelector("#ilmi-tasks-col") || $("#ilmi-tasks");
            
            dunyeviContainer.innerHTML = dunyevi.length ? '' : '<p class="text-gray-400 italic">DÃ¼nyevi gÃ¶rev yok.</p>';
            ilmiContainer.innerHTML = ilmi.length ? '' : '<p class="text-gray-400 italic">Ä°lmi gÃ¶rev yok.</p>';

            dunyevi.forEach(task => dunyeviContainer.appendChild(createTaskElement(task, 'daily', readOnly)));
            ilmi.forEach(task => ilmiContainer.appendChild(createTaskElement(task, 'daily', readOnly)));
        }

        function renderWeeklyTasks(tasks) {
            const container = document.querySelector("#haftalik-tasks-col") || $("#haftalik-tasks");
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic">HaftalÄ±k gÃ¶rev yok.</p>';
            tasks.forEach(task => container.appendChild(createTaskElement(task, 'weekly')));
        }
        
        function renderPool(tasks, containerId) {
            const container = $(`#${containerId}`);
            if (!container) {
                console.error(`Havuz konteyneri bulunamadÄ±: #${containerId}`);
                return;
            }
            
            container.innerHTML = tasks.length ? '' : '<p class="text-gray-400 italic text-sm">Bu havuzda gÃ¶rev yok.</p>';
            tasks.forEach(task => {
                const el = document.createElement('div');
                el.className = 'pool-item bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';
                el.dataset.id = task.id;
                el.dataset.title = task.title;
                
                const hasSubtasks = Array.isArray(task.subtasks) && task.subtasks.length > 0;
                const subtasksPreview = hasSubtasks
                    ? `<div class="mt-1 text-xs text-gray-500 leading-snug">â€¢ ${task.subtasks.map(st => st.title).join(' â€¢ ')}</div>`
                    : '';

                el.innerHTML = `
                    <div class="flex-grow">
                        <span class="text-gray-700">${task.title}</span>
                        ${subtasksPreview}
                    </div>
                    <button class="toggle-default-btn text-lg ${task.isDefault ? 'text-yellow-500' : 'text-gray-300'}" title="VarsayÄ±lan olarak ayarla">
                        ${task.isDefault ? 'â˜…' : 'â˜†'}
                    </button>
                    <button class="delete-pool-btn text-red-400 hover:text-red-600 ml-2" title="Havuzdan sil">
                        &times;
                    </button>
                `;
                
                el.querySelector('span').onclick = () => handlePoolClick(task, containerId);
                el.querySelector('.toggle-default-btn').onclick = (e) => {
                    e.stopPropagation();
                    toggleTaskDefault(task.id, poolTypeFromContainer(containerId));
                };
                el.querySelector('.delete-pool-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteFromPool(task.id, poolTypeFromContainer(containerId));
                };
                
                container.appendChild(el);
            });
        }
        
        /**
         * GÃœNCELLENDÄ°: ArtÄ±k Chart.js kullanarak grafikleri Ã§izer
         */
        function renderStats(dailyStats, weeklyStats) {
            const dailyContainer = $("#daily-chart-tab");
            const weeklyContainer = $("#weekly-chart-tab");
            const noStatsMsg = $("#no-stats-message");

            if (!dailyContainer || !weeklyContainer || !noStatsMsg) {
                console.error("Ä°statistik canvas konteynerlarÄ± bulunamadÄ±.");
                return;
            }
            
            // Ã–nceki chart'larÄ± yok et (varsa)
            if (dailyChartInstance) dailyChartInstance.destroy();
            if (weeklyChartInstance) weeklyChartInstance.destroy();

            const dailyEntries = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0])); // Tarihe gÃ¶re sÄ±rala
            const weeklyEntries = Object.entries(weeklyStats).sort((a, b) => a[0].localeCompare(b[0])); // Haftaya gÃ¶re sÄ±rala

            if (dailyEntries.length === 0 && weeklyEntries.length === 0) {
                noStatsMsg.classList.remove('hidden');
                dailyContainer.classList.add('hidden');
                weeklyContainer.classList.add('hidden');
                return;
            }
            
            noStatsMsg.classList.add('hidden');

            // --- GÃ¼nlÃ¼k Grafik ---
            if (dailyEntries.length > 0) {
                // Konteynerin iÃ§ini temizle (canvas'Ä± yeniden oluÅŸtur)
                dailyContainer.innerHTML = '<canvas id="daily-stats-chart"></canvas>';
                const dailyCtx = $('#daily-stats-chart').getContext('2d');
                
                const dailyLabels = dailyEntries.map(entry => {
                    const [date] = entry;
                    return new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                });
                const dailyData = dailyEntries.map(entry => entry[1].success);

                dailyChartInstance = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'GÃ¼nlÃ¼k BaÅŸarÄ± %',
                            data: dailyData,
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3 // EÄŸri iÃ§in
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 dailyContainer.innerHTML = '<p class="text-gray-500 p-4">GÃ¶sterilecek gÃ¼nlÃ¼k istatistik verisi yok.</p>';
            }

            // --- HaftalÄ±k Grafik ---
            if (weeklyEntries.length > 0) {
                // Konteynerin iÃ§ini temizle (canvas'Ä± yeniden oluÅŸtur)
                weeklyContainer.innerHTML = '<canvas id="weekly-stats-chart"></canvas>';
                const weeklyCtx = $('#weekly-stats-chart').getContext('2d');
                
                const weeklyLabels = weeklyEntries.map(entry => entry[0]); // Ã–rn: "2025-W45"
                const weeklyData = weeklyEntries.map(entry => entry[1].success);

                weeklyChartInstance = new Chart(weeklyCtx, {
                    type: 'line',
                    data: {
                        labels: weeklyLabels,
                        datasets: [{
                            label: 'HaftalÄ±k BaÅŸarÄ± %',
                            data: weeklyData,
                            borderColor: 'rgb(217, 70, 239)', // fuchsia-500
                            backgroundColor: 'rgba(217, 70, 239, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                 weeklyContainer.innerHTML = '<p class="text-gray-500 p-4">GÃ¶sterilecek haftalÄ±k istatistik verisi yok.</p>';
            }
            
             // Grafikleri ilk yÃ¼klemede doÄŸru sekmede gÃ¶ster
            $('#daily-chart-tab').classList.remove('hidden');
            $('#weekly-chart-tab').classList.add('hidden');
        }


        function createTaskElement(task, taskListType, readOnly = false) {
            const el = document.createElement('div');
            el.className = 'task-item bg-white rounded-lg shadow-md flex flex-col space-y-2';
            // Dynamic padding based on UI scale
            el.style.padding = `calc(0.75rem * var(--task-font-scale))`;
            el.dataset.id = task.id;

            if (taskListType === 'daily') {
                // Ana gÃ¶rev baÅŸlÄ±ÄŸÄ± satÄ±rÄ±
                const headerRow = document.createElement('div');
                headerRow.className = 'flex items-center';
                headerRow.style.columnGap = 'calc(0.75rem * var(--task-font-scale))';
                
                if (readOnly) {
                    headerRow.innerHTML = `
                        <span class="status-btn status-${task.status}" data-status="${task.status}" title="Durumu (salt okunur)"></span>
                        <span class="flex-grow text-gray-800">${task.title}</span>
                    `;
                } else {
                    headerRow.innerHTML = `
                        <span class="status-btn status-${task.status}" data-status="${task.status}" title="Durumu deÄŸiÅŸtir"></span>
                        <span class="flex-grow text-gray-800">${task.title}</span>
                        <button class="edit-task-btn text-blue-400 hover:text-blue-600 text-lg" title="GÃ¶revi dÃ¼zenle">âœ</button>
                        <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl" title="GÃ¶revi sil">&times;</button>
                    `;
                    headerRow.querySelector('.status-btn').onclick = () => updateTaskStatus(task.id, task.status);
                    headerRow.querySelector('.edit-task-btn').onclick = () => openTaskEditModal(task, activeDateStr);
                    headerRow.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'daily');
                }
                
                el.appendChild(headerRow);

                // Tekrar sayÄ±sÄ± (eÄŸer > 1 ise gÃ¶ster)
                if (task.repetitionCount && task.repetitionCount > 1) {
                    const repRow = document.createElement('div');
                    repRow.className = 'ml-6 flex items-center';
                    repRow.style.columnGap = 'calc(0.25rem * var(--task-font-scale))';
                    const checkboxes = [];
                    for (let i = 0; i < task.repetitionCount; i++) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-5 h-5 repetition-checkbox';
                        checkbox.dataset.index = i;
                        checkbox.checked = i < (task.repetitionCompleted || 0);
                        if (!readOnly) {
                            checkbox.onchange = () => updateTaskRepetition(task.id, i);
                        } else {
                            checkbox.disabled = true;
                        }
                        repRow.appendChild(checkbox);
                    }
                    el.appendChild(repRow);
                }

                // Alt gÃ¶revler (eÄŸer varsa)
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'ml-6 border-l-2 border-pink-200';
                    subtaskRow.style.paddingLeft = 'calc(0.5rem * var(--task-font-scale))';
                    subtaskRow.style.rowGap = 'calc(0.25rem * var(--task-font-scale))';
                    task.subtasks.forEach((subtask, idx) => {
                        const subtaskEl = document.createElement('div');
                        subtaskEl.className = 'flex items-center text-sm';
                        subtaskEl.style.columnGap = 'calc(0.375rem * var(--task-font-scale))';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-4 h-4 subtask-checkbox';
                        checkbox.dataset.index = idx;
                        checkbox.checked = subtask.completed || false;
                        if (!readOnly) {
                            checkbox.onchange = () => updateSubtask(task.id, idx);
                        } else {
                            checkbox.disabled = true;
                        }
                        subtaskEl.appendChild(checkbox);
                        const label = document.createElement('span');
                        label.className = 'text-gray-700';
                        if (subtask.completed) label.className += ' line-through opacity-60';
                        label.textContent = subtask.title;
                        subtaskEl.appendChild(label);
                        subtaskRow.appendChild(subtaskEl);
                    });
                    el.appendChild(subtaskRow);
                }
                
            } else if (taskListType === 'weekly') {
                el.className = 'task-item bg-white rounded-lg shadow-md flex flex-col space-y-2';
                el.style.padding = `calc(0.75rem * var(--task-font-scale))`;
                
                // Ana gÃ¶rev baÅŸlÄ±ÄŸÄ± satÄ±rÄ±
                const headerRow = document.createElement('div');
                headerRow.className = 'flex items-center';
                headerRow.style.columnGap = 'calc(0.75rem * var(--task-font-scale))';
                headerRow.innerHTML = `
                    <span class="flex-grow text-gray-800">${task.title} (Haftada ${task.frequency} kez)</span>
                    <button class="edit-task-btn text-blue-400 hover:text-blue-600 text-lg" title="GÃ¶revi dÃ¼zenle">âœ</button>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl" title="GÃ¶revi sil">&times;</button>
                `;
                
                headerRow.querySelector('.edit-task-btn').onclick = () => openWeeklyTaskEditModal(task, currentWeekStr);
                headerRow.querySelector('.delete-task-btn').onclick = () => deleteTask(task.id, 'weekly');
                
                el.appendChild(headerRow);

                // Frekans kutucuklarÄ±
                const repRow = document.createElement('div');
                repRow.className = 'ml-6 flex items-center';
                repRow.style.columnGap = 'calc(0.25rem * var(--task-font-scale))';
                for (let i = 0; i < task.frequency; i++) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'w-5 h-5 weekly-checkbox';
                    checkbox.dataset.index = i;
                    checkbox.checked = i < task.completed;
                    checkbox.onchange = () => updateWeeklyTask(task.id);
                    repRow.appendChild(checkbox);
                }
                el.appendChild(repRow);

                // Alt gÃ¶revler (varsa)
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'ml-8 border-l-2 border-green-200 pl-3 space-y-1';
                    task.subtasks.forEach((subtask, idx) => {
                        const subtaskEl = document.createElement('div');
                        subtaskEl.className = 'flex items-center space-x-2 text-sm';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'w-4 h-4 subtask-checkbox';
                        checkbox.dataset.index = idx;
                        checkbox.checked = subtask.completed || false;
                        checkbox.onchange = () => updateWeeklySubtask(task.id, idx);
                        subtaskEl.appendChild(checkbox);
                        const label = document.createElement('span');
                        label.className = 'text-gray-700';
                        if (subtask.completed) label.className += ' line-through opacity-60';
                        label.textContent = subtask.title;
                        subtaskEl.appendChild(label);
                        subtaskRow.appendChild(subtaskEl);
                    });
                    el.appendChild(subtaskRow);
                }
            }
            return el;
        }

        /**
         * YENÄ°: Statik arka plan listesini DOM'a Ã§izer (Ã‡iÃ§ekler)
         */
        function renderStaticBackgrounds() {
            const container = $("#bg-results-grid");
            if (!container) return;

            container.innerHTML = ""; // Temizle
            
            FLOWER_BACKGROUND_PRESETS.forEach(item => {
                container.appendChild(createThumbnail(item.url, item.style));
            });
        }
        
        /**
         * YENÄ°: Tek bir kÃ¼Ã§Ã¼k resim (thumbnail) elementi oluÅŸturur ve dÃ¶ndÃ¼rÃ¼r
         */
        function createThumbnail(url, title = "Arka planÄ± seÃ§") {
            const thumb = document.createElement('div');
            thumb.className = 'bg-thumbnail';
            thumb.style.backgroundImage = `url('${url}')`;
            thumb.title = title; // Yeni title kullanÄ±mÄ±
            thumb.onclick = () => {
                document.body.style.backgroundImage = `url('${url}')`;
                lsSet('settings_userBackground', url); // SeÃ§imi kaydet
            };
            return thumb;
        }


        // --- DÄ°ÄER YARDIMCI VE Ä°ÅLEM FONKSÄ°YONLARI ---

        /**
         * TÃ¼m UI event listener'larÄ±nÄ± ayarlar.
         */
        function setupEventListeners() {
            // SÃ¼tun baÅŸÄ±na hÄ±zlÄ± ekleme
            const addDunyeviBtn = $("#add-dunyevi-btn");
            const addDunyeviInput = $("#add-dunyevi-input");
            const addDunyeviCount = $("#add-dunyevi-count");
            const addDunyeviConfirm = $("#add-dunyevi-confirm");
            if (addDunyeviBtn && addDunyeviInput) {
                // Step 1: Plus shows text input only
                addDunyeviBtn.onclick = () => {
                    addDunyeviInput.classList.remove('hidden');
                    if (addDunyeviCount) addDunyeviCount.classList.add('hidden');
                    if (addDunyeviConfirm) addDunyeviConfirm.classList.add('hidden');
                    addDunyeviInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it (single handler; remove conflicting legacy ones)
                addDunyeviInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addDunyeviInput.value.trim()) return;
                        if (addDunyeviCount) {
                            addDunyeviCount.classList.remove('hidden');
                            addDunyeviCount.focus();
                            addDunyeviCount.select();
                            if (addDunyeviConfirm) addDunyeviConfirm.classList.remove('hidden');
                        } else {
                            // Fallback: add with default count
                            quickAddDailyTask(addDunyeviInput.value.trim(), 'dunyevi', 1);
                        }
                    }
                };
                // Ensure no legacy handlers interfere
                addDunyeviInput.onkeydown = null;
                addDunyeviInput.onkeypress = null;
                addDunyeviInput.removeEventListener && addDunyeviInput.removeEventListener('compositionend', () => {});
                // Step 3: Enter on count adds the task
                if (addDunyeviCount) {
                    addDunyeviCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addDunyeviInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                            quickAddDailyTask(title, 'dunyevi', count);
                            if (addDunyeviConfirm) addDunyeviConfirm.classList.add('hidden');
                        }
                    };
                    // Fallback: blur or change also adds
                    addDunyeviCount.onchange = () => {
                        const title = addDunyeviInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                        quickAddDailyTask(title, 'dunyevi', count);
                    };
                    addDunyeviCount.onblur = () => {
                        const title = addDunyeviInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                        quickAddDailyTask(title, 'dunyevi', count);
                    };
                    if (addDunyeviConfirm) {
                        addDunyeviConfirm.onclick = () => {
                            const title = addDunyeviInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addDunyeviCount.value || '1', 10));
                            quickAddDailyTask(title, 'dunyevi', count);
                            addDunyeviConfirm.classList.add('hidden');
                        };
                    }
                }
            }
            const addIlmiBtn = $("#add-ilmi-btn");
            const addIlmiInput = $("#add-ilmi-input");
            const addIlmiCount = $("#add-ilmi-count");
            const addIlmiConfirm = $("#add-ilmi-confirm");
            if (addIlmiBtn && addIlmiInput) {
                // Step 1: Plus shows text input only
                addIlmiBtn.onclick = () => {
                    addIlmiInput.classList.remove('hidden');
                    if (addIlmiCount) addIlmiCount.classList.add('hidden');
                    if (addIlmiConfirm) addIlmiConfirm.classList.add('hidden');
                    addIlmiInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it (single handler)
                addIlmiInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addIlmiInput.value.trim()) return;
                        if (addIlmiCount) {
                            addIlmiCount.classList.remove('hidden');
                            addIlmiCount.focus();
                            addIlmiCount.select();
                            if (addIlmiConfirm) addIlmiConfirm.classList.remove('hidden');
                        } else {
                            quickAddDailyTask(addIlmiInput.value.trim(), 'ilmi', 1);
                        }
                    }
                };
                // Remove legacy interference
                addIlmiInput.onkeydown = null;
                addIlmiInput.onkeypress = null;
                addIlmiInput.removeEventListener && addIlmiInput.removeEventListener('compositionend', () => {});
                // Step 3: Enter on count adds the task
                if (addIlmiCount) {
                    addIlmiCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addIlmiInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                            quickAddDailyTask(title, 'ilmi', count);
                            if (addIlmiConfirm) addIlmiConfirm.classList.add('hidden');
                        }
                    };
                    addIlmiCount.onchange = () => {
                        const title = addIlmiInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                        quickAddDailyTask(title, 'ilmi', count);
                    };
                    addIlmiCount.onblur = () => {
                        const title = addIlmiInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                        quickAddDailyTask(title, 'ilmi', count);
                    };
                    if (addIlmiConfirm) {
                        addIlmiConfirm.onclick = () => {
                            const title = addIlmiInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addIlmiCount.value || '1', 10));
                            quickAddDailyTask(title, 'ilmi', count);
                            addIlmiConfirm.classList.add('hidden');
                        };
                    }
                }
            }
            const addHaftalikBtn = $("#add-haftalik-btn");
            const addHaftalikInput = $("#add-haftalik-input");
            const addHaftalikCount = $("#add-haftalik-count");
            const addHaftalikConfirm = $("#add-haftalik-confirm");
            if (addHaftalikBtn && addHaftalikInput) {
                // Step 1: Plus shows text input only
                addHaftalikBtn.onclick = () => {
                    addHaftalikInput.classList.remove('hidden');
                    if (addHaftalikCount) addHaftalikCount.classList.add('hidden');
                    if (addHaftalikConfirm) addHaftalikConfirm.classList.add('hidden');
                    addHaftalikInput.focus();
                };
                // Step 2: Enter on text reveals count and focuses it
                addHaftalikInput.onkeyup = (e) => {
                    if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                        e.preventDefault();
                        if (!addHaftalikInput.value.trim()) return;
                        if (addHaftalikCount) {
                            addHaftalikCount.classList.remove('hidden');
                            addHaftalikCount.focus();
                            addHaftalikCount.select();
                            if (addHaftalikConfirm) addHaftalikConfirm.classList.remove('hidden');
                        } else {
                            quickAddWeeklyTask(addHaftalikInput.value.trim(), 1);
                        }
                    }
                };
                // Step 3: Enter/change/blur on count adds the task
                if (addHaftalikCount) {
                    addHaftalikCount.onkeyup = (e) => {
                        if (e.key === 'Enter' || e.key === 'NumpadEnter' || e.keyCode === 13) {
                            e.preventDefault();
                            const title = addHaftalikInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                            quickAddWeeklyTask(title, count);
                        }
                    };
                    addHaftalikCount.onchange = () => {
                        const title = addHaftalikInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                        quickAddWeeklyTask(title, count);
                    };
                    addHaftalikCount.onblur = () => {
                        const title = addHaftalikInput.value.trim();
                        if (!title) return;
                        const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                        quickAddWeeklyTask(title, count);
                    };
                    if (addHaftalikConfirm) {
                        addHaftalikConfirm.onclick = () => {
                            const title = addHaftalikInput.value.trim();
                            if (!title) return;
                            const count = Math.max(1, parseInt(addHaftalikCount.value || '1', 10));
                            quickAddWeeklyTask(title, count);
                        };
                    }
                }
            }
            
            // Ana Sekme DeÄŸiÅŸimi
            $$(".tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent'); // Pasif stil
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent'); // Aktif stil
                    
                    $$(".tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.tab + "-tab").classList.remove('hidden');
                };
            });
            
            // Havuz Sekme DeÄŸiÅŸimi
            $$(".pool-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    $$(".pool-tab-btn").forEach(b => {
                        b.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                        b.classList.add('text-gray-500', 'border-transparent');
                    });
                    e.target.classList.add('active-tab', 'text-blue-600', 'border-blue-600');
                    e.target.classList.remove('text-gray-500', 'border-transparent');
                    
                    $$(".pool-tab-content").forEach(c => c.classList.add('hidden'));
                    $("#" + e.target.dataset.poolTab).classList.remove('hidden');
                };
            });

            // YENÄ°: Ä°statistik alt sekme deÄŸiÅŸimi
            $$(".stats-tab-btn").forEach(btn => {
                btn.onclick = (e) => {
                    // TÃ¼m butonlarÄ± pasif yap
                    $$(".stats-tab-btn").forEach(b => {
                        b.classList.remove('text-indigo-600', 'border-indigo-600');
                        b.classList.add('text-gray-500');
                    });
                    // TÄ±klananÄ± aktif yap
                    e.target.classList.add('text-indigo-600', 'border-indigo-600');
                    e.target.classList.remove('text-gray-500');
                    
                    // TÃ¼m iÃ§erikleri gizle
                    $$(".stats-tab-content").forEach(c => c.classList.add('hidden'));
                    
                    // Ä°lgili iÃ§eriÄŸi gÃ¶ster
                    const tabId = e.target.dataset.statsTab + "-tab";
                    const contentTab = $("#" + tabId);
                    if (contentTab) {
                        contentTab.classList.remove('hidden');
                    }
                };
            });
            
            // NÃ¶bet Ä°ÅŸleme (Ä°stek 8)
            $("#rota-process-btn").onclick = processRota;
            
            // YENÄ°: Ayar kaydetme butonlarÄ±
            $("#api-key-save-btn").onclick = saveApiKey;
            $('#rota-name-input').onblur = saveRotaName; // Ä°sim kutusundan Ã§Ä±kÄ±nca kaydet
            
            // YENÄ°: Yerel Arka Plan YÃ¼kleme
            $("#upload-bg-btn").onclick = handleLocalBackgroundUpload;

            // Modal Kapatma
            $("#modal-close-btn").onclick = () => $("#message-modal").classList.add('hidden');
            
            // GeÃ§miÅŸ Modal
            $("#show-history-btn").onclick = showHistoryModal;
            $("#history-modal-close-btn").onclick = () => $("#history-modal").classList.add('hidden');
            
            // YENÄ°: Ä°statistik/Analiz Modal
            $("#show-stats-btn").onclick = showStatsModal;
            $("#stats-modal-close-btn").onclick = () => $("#stats-modal").classList.add('hidden');

            // Havuz Modal aÃ§/kapat
            const openPoolBtn = $("#open-pool-btn");
            if (openPoolBtn) openPoolBtn.onclick = () => {
                $("#pool-modal").classList.remove('hidden');
                loadPools();
            };
            const poolCloseBtn = $("#pool-modal-close-btn");
            if (poolCloseBtn) poolCloseBtn.onclick = () => $("#pool-modal").classList.add('hidden');
            const poolModal = document.getElementById("pool-modal");
            if (poolModal) poolModal.onclick = (e) => { if (e.target.id === "pool-modal") poolModal.classList.add('hidden'); };

            // Favorileri toplu ekleme butonlarÄ±
            const addAllDun = document.getElementById('add-all-dunyevi-favorites');
            const addAllIlm = document.getElementById('add-all-ilmi-favorites');
            const addAllHaf = document.getElementById('add-all-haftalik-favorites');
            if (addAllDun) addAllDun.onclick = () => addAllFavoritesFromPool('dunyevi');
            if (addAllIlm) addAllIlm.onclick = () => addAllFavoritesFromPool('ilmi');
            if (addAllHaf) addAllHaf.onclick = () => addAllFavoritesFromPool('haftalik');


        // TÃ¼m favorileri aktif gÃ¼ne/haftaya ekler; zaten ekli olanlar iÃ§in bilgi verir
        function addAllFavoritesFromPool(poolType) {
            try {
                const poolKey = `pools_${poolType}`;
                const pool = lsGet(poolKey, []);
                const favorites = pool.filter(t => t.isDefault);
                if (favorites.length === 0) {
                    showMessage('Bilgi', 'Favori (varsayÄ±lan) iÅŸaretli gÃ¶rev bulunamadÄ±.');
                    return;
                }

                if (poolType === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    let added = 0, already = [];
                    favorites.forEach(ft => {
                        const exists = tasks.some(t => t.title === ft.title);
                        if (exists) { already.push(ft.title); return; }
                        tasks.push({
                            id: Date.now().toString() + Math.random(),
                            title: ft.title,
                            frequency: ft.frequency || 1,
                            completed: 0,
                            subtasks: Array.isArray(ft.subtasks) ? ft.subtasks.map(st => ({ title: st.title, completed: false })) : [],
                            subtaskScoring: ft.subtaskScoring || 'grouped'
                        });
                        added++;
                    });
                    lsSet(key, tasks);
                    loadWeeklyTasks();
                    const msg = added > 0 ? `${added} favori haftalÄ±k gÃ¶rev eklendi.` : 'TÃ¼m favoriler zaten ekli.';
                    if (already.length) showMessage('Durum', `${msg}\nZaten ekli: ${already.join(', ')}`);
                    else showMessage('Durum', msg);
                } else {
                    if (!isActiveDateEditable()) {
                        showMessage('Salt Okunur', 'Gelecek gÃ¼n iÃ§in ekleme yapÄ±lamaz. BugÃ¼n veya geÃ§miÅŸ gÃ¼n seÃ§in.');
                        return;
                    }
                    const tasks = getEditableDailyTasks(activeDateStr);
                    let added = 0, already = [];
                    favorites.forEach(ft => {
                        const exists = tasks.some(t => t.title === ft.title);
                        if (exists) { already.push(ft.title); return; }
                        tasks.push({
                            id: Date.now().toString() + Math.random(),
                            title: ft.title,
                            type: poolType,
                            status: 0,
                            repetitionCount: ft.repetitionCount || 1,
                            repetitionCompleted: 0,
                            subtasks: Array.isArray(ft.subtasks) ? ft.subtasks.map(st => ({ title: st.title, completed: false })) : [],
                            subtaskScoring: ft.subtaskScoring || 'grouped'
                        });
                        added++;
                    });
                    // Persist and update history/stats for this date
                    persistDailyState(activeDateStr, tasks);
                    loadDailyTasks();
                    const msg = added > 0 ? `${added} favori gÃ¼nlÃ¼k gÃ¶rev eklendi.` : 'TÃ¼m favoriler zaten ekli.';
                    if (already.length) showMessage('Durum', `${msg}\nZaten ekli: ${already.join(', ')}`);
                    else showMessage('Durum', msg);
                }
            } catch (e) {
                console.error('Favorileri ekleme hatasÄ±:', e);
                showMessage('Hata', 'Favoriler eklenirken bir sorun oluÅŸtu.');
            }
        }
            // Tarih gezinme butonlarÄ±
            const prevBtn = $("#prev-day-btn");
            const nextBtn = $("#next-day-btn");
            if (prevBtn) prevBtn.onclick = () => setActiveDate(addDays(activeDateStr, -1));
            if (nextBtn) nextBtn.onclick = () => setActiveDate(addDays(activeDateStr, 1));
            
            // YENÄ°: Veri Yedekleme Event Listeners
            $("#export-data-btn").onclick = exportData;
            $("#import-data-btn").onclick = () => $("#import-file-input").click(); // Gizli input'u tetikle
            $("#import-file-input").onchange = importData;

            // YENÄ°: GÃ¶rev DÃ¼zenleme Modal Event Listeners
            $("#add-subtask-btn").onclick = addSubtaskToEdit;
            $("#edit-task-save-btn").onclick = saveTaskEdit;
            $("#edit-task-cancel-btn").onclick = closeTaskEditModal;
            // Modal dÄ±ÅŸÄ±nda bir yere tÄ±klanÄ±rsa kapat
            document.getElementById("task-edit-modal").onclick = (e) => {
                if (e.target.id === "task-edit-modal") closeTaskEditModal();
            };
        }

        // HÄ±zlÄ± ekleme yardÄ±mcÄ±larÄ±
        function quickAddDailyTask(title, type, repetitionCount = 1) {
            if (!title) return;
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu tarih arÅŸivlenmiÅŸ. Sadece geÃ§miÅŸ veya bugÃ¼n dÃ¼zenlenebilir.');
                return;
            }
            const tasks = getEditableDailyTasks(activeDateStr);
            const exists = tasks.some(t => t.title === title && t.type === type);
            if (exists) return;
            tasks.push({
                id: Date.now().toString(),
                title,
                type,
                status: 0,
                repetitionCount: Math.max(1, parseInt(repetitionCount, 10) || 1),
                repetitionCompleted: 0,
                subtasks: [],
                subtaskScoring: 'grouped'
            });
            persistDailyState(activeDateStr, tasks);
            loadDailyTasks();

            // Havuz senkronizasyonu: gÃ¼nlÃ¼k gÃ¶revleri ilgili havuza ekle
            try {
                const poolKey = `pools_${type}`;
                const poolTasks = lsGet(poolKey, []);
                const inPool = poolTasks.some(p => p.title === title);
                if (!inPool) {
                    poolTasks.push({
                        id: Date.now().toString(),
                        title: title,
                        repetitionCount: Math.max(1, parseInt(repetitionCount, 10) || 1),
                        subtasks: [],
                        subtaskScoring: 'grouped',
                        isDefault: false
                    });
                    lsSet(poolKey, poolTasks);
                    loadPools();
                }
            } catch (e) { /* no-op */ }
            // Girdileri temizle ve gizle
            if (type === 'dunyevi') {
                const i = $("#add-dunyevi-input"); const c = $("#add-dunyevi-count");
                if (i) { i.value=''; i.classList.add('hidden'); }
                if (c) { c.value='1'; c.classList.add('hidden'); }
            }
            if (type === 'ilmi') {
                const i = $("#add-ilmi-input"); const c = $("#add-ilmi-count");
                if (i) { i.value=''; i.classList.add('hidden'); }
                if (c) { c.value='1'; c.classList.add('hidden'); }
            }
        }

        function quickAddWeeklyTask(title, frequency = 1) {
            if (!title) return;
            const key = `tasks_weekly_${currentWeekStr}`;
            const tasks = lsGet(key, []);
            const exists = tasks.some(t => t.title === title);
            if (exists) return;
            tasks.push({
                id: Date.now().toString(),
                title,
                frequency: Math.max(1, parseInt(frequency, 10) || 1),
                completed: 0,
                subtasks: [],
                subtaskScoring: 'grouped'
            });
            lsSet(key, tasks);
            calculateWeeklySuccess();
            loadWeeklyTasks();

            // Havuz senkronizasyonu: haftalÄ±k gÃ¶revleri haftalÄ±k havuza ekle
            try {
                const poolKey = `pools_haftalik`;
                const poolTasks = lsGet(poolKey, []);
                const inPool = poolTasks.some(p => p.title === title);
                if (!inPool) {
                    poolTasks.push({
                        id: Date.now().toString(),
                        title: title,
                        frequency: Math.max(1, parseInt(frequency, 10) || 1),
                        subtasks: [],
                        subtaskScoring: 'grouped',
                        isDefault: false
                    });
                    lsSet(poolKey, poolTasks);
                    loadPools();
                }
            } catch (e) { /* no-op */ }
            const i = $("#add-haftalik-input"); const c = $("#add-haftalik-count");
            if (i) { i.value=''; i.classList.add('hidden'); }
            if (c) { c.value='1'; c.classList.add('hidden'); }
        }

        // --- CRUD Ä°ÅLEMLERÄ° ---

        /**
         * YENÄ°: API AnahtarÄ±nÄ± kaydeder
         */
        function saveApiKey() {
            const apiKey = $("#api-key-input").value.trim();
            lsSet('settings_apiKey', apiKey);
            showMessage("Kaydedildi", "API AnahtarÄ±nÄ±z tarayÄ±cÄ±nÄ±za kaydedildi.");
        }

        /**
         * YENÄ°: NÃ¶bet ismini kaydeder
         */
        function saveRotaName() {
            const rotaName = $("#rota-name-input").value.trim();
            lsSet('settings_rotaName', rotaName);
        }

        /**
         * Formdan aldÄ±ÄŸÄ± veriye gÃ¶re yeni gÃ¶rev ekler (gÃ¼nlÃ¼k veya haftalÄ±k)
         */
        async function handleAddTask() {
            const title = $("#new-task-title").value.trim();
            const type = $("#new-task-type").value;
            const frequency = parseInt($("#new-task-frequency").value) || 1;
            
            if (!title) {
                showMessage("Hata", "LÃ¼tfen bir gÃ¶rev adÄ± girin.");
                return;
            }

            try {
                if (type === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        frequency: frequency,
                        completed: 0,
                        subtasks: [], // Alt gÃ¶revler (haftalÄ±k iÃ§in de)
                        subtaskScoring: 'grouped'
                    });
                    lsSet(key, tasks);
                    loadWeeklyTasks(); // UI'Ä± yenile (iÃ§inde haftalÄ±k baÅŸarÄ± hesaplamasÄ± var)

                } else {
                    if (!isActiveDateEditable()) {
                        showMessage('Salt Okunur', 'Bu tarih arÅŸivlenmiÅŸ. Sadece son 7 gÃ¼ne kadar dÃ¼zenleyebilirsiniz.');
                        return;
                    }
                    const tasks = getEditableDailyTasks(activeDateStr);
                    tasks.push({
                        id: Date.now().toString(), // Benzersiz ID
                        title: title,
                        type: type,
                        status: 0,
                        repetitionCount: 1, // VarsayÄ±lan: 1 kez
                        repetitionCompleted: 0, // KaÃ§ kez tamamlandÄ±
                        subtasks: [], // Alt gÃ¶revler
                        subtaskScoring: 'grouped' // 'grouped' veya 'individual'
                    });
                    // Persist and update history/stats for this date
                    persistDailyState(activeDateStr, tasks);
                    loadDailyTasks(); // UI'Ä± yenile (iÃ§inde gÃ¼nlÃ¼k baÅŸarÄ± hesaplamasÄ± var)
                }
                
                // GÃ¶revi KÃ¼meye de ekle (Ä°stek 1)
                const poolType = (type === 'haftalik') ? 'haftalik' : (type === 'dunyevi' ? 'dunyevi' : 'ilmi');
                const poolKey = `pools_${poolType}`;
                
                const poolTasks = lsGet(poolKey, []);
                const taskExists = poolTasks.some(task => task.title === title);
                
                if (!taskExists) {
                    poolTasks.push({
                        id: Date.now().toString(),
                        title: title,
                        isDefault: false,
                        ...(type === 'haftalik' && { frequency: frequency })
                    });
                    lsSet(poolKey, poolTasks);
                    loadPools(); // UI'Ä± yenile
                }
                
                // Formu temizle
                $("#new-task-title").value = "";
                $("#new-task-frequency").value = "1";

            } catch (error) {
                console.error("GÃ¶rev ekleme hatasÄ±:", error);
                showMessage("Hata", "GÃ¶rev eklenirken bir sorun oluÅŸtu.");
            }
        }
        
        /**
         * YENÄ°: Havuzdan bir gÃ¶reve tÄ±klandÄ±ÄŸÄ±nda onu gÃ¼nlÃ¼k listeye ekler
         */
        function handlePoolClick(task, containerId) {
            try {
                const poolType = poolTypeFromContainer(containerId);
                if (!poolType) return;
                
                if (poolType === 'haftalik') {
                    const key = `tasks_weekly_${currentWeekStr}`;
                    const tasks = lsGet(key, []);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            frequency: task.frequency || 1,
                            completed: 0,
                            subtasks: task.subtasks || [],
                            subtaskScoring: task.subtaskScoring || 'grouped'
                        });
                        lsSet(key, tasks);
                        loadWeeklyTasks();
                    }
                } else {
                    if (!isActiveDateEditable()) {
                        showMessage('Salt Okunur', 'Bu tarih arÅŸivlenmiÅŸ. Sadece son 7 gÃ¼ne kadar dÃ¼zenleyebilirsiniz.');
                        return;
                    }
                    const tasks = getEditableDailyTasks(activeDateStr);
                    const exists = tasks.some(t => t.title === task.title);
                    if (!exists) {
                        tasks.push({
                            id: Date.now().toString(),
                            title: task.title,
                            type: poolType,
                            status: 0,
                            repetitionCount: task.repetitionCount || 1,
                            repetitionCompleted: 0,
                            subtasks: task.subtasks || [],
                            subtaskScoring: task.subtaskScoring || 'grouped'
                        });
                        // Persist and update history/stats for this date
                        persistDailyState(activeDateStr, tasks);
                        loadDailyTasks();
                    }
                }
            } catch (error) {
                console.error("Havuzdan gÃ¶rev ekleme hatasÄ±:", error);
            }
        }

        // --- YENÄ°: GÃ–REV DÃœZENLEME FONKSÄ°YONLARI ---

        let editingTaskData = null; // Modal'da dÃ¼zenlenen gÃ¶revin geÃ§ici verisi
        let editingTaskType = null; // 'daily' veya 'weekly'

        function openTaskEditModal(task, dateStr) {
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu tarih arÅŸivlenmiÅŸ. Sadece son 7 gÃ¼ne kadar dÃ¼zenleyebilirsiniz.');
                return;
            }

            editingTaskType = 'daily';
            editingTaskData = { ...task, dateStr }; // GeÃ§ici kopya (orijinal deÄŸiÅŸtirilmemesi iÃ§in)

            // Modal alanlarÄ±nÄ± doldur
            $("#edit-task-title").value = task.title;
            
            // Tekrar sayÄ±sÄ± (sadece gÃ¼nlÃ¼k gÃ¶revler iÃ§in)
            if (task.type === 'haftalik') {
                $("#edit-repetition-section").classList.add('hidden');
            } else {
                $("#edit-repetition-section").classList.remove('hidden');
                $("#edit-task-repetition").value = task.repetitionCount || 1;
            }

            // Alt gÃ¶revleri listele
            renderEditSubtasksList();

            // Alt gÃ¶rev skorlamasÄ±
            if (task.subtasks && task.subtasks.length > 0) {
                $("#edit-subtask-scoring-section").classList.remove('hidden');
                document.querySelector(`input[name="subtask-scoring"][value="${task.subtaskScoring || 'grouped'}"]`).checked = true;
            } else {
                $("#edit-subtask-scoring-section").classList.add('hidden');
            }

            // Modal'Ä± aÃ§
            $("#task-edit-modal").classList.remove('hidden');
        }

        function openWeeklyTaskEditModal(task, weekStr) {
            editingTaskType = 'weekly';
            editingTaskData = { ...task, weekStr }; // GeÃ§ici kopya

            // Modal alanlarÄ±nÄ± doldur
            $("#edit-task-title").value = task.title;
            $("#edit-repetition-section").classList.add('hidden'); // HaftalÄ±k iÃ§in gizle
            
            // Alt gÃ¶revleri listele
            renderEditSubtasksList();

            // Alt gÃ¶rev skorlamasÄ±
            if (task.subtasks && task.subtasks.length > 0) {
                $("#edit-subtask-scoring-section").classList.remove('hidden');
                document.querySelector(`input[name="subtask-scoring"][value="${task.subtaskScoring || 'grouped'}"]`).checked = true;
            } else {
                $("#edit-subtask-scoring-section").classList.add('hidden');
            }

            // Modal'Ä± aÃ§
            $("#task-edit-modal").classList.remove('hidden');
        }

        function renderEditSubtasksList() {
            const container = $("#edit-subtasks-list");
            const subtasks = editingTaskData.subtasks || [];

            if (subtasks.length === 0) {
                container.innerHTML = '<p class="text-gray-400 italic text-sm">Alt gÃ¶rev eklenmedi</p>';
            } else {
                container.innerHTML = '';
                subtasks.forEach((subtask, idx) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center space-x-2 p-2 bg-gray-100 rounded';
                    el.innerHTML = `
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} disabled class="w-4 h-4">
                        <span class="flex-grow text-sm">${subtask.title}</span>
                        <button class="text-red-500 hover:text-red-700 text-sm">Sil</button>
                    `;
                    el.querySelector('button').onclick = () => {
                        editingTaskData.subtasks.splice(idx, 1);
                        renderEditSubtasksList();
                        updateEditSubtaskScoringVisibility();
                    };
                    container.appendChild(el);
                });
            }
        }

        function updateEditSubtaskScoringVisibility() {
            const section = $("#edit-subtask-scoring-section");
            const subtasks = editingTaskData.subtasks || [];
            if (subtasks.length > 0) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function addSubtaskToEdit() {
            const title = prompt("Alt gÃ¶rev adÄ± girin:");
            if (title && title.trim()) {
                editingTaskData.subtasks = editingTaskData.subtasks || [];
                editingTaskData.subtasks.push({
                    title: title.trim(),
                    completed: false
                });
                renderEditSubtasksList();
                updateEditSubtaskScoringVisibility();
            }
        }

        function saveTaskEdit() {
            if (!editingTaskData || !editingTaskType) return;

            const newTitle = $("#edit-task-title").value.trim();
            if (!newTitle) {
                showMessage("Hata", "GÃ¶rev adÄ± boÅŸ olamaz.");
                return;
            }
            // Havuz senkronizasyonu iÃ§in eski baÅŸlÄ±ÄŸÄ± sakla
            const oldTitle = editingTaskData.title;
            editingTaskData.title = newTitle;
            
            // Tekrar sayÄ±sÄ±nÄ± gÃ¼ncelle (sadece gÃ¼nlÃ¼k gÃ¶revler iÃ§in)
            if (editingTaskType === 'daily' && editingTaskData.type !== 'haftalik') {
                const rep = parseInt($("#edit-task-repetition").value) || 1;
                editingTaskData.repetitionCount = rep;
                // EÄŸer tekrar sayÄ±sÄ± azaldÄ±ysa, tamamlanan sayÄ±sÄ± da azalt
                if (editingTaskData.repetitionCompleted > rep) {
                    editingTaskData.repetitionCompleted = rep;
                }
            }

            // Alt gÃ¶rev skorlamasÄ±
            if (editingTaskData.subtasks && editingTaskData.subtasks.length > 0) {
                const scoringType = document.querySelector('input[name="subtask-scoring"]:checked').value;
                editingTaskData.subtaskScoring = scoringType;
            }

            // Verileri kaydet
            if (editingTaskType === 'daily') {
                let tasks = getEditableDailyTasks(editingTaskData.dateStr);
                const taskIndex = tasks.findIndex(t => t.id === editingTaskData.id);
                if (taskIndex > -1) {
                    tasks[taskIndex] = editingTaskData;
                    persistDailyState(editingTaskData.dateStr, tasks);
                    loadDailyTasks();
                    // GÃ¼nlÃ¼k gÃ¶revler iÃ§in havuza senkronize et
                    const poolType = editingTaskData.type === 'ilmi' ? 'ilmi' : 'dunyevi';
                    syncTaskToPool(editingTaskData, poolType, oldTitle);
                }
            } else if (editingTaskType === 'weekly') {
                const key = `tasks_weekly_${editingTaskData.weekStr}`;
                let tasks = lsGet(key, []);
                const taskIndex = tasks.findIndex(t => t.id === editingTaskData.id);
                if (taskIndex > -1) {
                    tasks[taskIndex] = editingTaskData;
                    lsSet(key, tasks);
                    calculateWeeklySuccess();
                    loadWeeklyTasks();
                    // HaftalÄ±k gÃ¶revler iÃ§in havuza senkronize et
                    syncTaskToPool(editingTaskData, 'haftalik', oldTitle);
                }
            }

            closeTaskEditModal();
        }

        function closeTaskEditModal() {
            $("#task-edit-modal").classList.add('hidden');
            editingTaskData = null;
            editingTaskType = null;
        }

        function updateSubtask(taskId, subtaskIndex) {
            let tasks = getEditableDailyTasks(activeDateStr);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                if (task.subtasks && task.subtasks[subtaskIndex]) {
                    task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                    persistDailyState(activeDateStr, tasks);
                    // YalnÄ±zca ilgili tÃ¼rÃ¼n animasyonunu tetikle
                    updateDailyTypeSuccess(task.type);
                    loadDailyTasks();
                }
            }
        }

        function updateTaskRepetition(taskId, repetitionIndex) {
            let tasks = getEditableDailyTasks(activeDateStr);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                // EÄŸer son kutucuk ise, tamamlanan sayÄ±sÄ±nÄ± o indexe ayarla + 1
                // Yani indexler 0-based; 3 adet varsa index 0, 1, 2 var; tÄ±klanÄ±p completed=1, 2, 3 olabilir
                let newCompleted = 0;
                const checkboxes = document.querySelectorAll(`[data-id="${taskId}"] .repetition-checkbox`);
                checkboxes.forEach((cb, idx) => {
                    if (cb.checked) newCompleted = idx + 1;
                });
                task.repetitionCompleted = newCompleted;
                persistDailyState(activeDateStr, tasks);
                // Sadece ilgili tÃ¼rÃ¼n animasyonunu tetikle
                updateDailyTypeSuccess(task.type);
                // UI ve istatistikleri gÃ¼ncelle
                calculateSuccess();
                loadStats();
            }
        }

        function updateWeeklySubtask(taskId, subtaskIndex) {
            const key = `tasks_weekly_${currentWeekStr}`;
            let tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);

            if (taskIndex > -1) {
                const task = tasks[taskIndex];
                if (task.subtasks && task.subtasks[subtaskIndex]) {
                    task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                    lsSet(key, tasks);
                    calculateWeeklySuccess();
                    loadWeeklyTasks();
                }
            }
        }
        
        /**
         * YENÄ°: GÃ¼nlÃ¼k gÃ¶revin durumunu gÃ¼nceller (0, 1, 2)
         */
        async function updateTaskStatus(taskId, currentStatus) {
            if (!isActiveDateEditable()) {
                showMessage('Salt Okunur', 'Bu gÃ¶rev arÅŸivlenmiÅŸ ve dÃ¼zenlenemez. Sadece son 7 gÃ¼ne kadar dÃ¼zenleyebilirsiniz.');
                return;
            }
            const newStatus = (currentStatus + 1) % 3;
            const tasks = getEditableDailyTasks(activeDateStr);
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                tasks[taskIndex].status = newStatus;
                // Persist and update history/stats for this date
                persistDailyState(activeDateStr, tasks);
                // YalnÄ±zca ilgili tÃ¼rÃ¼n animasyonunu tetikle
                const changedType = tasks[taskIndex].type;
                updateDailyTypeSuccess(changedType);
                loadDailyTasks(); // UI'Ä± yenile (iÃ§inde baÅŸarÄ± hesaplamasÄ± var)
            }
        }
        
        /**
         * YENÄ°: HaftalÄ±k gÃ¶revin tamamlanma sayÄ±sÄ±nÄ± gÃ¼nceller
         */
        async function updateWeeklyTask(taskId) {
            const taskElement = document.querySelector(`.task-item[data-id="${taskId}"]`);
            if (!taskElement) return;
            
            const checkboxes = taskElement.querySelectorAll('.weekly-checkbox');
            const completedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            const key = `tasks_weekly_${currentWeekStr}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].completed = completedCount;
                lsSet(key, tasks);
                calculateWeeklySuccess(); // YENÄ°: HaftalÄ±k baÅŸarÄ±yÄ± anÄ±nda gÃ¼ncelle
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revi gÃ¼nlÃ¼k/haftalÄ±k listeden siler
         */
        async function deleteTask(taskId, taskType) {
            if (taskType === 'daily') {
                if (!isActiveDateEditable()) {
                    showMessage('Salt Okunur', 'ArÅŸivlenmiÅŸ gÃ¶revler silinemez. Sadece son 7 gÃ¼ne kadar dÃ¼zenleyebilirsiniz.');
                    return;
                }
                let tasks = getEditableDailyTasks(activeDateStr);
                tasks = tasks.filter(t => t.id !== taskId);
                // Persist and update history/stats for this date
                persistDailyState(activeDateStr, tasks);
                loadDailyTasks();
            } else if (taskType === 'weekly') {
                const key = `tasks_weekly_${currentWeekStr}`;
                let tasks = lsGet(key, []);
                tasks = tasks.filter(t => t.id !== taskId);
                lsSet(key, tasks);
                loadWeeklyTasks();
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revin havuzdaki varsayÄ±lan (isDefault) durumunu deÄŸiÅŸtirir
         */
        async function toggleTaskDefault(taskId, poolType) {
            const key = `pools_${poolType}`;
            const tasks = lsGet(key, []);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex > -1) {
                tasks[taskIndex].isDefault = !tasks[taskIndex].isDefault;
                lsSet(key, tasks);
                loadPools(); // UI'Ä± yenile
            }
        }

        /**
         * YENÄ°: Bir gÃ¶revi havuzdan kalÄ±cÄ± olarak siler
         */
        async function deleteFromPool(taskId, poolType) {
            const key = `pools_${poolType}`;
            let tasks = lsGet(key, []);
            tasks = tasks.filter(t => t.id !== taskId);
            lsSet(key, tasks);
            loadPools(); // UI'Ä± yenile
        }
        
        /**
         * YENÄ°: BaÅŸarÄ± oranÄ±nÄ± hesaplar ve gÃ¶sterir
         */
        function calculateSuccess(tasks = null) {
            if (tasks === null) {
                tasks = getEditableDailyTasks(activeDateStr);
            }
            
            const total = tasks.length;
            if (total === 0) {
                const rateEl = $("#success-rate");
                const waterEl = $("#daily-pool-water");
                const cL = $("#daily-carrier-left");
                const cR = $("#daily-carrier-right");
                if (rateEl) rateEl.textContent = "0%";
                if (waterEl) waterEl.style.height = "0%";
                if (cL) cL.style.animationDuration = '4s';
                if (cR) cR.style.animationDuration = '4s';
                return { total: 0, completed: 0 };
            }
            
            // YarÄ±m yapÄ±lanlar 0.5, tam yapÄ±lanlar 1 puan
            const completed = tasks.reduce((sum, task) => {
                if (task.status === 1) return sum + 0.5;
                if (task.status === 2) return sum + 1;
                return sum;
            }, 0);
            
            const successRate = Math.round((completed / total) * 100);
            // TÃ¼r bazlÄ± animasyonlar artÄ±k spesifik iÅŸlemlerde tetikleniyor.
            return { total, completed };
        }

        /**
         * Helper: compute success percentage from a task list
         */
        function computeSuccessFromTasks(tasks) {
            const total = tasks.length;
            let completed = 0;
            if (total === 0) return { total: 0, completed: 0, success: 0 };
            
            completed = tasks.reduce((sum, task) => {
                let taskScore = 0;

                // EÄŸer alt gÃ¶revler varsa
                if (task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    if (task.subtaskScoring === 'individual') {
                        // Her alt gÃ¶rev ayrÄ± ayrÄ± puan
                        taskScore = completedSubtasks;
                        return sum + taskScore / task.subtasks.length; // Normalize et
                    } else {
                        // Hepsi birlikte 1 puan (grouped)
                        taskScore = completedSubtasks === task.subtasks.length ? 1 : (completedSubtasks > 0 ? 0.5 : 0);
                        return sum + taskScore;
                    }
                }

                // Tekrar sayÄ±sÄ± varsa
                if (task.repetitionCount && task.repetitionCount > 1) {
                    taskScore = task.repetitionCompleted / task.repetitionCount;
                    return sum + taskScore;
                }

                // Normal durum (status: 0, 1, 2)
                if (task.status === 1) taskScore = 0.5;
                if (task.status === 2) taskScore = 1;
                
                return sum + taskScore;
            }, 0);
            
            const success = Math.round((completed / total) * 100);
            return { total, completed, success };
        }

        /**
         * Persist daily tasks for a date and update history & stats immediately.
         * Ensures that edits to previous days are reflected in 'history' and 'stats'.
         */
        function persistDailyState(dateStr, tasks) {
            // Ensure tasks is an array
            tasks = tasks || [];
            // Save the live daily key
            lsSet(`tasks_daily_${dateStr}`, tasks);

            // Update history mapping
            const allHistory = lsGet('history', {});
            allHistory[dateStr] = tasks;
            lsSet('history', allHistory);

            // Update stats.daily
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const { success } = computeSuccessFromTasks(tasks);
            allStats.daily = allStats.daily || {};
            allStats.daily[dateStr] = { success };
            lsSet('stats', allStats);

            // If the persisted date is the currently active or current day, update UI elements
            if (dateStr === activeDateStr || dateStr === currentDayStr) {
                calculateSuccess();
                loadStats();
            }
        }

        /**
         * YENÄ°: HaftalÄ±k baÅŸarÄ± oranÄ±nÄ± hesaplar.
         * tasks null ise, mevcut haftayÄ± LS'den okur ve UI'Ä± gÃ¼nceller.
         * tasks doluysa, o gÃ¶rev listesi iÃ§in oranÄ± hesaplar ve dÃ¶ndÃ¼rÃ¼r.
         */
        function calculateWeeklySuccess(tasks = null, weekId = null) {
            let updateUI = false;
            if (tasks === null) {
                weekId = weekId || currentWeekStr;
                tasks = lsGet(`tasks_weekly_${weekId}`, []);
                updateUI = true;
            }

            if (tasks.length === 0) {
                if(updateUI) {
                    const rateEl = $("#weekly-success-rate");
                    const waterEl = $("#weekly-pool-water");
                    const cL = $("#weekly-carrier-left");
                    const cR = $("#weekly-carrier-right");
                    if (rateEl) rateEl.textContent = "0%";
                    if (waterEl) waterEl.style.height = "0%";
                    if (cL) cL.style.animationDuration = '4s';
                    if (cR) cR.style.animationDuration = '4s';
                }
                return 0; // BaÅŸarÄ± oranÄ±
            }

            // Her gÃ¶revin ne kadar tamamlandÄ±ÄŸÄ±nÄ± hesapla
            let totalScore = 0;
            let totalMaxScore = 0;

            tasks.forEach(task => {
                const freq = task.frequency || 1;
                totalMaxScore += freq;

                // EÄŸer alt gÃ¶revler varsa, onlara gÃ¶re hesapla
                if (task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    if (task.subtaskScoring === 'individual') {
                        // Her alt gÃ¶rev ayrÄ± ayrÄ± puan (normalize et)
                        totalScore += (completedSubtasks / task.subtasks.length) * freq;
                    } else {
                        // Hepsi birlikte 1 puan
                        const score = completedSubtasks === task.subtasks.length ? 1 : (completedSubtasks > 0 ? 0.5 : 0);
                        totalScore += score * freq;
                    }
                } else {
                    // Normal: completed vs frequency
                    totalScore += task.completed;
                }
            });

            if (totalMaxScore === 0) {
                if(updateUI) $("#weekly-success-rate").textContent = "0%";
                return 0;
            }
            
            const successRate = Math.round((totalScore / totalMaxScore) * 100);
            if (updateUI) {
                const rateEl = $("#weekly-success-rate");
                const waterEl = $("#weekly-pool-water");
                const cL = $("#weekly-carrier-left");
                const cR = $("#weekly-carrier-right");
                if (rateEl) rateEl.textContent = `${successRate}%`;
                if (waterEl) waterEl.style.height = `${successRate}%`;
                const dur = 4 - (successRate / 100) * 2;
                // Vary droplet size/arc/time based on delta
                window.__lastRates = window.__lastRates || { dunyevi: 0, ilmi: 0, weekly: 0 };
                const prevWeekly = window.__lastRates.weekly || 0;
                const delta = Math.abs(successRate - prevWeekly);
                const bucketL = cL ? cL.querySelector('.bucket') : null;
                const bucketR = cR ? cR.querySelector('.bucket') : null;
                const dropSize = `${Math.min(10, 6 + Math.floor(delta / 15))}px`;
                const dropTime = `${Math.max(500, 700 + delta * 10)}ms`;
                const arcX = `${Math.min(30, 22 + Math.floor(delta / 10))}px`;
                const arcY = `${-Math.min(28, 22 + Math.floor(delta / 10))}px`;
                if (bucketL) { bucketL.style.setProperty('--drop-size', dropSize); bucketL.style.setProperty('--drop-time', dropTime); bucketL.style.setProperty('--arc-x', arcX); bucketL.style.setProperty('--arc-y', arcY); }
                if (bucketR) { bucketR.style.setProperty('--drop-size', dropSize); bucketR.style.setProperty('--drop-time', dropTime); bucketR.style.setProperty('--arc-x', arcX); bucketR.style.setProperty('--arc-y', arcY); }
                // Stagger pours: left then right, with guided stream
                if (cL) {
                    cL.style.animationDuration = `${dur}s`;
                    setTimeout(() => { cL.classList.add('pour'); launchGuidedStream('weekly', cL, waterEl, 'weekly', successRate); }, 0);
                    setTimeout(() => { cL.classList.remove('pour'); }, 900);
                }
                if (cR) {
                    cR.style.animationDuration = `${dur}s`;
                    setTimeout(() => { cR.classList.add('pour'); launchGuidedStream('weekly', cR, waterEl, 'weekly', successRate); }, 220);
                    setTimeout(() => { cR.classList.remove('pour'); }, 1120);
                }
                const poolEl = waterEl ? waterEl.parentElement : null;
                if (poolEl) { poolEl.classList.add('ripple'); setTimeout(() => poolEl.classList.remove('ripple'), 650); }
                // HaftalÄ±k iÃ§in timed burst
                triggerSplashBurst('weekly', 25, prevWeekly, successRate);
                triggerSplashBurst('weekly', 50, prevWeekly, successRate);
                triggerSplashBurst('weekly', 75, prevWeekly, successRate);
                window.__lastRates.weekly = successRate;
            }
            return successRate;
        }

        // Celebration messages (30-day cycle)
        // Themed messages (Quran verses and Sahaba examples) with citations
        const celebrationMessages = [
            { text: "Ä°nsan iÃ§in ancak Ã§alÄ±ÅŸtÄ±ÄŸÄ± vardÄ±r.", source: "Kurâ€™an, Necm 53:39" },
            { text: "Zorlukla beraber kolaylÄ±k vardÄ±r.", source: "Kurâ€™an, Ä°nÅŸirah 94:6" },
            { text: "Sabredenlerle beraber olun.", source: "Kurâ€™an, Tevbe 9:119" },
            { text: "HayÄ±rda yarÄ±ÅŸÄ±n.", source: "Kurâ€™an, Bakara 2:148" },
            { text: "ÅÃ¼krederseniz, elbette arttÄ±rÄ±rÄ±m.", source: "Kurâ€™an, Ä°brahim 14:7" },
            { text: "GÃ¼zel sÃ¶z ve amel yÃ¼kselir.", source: "Kurâ€™an, FatÄ±r 35:10 (mefhumu)" },
            { text: "Az da olsa devamlÄ± olan makbuldÃ¼r.", source: "Hadis, Buhari (ed-Daâ€™vÃ¢m) mefhumu" },
            { text: "Ameller niyetlere gÃ¶redir.", source: "Hadis, Buhari 1" },
            { text: "Ä°lim amel ile kemÃ¢l bulur.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°hlas, azim ve sabÄ±r: Ã¼Ã§ tac.", source: "Sahabe Hikmetlerinden" },
            { text: "Denge: dÃ¼nyevi ve ilmi gayret.", source: "Sahabe Hikmetlerinden" },
            { text: "Azim, yolun yarÄ±sÄ±dÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayret eden yolunu bulur.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°stikamet istikrardan doÄŸar.", source: "Sahabe Hikmetlerinden" },
            { text: "TaÅŸ Ã¼stÃ¼ne taÅŸ: bina sebatla yÃ¼kselir.", source: "Sahabe Ã–rneÄŸi (Metafor)" },
            { text: "SabÄ±rla zafer gelir.", source: "Sahabe Hikmetlerinden" },
            { text: "Niyet temizse yol kolaylaÅŸÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "BugÃ¼n gayretinle kapÄ±lar aÃ§Ä±ldÄ±.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°yiyi Ã§oÄŸalt, kÃ¶tÃ¼lÃ¼kten sakÄ±n.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Ã‡aba duadÄ±r; neticesi rahmettir.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Seni gayret taÅŸÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Niyet gÃ¼zel, netice gÃ¼zel.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayretini sev; yolun kÄ±ymetini bil.", source: "Sahabe Hikmetlerinden" },
            { text: "BugÃ¼n tamamladÄ±n; yarÄ±n yeniden baÅŸla.", source: "Sahabe Hikmetlerinden" },
            { text: "Kalbe huzur veren emek.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°yilikte sebat et.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Her gÃ¼n bir tuÄŸla.", source: "Sahabe Ã–rneÄŸi (Metafor)" },
            { text: "Ä°limle amel, amelle ihlas.", source: "Sahabe Hikmetlerinden" },
            { text: "Ã‡abalayana kolaylÄ±k gelir.", source: "Kurâ€™an, Ä°nÅŸirah 94 (mefhumu)" },
            { text: "GÃ¼zel niyetler gÃ¼zel sonuÃ§lar doÄŸurur.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°stikrar baÅŸarÄ±nÄ±n anahtarÄ±dÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "Azim ve emek iz bÄ±rakÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "HayÄ±r iÅŸte yarÄ±ÅŸÄ±n: bugÃ¼n Ã¶ndesin.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "KÃ¼Ã§Ã¼k adÄ±mlar bÃ¼yÃ¼k kapÄ±lar aÃ§ar.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°lhamÄ±nÄ± canlÄ± tut; istikrar seni taÅŸÄ±r.", source: "Sahabe Hikmetlerinden" },
            { text: "BugÃ¼n iraden gÃ¼Ã§lendi.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayretin bereketi huzur verir.", source: "Sahabe Hikmetlerinden" },
            { text: "HayÄ±rlÄ± iÅŸ istikrarla bÃ¼yÃ¼r.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°lim ve amel dengesi.", source: "Sahabe Hikmetlerinden" },
            { text: "ÅÃ¼kÃ¼rle taÃ§landÄ±r.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Azimli kal; yola devam.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°yilikte istikrar: bugÃ¼n parlÄ±yor.", source: "Sahabe Hikmetlerinden" },
            { text: "Hedefe giden yolda sebat.", source: "Sahabe Hikmetlerinden" },
            { text: "Ã‡aban kabul oldu.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Niyet ve amel bereket getirir.", source: "Sahabe Hikmetlerinden" },
            { text: "BugÃ¼n bir adÄ±m daha attÄ±n.", source: "Sahabe Hikmetlerinden" },
            { text: "Ä°yiye adÄ±m, kÃ¶tÃ¼lÃ¼kten uzak.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Ä°stikametini koru.", source: "Sahabe Hikmetlerinden" },
            { text: "GÃ¼zel sÃ¶z, gÃ¼zel amel.", source: "Kurâ€™an ilkelerine uygun Ã¶ÄŸÃ¼t" },
            { text: "Gayret, kalbi diri tutar.", source: "Sahabe Hikmetlerinden" },
            { text: "TaÅŸÄ±dÄ±ÄŸÄ±n emek, havuza dÃ¶kÃ¼ldÃ¼: bereket.", source: "Sahabe Ã–rneÄŸi (Metafor)" },
            { text: "GÃ¼nÃ¼n gayreti, yarÄ±nÄ±n umudu.", source: "Sahabe Hikmetlerinden" },
            { text: "Emek: gÃ¶rÃ¼nmeyen kahramanlÄ±k.", source: "Sahabe Hikmetlerinden" },
            { text: "ÅÃ¼kÃ¼r ve istikrar, yol arkadaÅŸÄ±n olsun.", source: "Sahabe Hikmetlerinden" },
            { text: "Gayret, yolun rehberidir.", source: "Sahabe Hikmetlerinden" },
            { text: "SabÄ±r ve sebatla ilerle.", source: "Sahabe Hikmetlerinden" },
            { text: "BugÃ¼n bina yÃ¼kseldi.", source: "Sahabe Ã–rneÄŸi (Metafor)" },
            { text: "Ä°limle gÃ¼zelleÅŸen amel.", source: "Sahabe Hikmetlerinden" }
        ];

        function showDailyCelebration() {
            const d = new Date(activeDateStr);
            const dayIndex = d.getDate() - 1;
            const monthOffset = d.getMonth() % 2; // vary a bit each month
            const idx = (dayIndex + monthOffset) % celebrationMessages.length;
            const textEl = document.getElementById('celebrate-text');
            const sourceEl = document.getElementById('celebrate-source');
            const auraEl = document.getElementById('celebrate-aura');
            const backdrop = document.getElementById('celebrate-backdrop');
            const msg = celebrationMessages[idx];
            if (textEl) textEl.textContent = msg.text;
            if (sourceEl) sourceEl.textContent = msg.source;
            if (auraEl) {
                auraEl.innerHTML = '';
                for (let i=0;i<16;i++) {
                    const dot = document.createElement('span');
                    dot.className = 'dot';
                    const dx = (Math.random()<0.5?-1:1) * (8 + Math.floor(Math.random()*10));
                    const dy = (Math.random()<0.5?-1:1) * (6 + Math.floor(Math.random()*8));
                    dot.style.left = Math.floor(Math.random()*95)+'%';
                    dot.style.top = Math.floor(Math.random()*95)+'%';
                    dot.style.setProperty('--dx', dx+'px');
                    dot.style.setProperty('--dy', dy+'px');
                    dot.style.animationDelay = (Math.random()*2)+'s';
                    auraEl.appendChild(dot);
                }
            }
            if (backdrop) backdrop.style.display = 'flex';
            launchFireworks();
            burstConfetti();
        }
        
        /**
         * YENÄ°: BaÅŸarÄ± eÅŸik kutlamasÄ± (%50, %70, %100)
         * @param {number} milestone - 50, 70 veya 100
         * @param {string} type - 'dunyevi' veya 'ilmi'
         */
        function showMilestoneCelebration(milestone, type) {
            const typeLabel = type === 'dunyevi' ? 'DÃ¼nyevi' : 'Ä°lmi';
            const backdrop = $("#celebrate-backdrop");
            const textEl = $("#celebrate-text");
            const sourceEl = $("#celebrate-source");
            const headerEl = document.querySelector('.celebrate-header span');
            
            if (!backdrop || !textEl || !sourceEl) return;
            
            // Mesajlar
            const messages = {
                50: {
                    text: `ğŸ‰ Harika! ${typeLabel} gÃ¶revlerinizin %50'sini tamamladÄ±nÄ±z!`,
                    source: "YarÄ± yolu geÃ§tiniz, devam edin!",
                    emoji: "ğŸŒŸ",
                    color: "#f59e0b" // amber
                },
                70: {
                    text: `ğŸ”¥ MÃ¼kemmel! ${typeLabel} gÃ¶revlerinizin %70'ini bitirdiniz!`,
                    source: "Az kaldÄ±, biraz daha gayret!",
                    emoji: "ğŸ’ª",
                    color: "#8b5cf6" // purple
                },
                100: {
                    text: `ğŸ† GOLDEN BUZZER! TÃ¼m ${typeLabel} gÃ¶revleri tamamlandÄ±!`,
                    source: "MÃ¼kemmelsiniz! Tebrikler!",
                    emoji: "ğŸ†",
                    color: "#eab308" // yellow/gold
                }
            };
            
            const msg = messages[milestone] || messages[50];
            
            // Modal iÃ§eriÄŸini gÃ¼ncelle
            textEl.textContent = msg.text;
            sourceEl.textContent = msg.source;
            if (headerEl) {
                headerEl.textContent = `${msg.emoji} ${milestone}% BaÅŸarÄ± ${msg.emoji}`;
                headerEl.style.background = `linear-gradient(135deg, ${msg.color}, #a6c1ee)`;
            }
            
            // ModalÄ± gÃ¶ster
            backdrop.style.display = 'flex';
            
            // Animasyonlar
            if (milestone === 100) {
                // En bÃ¼yÃ¼k kutlama - havai fiÅŸekler + konfeti
                launchFireworks();
                burstConfetti();
                addGoldenSparkles(); // Ekstra altÄ±n parÄ±ltÄ±lar
            } else if (milestone === 70) {
                // Orta seviye - konfeti + yÄ±ldÄ±zlar
                burstConfetti();
                addStarBurst();
            } else {
                // %50 - Sadece konfeti
                burstConfetti();
            }
        }
        
        /**
         * YENÄ°: AltÄ±n parÄ±ltÄ± animasyonu (100% iÃ§in)
         */
        function addGoldenSparkles() {
            const auraEl = $("#celebrate-aura");
            if (!auraEl) return;
            
            auraEl.innerHTML = '';
            for (let i=0; i<24; i++) {
                const dot = document.createElement('span');
                dot.className = 'dot';
                dot.style.background = 'radial-gradient(circle, #ffd700, #ffed4e)';
                const dx = (Math.random()<0.5?-1:1) * (12 + Math.floor(Math.random()*15));
                const dy = (Math.random()<0.5?-1:1) * (10 + Math.floor(Math.random()*12));
                dot.style.left = Math.floor(Math.random()*95)+'%';
                dot.style.top = Math.floor(Math.random()*95)+'%';
                dot.style.setProperty('--dx', dx+'px');
                dot.style.setProperty('--dy', dy+'px');
                dot.style.animationDelay = (Math.random()*2)+'s';
                auraEl.appendChild(dot);
            }
        }
        
        /**
         * YENÄ°: YÄ±ldÄ±z patlamasÄ± animasyonu (70% iÃ§in)
         */
        function addStarBurst() {
            const fw = $("#fireworks");
            if (!fw) return;
            
            fw.innerHTML = '';
            const colors = ['#8b5cf6', '#a78bfa', '#c4b5fd'];
            for (let i=0; i<12; i++) {
                const s = document.createElement('span');
                s.className = 'spark';
                s.textContent = 'â­';
                const left = Math.floor(Math.random()*80)+10;
                const top = Math.floor(Math.random()*30)+10;
                const fx = (Math.random()<0.5? -1:1) * (60 + Math.floor(Math.random()*50));
                const fy = - (80 + Math.floor(Math.random()*60));
                const sz = 12 + Math.floor(Math.random()*8);
                const dur = (1.0 + Math.random()*0.6)+'s';
                s.style.left = left+'%';
                s.style.top = top+'%';
                s.style.setProperty('--fx', fx+'px');
                s.style.setProperty('--fy', fy+'px');
                s.style.setProperty('--sz', sz+'px');
                s.style.setProperty('--dur', dur);
                fw.appendChild(s);
            }
        }

        // Close celebration modal
        (function(){
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'celebrate-close') {
                    const backdrop = document.getElementById('celebrate-backdrop');
                    if (backdrop) backdrop.style.display = 'none';
                }
            });
        })();

        // Randomized fireworks
        function launchFireworks() {
            const fw = document.getElementById('fireworks');
            if (!fw) return;
            fw.innerHTML = '';
            const colors = ['#ffd166','#a6c1ee','#fbc2eb','#10b981','#60a5fa'];
            for (let i=0;i<24;i++) {
                const s = document.createElement('span');
                s.className = 'spark';
                const left = Math.floor(Math.random()*90)+5; // 5%-95%
                const top = Math.floor(Math.random()*40)+5;  // header area
                const fx = (Math.random()<0.5? -1:1) * (100 + Math.floor(Math.random()*80));
                const fy = - (120 + Math.floor(Math.random()*100));
                const sz = 3 + Math.floor(Math.random()*4);
                const dur = (1.2 + Math.random()*0.8)+'s';
                const col = colors[Math.floor(Math.random()*colors.length)];
                s.style.left = left+'%';
                s.style.top = top+'%';
                s.style.setProperty('--fx', fx+'px');
                s.style.setProperty('--fy', fy+'px');
                s.style.setProperty('--sz', sz+'px');
                s.style.setProperty('--dur', dur);
                s.style.setProperty('--col', col);
                fw.appendChild(s);
            }
        }

        // Lightweight confetti burst
        function burstConfetti() {
            const canvas = document.getElementById('confetti');
            if (!canvas) return;
            const modal = canvas.closest('.celebrate-modal');
            const rect = modal.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            const ctx = canvas.getContext('2d');
            const pieces = [];
            const cols = ['#f87171','#34d399','#60a5fa','#fbbf24','#a78bfa','#ec4899'];
            for (let i=0;i<120;i++) {
                pieces.push({
                    x: canvas.width/2 + (Math.random()*40-20),
                    y: canvas.height/3,
                    r: 2 + Math.random()*3,
                    c: cols[Math.floor(Math.random()*cols.length)],
                    vx: (Math.random()*2-1)*3,
                    vy: -(2 + Math.random()*3),
                    g: 0.06 + Math.random()*0.04,
                    a: 1
                });
            }
            let t = 0;
            function step() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += p.g; p.a -= 0.008;
                    ctx.globalAlpha = Math.max(0,p.a);
                    ctx.fillStyle = p.c;
                    ctx.beginPath();
                    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
                    ctx.fill();
                });
                t++;
                if (t<220) requestAnimationFrame(step);
                else { ctx.clearRect(0,0,canvas.width,canvas.height); }
            }
            step();
        }

        // Helper: show splash briefly when crossing thresholds
        function triggerSplashBurst(prefix, threshold, prev, current) {
            const el = document.querySelector(`#${prefix}-splash-${threshold}`);
            if (!el) return;
            const crossedUp = (prev || 0) < threshold && current >= threshold;
            if (!crossedUp) return;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 1200);
        }

        // Launch a guided stream from a carrier's bucket towards the pool
        function launchGuidedStream(prefix, carrierEl, waterEl, type, successRate) {
            try {
                const scene = carrierEl.closest('.progress-scene');
                const bucketEl = carrierEl.querySelector('.bucket');
                if (!scene || !bucketEl || !waterEl) return;

                const bucketRect = bucketEl.getBoundingClientRect();
                const poolRect = waterEl.parentElement.getBoundingClientRect();
                const sceneRect = scene.getBoundingClientRect();

                const startX = bucketRect.right - sceneRect.left;
                const startY = bucketRect.top - sceneRect.top + 6;
                const targetX = poolRect.left - sceneRect.left + poolRect.width / 2;
                const targetY = poolRect.top - sceneRect.top + 12;

                const prev = (window.__lastRates && window.__lastRates[type]) || 0;
                const delta = Math.max(0, successRate - prev);
                const particles = Math.min(6, 2 + Math.floor(delta / 20));
                const duration = 600 + Math.min(500, delta * 12);

                for (let i = 0; i < particles; i++) {
                    const dot = document.createElement('span');
                    dot.className = `guided-stream ${prefix.includes('daily-ilmi') ? 'ilmi' : (prefix.includes('weekly') ? 'weekly' : 'daily')}`;
                    const jitterX = (Math.random() - 0.5) * 12;
                    const jitterY = (Math.random() - 0.5) * 8;
                    dot.style.left = `${startX + jitterX}px`;
                    dot.style.top = `${startY + jitterY}px`;
                    dot.style.opacity = '1';
                    dot.style.transition = `transform ${duration}ms cubic-bezier(0.25,0.65,0.2,1), opacity 300ms ease`;
                    scene.appendChild(dot);

                    const dx = targetX - (startX + jitterX);
                    const dy = targetY - (startY + jitterY);
                    const lift = -Math.max(8, Math.min(20, Math.abs(dx) / 8));
                    requestAnimationFrame(() => {
                        dot.style.transform = `translate(${dx}px, ${dy + lift}px)`;
                    });

                    setTimeout(() => {
                        dot.style.opacity = '0';
                        setTimeout(() => { if (dot && dot.parentElement) dot.parentElement.removeChild(dot); }, 280);
                    }, duration + 40);
                }

                // On arrival, trigger ripple and contact splash, then clean up
                setTimeout(() => {
                    const poolEl = waterEl.parentElement;
                    if (poolEl) {
                        poolEl.classList.add('ripple');
                        // Contact splash
                        const splash = document.createElement('span');
                        splash.className = 'contact-splash';
                        poolEl.appendChild(splash);
                        setTimeout(() => { if (splash && splash.parentElement) splash.parentElement.removeChild(splash); }, 800);
                        setTimeout(() => poolEl.classList.remove('ripple'), 700);
                    }
                }, 720);
            } catch (e) {
                // fail silently
            }
        }

        // Compute and update per-type daily success visuals
        function updateDailyTypeSuccess(type) {
            let tasks = getEditableDailyTasks(activeDateStr);
            const filtered = (tasks || []).filter(t => t.type === type);
            const { success: successRate } = computeSuccessFromTasks(filtered);
            const prefix = type === 'dunyevi' ? 'daily-dunyevi' : 'daily-ilmi';
            const rateEl = document.querySelector(`#${prefix}-success-rate`);
            const waterEl = document.querySelector(`#${prefix}-pool-water`);
            const cL = document.querySelector(`#${prefix}-carrier-left`);
            const cR = document.querySelector(`#${prefix}-carrier-right`);
            if (rateEl) rateEl.textContent = `${successRate}%`;
            if (waterEl) waterEl.style.height = `${successRate}%`;
            const dur = 4 - (successRate / 100) * 2;
            // Compute delta and set bucket CSS variables
            window.__lastRates = window.__lastRates || { dunyevi: 0, ilmi: 0, weekly: 0 };
            const prev = window.__lastRates[type] || 0;
            const delta = Math.abs(successRate - prev);
            const bucketL = cL ? cL.querySelector('.bucket') : null;
            const bucketR = cR ? cR.querySelector('.bucket') : null;
            const dropSize = `${Math.min(10, 6 + Math.floor(delta / 15))}px`;
            const dropTime = `${Math.max(500, 700 + delta * 10)}ms`;
            const arcX = `${Math.min(30, 22 + Math.floor(delta / 10))}px`;
            const arcY = `${-Math.min(28, 22 + Math.floor(delta / 10))}px`;
            if (bucketL) { bucketL.style.setProperty('--drop-size', dropSize); bucketL.style.setProperty('--drop-time', dropTime); bucketL.style.setProperty('--arc-x', arcX); bucketL.style.setProperty('--arc-y', arcY); }
            if (bucketR) { bucketR.style.setProperty('--drop-size', dropSize); bucketR.style.setProperty('--drop-time', dropTime); bucketR.style.setProperty('--arc-x', arcX); bucketR.style.setProperty('--arc-y', arcY); }
            // Stagger pours: left then right
            if (cL) {
                cL.style.animationDuration = `${dur}s`;
                setTimeout(() => {
                    cL.classList.add('pour');
                    launchGuidedStream(prefix, cL, waterEl, type, successRate);
                }, 0);
                setTimeout(() => { cL.classList.remove('pour'); }, 900);
            }
            if (cR) {
                cR.style.animationDuration = `${dur}s`;
                setTimeout(() => {
                    cR.classList.add('pour');
                    launchGuidedStream(prefix, cR, waterEl, type, successRate);
                }, 220);
                setTimeout(() => { cR.classList.remove('pour'); }, 1120);
            }
            const poolEl = waterEl ? waterEl.parentElement : null;
            if (poolEl) { poolEl.classList.add('ripple'); setTimeout(() => poolEl.classList.remove('ripple'), 650); }
                // Temas anÄ±nda kÃ¼Ã§Ã¼k sÄ±Ã§rama partikÃ¼lleri oluÅŸtur
                if (poolEl) {
                    const splash = document.createElement('span');
                    splash.className = 'contact-splash';
                    poolEl.appendChild(splash);
                    setTimeout(() => { if (splash && splash.parentElement) splash.parentElement.removeChild(splash); }, 800);
                }
            triggerSplashBurst(prefix, 25, prev, successRate);
            triggerSplashBurst(prefix, 50, prev, successRate);
            triggerSplashBurst(prefix, 75, prev, successRate);
            window.__lastRates[type] = successRate;

            // YENÄ°: BaÅŸarÄ± eÅŸiklerinde kutlama gÃ¶ster (%50, %70, %100)
            try {
                const rates = window.__lastRates || { dunyevi: 0, ilmi: 0 };
                
                // Her bir tip iÃ§in ayrÄ± ayrÄ± kutlama gÃ¶ster (sadece bir kez)
                const typeKey = type === 'dunyevi' ? 'dunyevi' : 'ilmi';
                const milestone50Key = `celebration_${typeKey}_50_${activeDateStr}`;
                const milestone70Key = `celebration_${typeKey}_70_${activeDateStr}`;
                const milestone100Key = `celebration_${typeKey}_100_${activeDateStr}`;
                
                // %100 Kutlama (Golden Buzzer etkisi)
                if (successRate >= 100 && prev < 100 && !lsGet(milestone100Key, false)) {
                    showMilestoneCelebration(100, type);
                    lsSet(milestone100Key, true);
                }
                // %70 Kutlama
                else if (successRate >= 70 && prev < 70 && !lsGet(milestone70Key, false)) {
                    showMilestoneCelebration(70, type);
                    lsSet(milestone70Key, true);
                }
                // %50 Kutlama
                else if (successRate >= 50 && prev < 50 && !lsGet(milestone50Key, false)) {
                    showMilestoneCelebration(50, type);
                    lsSet(milestone50Key, true);
                }
                
                // TÃ¼m gÃ¼nlÃ¼k gÃ¶revler %100 olunca bÃ¼yÃ¼k kutlama
                const allDone = (rates.dunyevi === 100 && rates.ilmi === 100);
                const allDoneKey = `celebration_all_100_${activeDateStr}`;
                if (allDone && !lsGet(allDoneKey, false)) {
                    showDailyCelebration(); // Eski bÃ¼yÃ¼k kutlama
                    lsSet(allDoneKey, true);
                }
            } catch (e) { /* no-op */ }
        }

        /**
         * Havuzdaki ilgili girdiyi dÃ¼zenlenen gÃ¶revle senkronize eder.
         * EÅŸleÅŸtirme Ã¶nceliÄŸi: Ã¶nce eski baÅŸlÄ±kla, bulunamazsa mevcut baÅŸlÄ±kla.
         * GÃ¼nlÃ¼k iÃ§in: title, subtasks, subtaskScoring, repetitionCount (varsayÄ±lan) senkronize edilir.
         * HaftalÄ±k iÃ§in: title, subtasks, subtaskScoring (frequency dokunulmaz).
         */
        function syncTaskToPool(task, poolType, oldTitle = null) {
            try {
                const key = `pools_${poolType}`;
                const pool = lsGet(key, []);
                if (!Array.isArray(pool)) return;

                // Ä°lgili havuz girdisini bul
                let idx = -1;
                if (oldTitle) idx = pool.findIndex(p => p.title === oldTitle);
                if (idx === -1) idx = pool.findIndex(p => p.title === task.title);
                if (idx === -1) return; // Havuzda yoksa sessizce Ã§Ä±k

                // Ortak alanlar
                pool[idx].title = task.title;
                pool[idx].subtasks = task.subtasks || [];
                pool[idx].subtaskScoring = task.subtaskScoring || 'grouped';

                // GÃ¼nlÃ¼k Ã¶zel: tekrar sayÄ±sÄ±
                if (poolType === 'dunyevi' || poolType === 'ilmi') {
                    pool[idx].repetitionCount = task.repetitionCount || 1;
                }

                lsSet(key, pool);
                loadPools();
            } catch (e) {
                console.error('Havuz senkronizasyon hatasÄ±:', e);
            }
        }
        
        /**
         * YENÄ°: GeÃ§miÅŸ gÃ¼nleri modal'da gÃ¶sterir
         */
        function showHistoryModal() {
            const history = lsGet('history', {});
            const historyList = $("#history-list");
            const sortedDates = Object.keys(history).sort((a, b) => b.localeCompare(a)); // En yeni en Ã¼stte
            
            if (sortedDates.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500">GÃ¶sterilecek geÃ§miÅŸ gÃ¼n kaydÄ± yok.</p>';
                $("#history-modal").classList.remove('hidden');
                return;
            }
            
            historyList.innerHTML = "";
            sortedDates.forEach(date => {
                const tasks = history[date];
                const { total, completed } = calculateSuccess(tasks);
                const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const dateEl = document.createElement('div');
                dateEl.className = 'p-4 bg-gray-50 rounded-lg shadow-sm';
                const editable = daysDifferenceFromToday(date) >= 0; // GeÃ§miÅŸ/bugÃ¼n dÃ¼zenlenebilir
                dateEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-pink-500">${new Date(date + 'T00:00:00').toLocaleDateString('tr-TR', { weekday: 'long', day:'numeric', month:'long' })}</h4>
                            <p class="text-sm font-semibold text-green-600 mb-2">BaÅŸarÄ±: ${successRate}%</p>
                        </div>
                        <div>
                            ${editable ? `<button class="edit-day-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg">DÃ¼zenle</button>` : `<button class="bg-gray-200 text-gray-600 text-sm py-1 px-3 rounded-lg" disabled>ArÅŸiv</button>`}
                        </div>
                    </div>
                    <ul class="list-disc list-inside ml-2 mt-2">
                        ${tasks.map(t => `<li class="text-gray-700 ${t.status === 2 ? 'line-through' : ''} ${t.status === 0 ? 'opacity-60' : ''}">${t.title} (${t.type === 'ilmi' ? 'Ä°lmi' : 'DÃ¼nyevi'} - ${t.status === 2 ? 'Tamam' : (t.status === 1 ? 'YarÄ±m' : 'YapÄ±lmadÄ±')})</li>`).join('')}
                    </ul>
                `;

                if (editable) {
                    const btn = dateEl.querySelector('.edit-day-btn');
                    if (btn) btn.onclick = () => { setActiveDate(date); $("#history-modal").classList.add('hidden'); };
                }
                historyList.appendChild(dateEl);
            });
            
            $("#history-modal").classList.remove('hidden');
        }
        
        /**
         * YENÄ°: Ä°statistik modalini aÃ§ar ve grafikleri Ã§izer
         */
        function showStatsModal() {
            // ModalÄ± gÃ¶ster
            $("#stats-modal").classList.remove('hidden');
            
            // Verileri yÃ¼kle
            const allStats = lsGet('stats', { daily: {}, weekly: {} });
            const dailyStats = allStats.daily || {};
            const weeklyStats = allStats.weekly || {};
            
            // Grafikleri renderla
            renderStats(dailyStats, weeklyStats);
        }
        
        /**
         * YENÄ°: Havuz konteyner ID'sinden havuz tipini dÃ¶ndÃ¼rÃ¼r
         */
        function poolTypeFromContainer(containerId) {
            if (containerId.includes('dunyevi')) return 'dunyevi';
            if (containerId.includes('ilmi')) return 'ilmi';
            if (containerId.includes('haftalik')) return 'haftalik';
            return null;
        }

        /**
         * KullanÄ±cÄ±ya modal iÃ§inde mesaj gÃ¶sterir
         */
        function showMessage(title, message) {
            const modalTitle = $("#modal-title");
            const modalMessage = $("#modal-message");
            const modal = $("#message-modal");

            if (modalTitle && modalMessage && modal) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.error("Modal elementleri bulunamadÄ±. Mesaj gÃ¶sterilemedi:", title, message);
            }
        }
        
        /**
         * Bir tarih objesinden hafta ID'si (YYYY-WW) oluÅŸturur
         * GÃœNCELLENDÄ°: Pazartesi baz alarak hafta hesaplÄ±yor (ISO 8601 standardÄ±)
         */
        function getWeekId(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7; // Pazar = 7, Pazartesi = 1
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        /**
         * YENÄ°: Hafta ID'sinden o haftanÄ±n Pazartesi tarihini dÃ¶ndÃ¼rÃ¼r
         */
        function getWeekStartDate(weekId) {
            // weekId formatÄ±: "2025-W01"
            const [year, week] = weekId.split('-W').map(Number);
            const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const dow = simple.getUTCDay();
            const ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
            } else {
                ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - dow);
            }
            return formatDateKey(ISOweekStart);
        }

        /**
         * YENÄ°: Hafta ID'sinden o haftanÄ±n Pazar tarihini dÃ¶ndÃ¼rÃ¼r
         */
        function getWeekEndDate(weekId) {
            const monday = getWeekStartDate(weekId);
            return addDays(monday, 6); // Pazartesi + 6 gÃ¼n = Pazar
        }

        /**
         * YENÄ°: Hafta tarih aralÄ±ÄŸÄ±nÄ± gÃ¼nceller (Ã¶rn: "23 AralÄ±k - 29 AralÄ±k 2025")
         */
        function updateWeeklyDateRange() {
            const rangeEl = $("#weekly-date-range");
            if (!rangeEl) return;
            
            const startDate = getWeekStartDate(currentWeekStr);
            const endDate = getWeekEndDate(currentWeekStr);
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            
            const startFormatted = start.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
            const endFormatted = end.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            
            rangeEl.textContent = `${startFormatted} - ${endFormatted}`;
        }

        /**
         * HaftalÄ±k gÃ¶revleri her Pazartesi (veya yeni ISO hafta baÅŸladÄ±ÄŸÄ±nda) yeni haftaya devreder.
         * Yeni haftada tamamlanma sayÄ±larÄ± sÄ±fÄ±rlanÄ±r, alt gÃ¶revler iÅŸaretleri temizlenir.
         */
        function ensureWeeklyRollOver() {
            try {
                const today = new Date();
                const currentWeek = getWeekId(today);
                const lastWeekSaved = lsGet('last_week_id', null);
                if (lastWeekSaved === currentWeek) return; // AynÄ± haftaysa iÅŸlemez

                // Mevcut haftalÄ±k gÃ¶revleri al (geÃ§en haftadan)
                const prevKey = `tasks_weekly_${lastWeekSaved || currentWeek}`;
                const prevTasks = lsGet(prevKey, []);
                // Yeni hafta iÃ§in kopya oluÅŸtur ve tamamlamalarÄ± sÄ±fÄ±rla
                const newTasks = (prevTasks || []).map(t => ({
                    ...t,
                    completed: 0,
                    subtasks: (t.subtasks || []).map(st => ({ ...st, completed: false }))
                }));
                const newKey = `tasks_weekly_${currentWeek}`;
                lsSet(newKey, newTasks);
                lsSet('last_week_id', currentWeek);
            } catch (e) {
                console.warn('Weekly rollover failed:', e);
            }
        }
        
        /**
         * DosyayÄ± Base64 string'e Ã§evirir (NÃ¶bet Ã§izelgesi iÃ§in)
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        /**
         * YENÄ°: DosyayÄ± Base64 URL'ye (data:image/...) Ã§evirir (Arka plan iÃ§in)
         */
        function fileToBase64Url(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * YENÄ°: GÃ¼nlÃ¼k Ayet/Hadis/SÃ¶z'Ã¼ ayarlar (Ä°stek 7)
         */
        function setDailyQuote() {
            try {
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                const index = dayOfYear % GUNLUK_SOZLER.length;
                
                const sozler = GUNLUK_SOZLER[index];

                $("#quote-ayet").textContent = `"${sozler.ayet.text}"`;
                $("#quote-ayet-source").textContent = `â€” ${sozler.ayet.source}`;
                
                $("#quote-hadis").textContent = `"${sozler.hadis.text}"`;
                $("#quote-hadis-source").textContent = `â€” ${sozler.hadis.source}`;
                
                $("#quote-soz").textContent = `"${sozler.soz.text}"`;
                $("#quote-soz-source").textContent = `â€” ${sozler.soz.source}`;

            } catch (error) {
                console.error("GÃ¼nÃ¼n sÃ¶zÃ¼ yÃ¼klenemedi:", error);
                $("#quote-ayet").textContent = "GÃ¼nÃ¼n sÃ¶zÃ¼ yÃ¼klenirken bir hata oluÅŸtu.";
            }
        }
        
        /**
         * YENÄ°: BaÅŸlangÄ±Ã§ta kayÄ±tlÄ± veya varsayÄ±lan arka planÄ± ayarlar
         */
        function setDailyBackground() {
            try {
                const savedBg = lsGet('settings_userBackground', null);
                if (savedBg) {
                    document.body.style.backgroundImage = `url('${savedBg}')`;
                } else {
                    // KayÄ±tlÄ± bir ÅŸey yoksa, varsayÄ±lanlardan ilkini ayarla
                    document.body.style.backgroundImage = `url('${DEFAULT_FALLBACK_BG}')`;
                }
            } catch (error) {
                console.error("Arka plan yÃ¼klenemedi:", error);
                document.body.style.backgroundColor = '#f3f4f6'; // bg-gray-100
            }
        }

        // --- YAPAY ZEKA VE YEREL YÃœKLEME FONKSÄ°YONLARI ---
        
        /**
         * YENÄ°: Yerel Dosya YÃ¼kleme Ä°ÅŸleyicisi
         */
        async function handleLocalBackgroundUpload() {
            const fileInput = $("#local-bg-upload");
            const uploadStatus = $("#upload-status");
            if (fileInput.files.length === 0) {
                showMessage("Hata", "LÃ¼tfen Ã¶nce bilgisayarÄ±nÄ±zdan bir resim dosyasÄ± seÃ§in.");
                return;
            }

            const file = fileInput.files[0];
            uploadStatus.textContent = "YÃ¼kleniyor...";
            uploadStatus.classList.remove('hidden');

            try {
                // DosyayÄ± Base64 URL'ye Ã§evir (bu link hatalarÄ±nÄ± Ã§Ã¶zer)
                const base64Url = await fileToBase64Url(file);
                
                // Arka planÄ± ayarla
                document.body.style.backgroundImage = `url('${base64Url}')`;
                lsSet('settings_userBackground', base64Url); // Base64 URL'yi kaydet

                showMessage("BaÅŸarÄ±lÄ±", "Yerel resminiz arka plan olarak ayarlandÄ± ve kaydedildi!");
            } catch (error) {
                console.error("Yerel arka plan yÃ¼kleme hatasÄ±:", error);
                showMessage("YÃ¼kleme HatasÄ±", "Resim yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen dosya tipini kontrol edin.");
            } finally {
                uploadStatus.classList.add('hidden');
            }
        }

        /**
         * NÃ¶bet Ã§izelgesi resmini iÅŸler (Ä°stek 8)
         * GÃœNCELLENDÄ°: ArtÄ±k her Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r ve rota adÄ±nÄ± kontrol eder.
         */
        async function processRota() {
            const fileInput = $("#rota-upload");
            
            // HATA DÃœZELTMESÄ°: Global referanslarÄ± kullan ve DOM'da bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et.
            if (!rotaLoader || !rotaOutput) {
                // Kritik DOM elemanlarÄ± yÃ¼kleme sÄ±rasÄ±nda alÄ±namadÄ±ysa bu hatayÄ± verir.
                console.error("processRota: Kritik DOM elemanlarÄ± (loader/output) yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
                showMessage("Hata", "NÃ¶bet arayÃ¼zÃ¼ tam yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
                return; 
            }
            
            // Ä°stek 2: Her zaman nÃ¶bet adÄ±nÄ± kontrol et
            const rotaName = lsGet('settings_rotaName', '').trim();
            const apiKey = lsGet('settings_apiKey', '');
            
            if (!apiKey) {
                showMessage("Hata", "Yapay zeka Ã¶zelliÄŸini kullanmak iÃ§in lÃ¼tfen 'Ayarlar' bÃ¶lÃ¼mÃ¼nden API anahtarÄ±nÄ±zÄ± girin.");
                return;
            }
            if (!rotaName) {
                showMessage("Hata", "LÃ¼tfen 'NÃ¶bet Takibi' bÃ¶lÃ¼mÃ¼nden aranacak bir isim girin.");
                return;
            }
            if (fileInput.files.length === 0) {
                showMessage("Hata", "LÃ¼tfen Ã¶nce bir resim dosyasÄ± seÃ§in.");
                return;
            }

            const file = fileInput.files[0];
            const mimeType = file.type;
            
            // UI'Ä± sÄ±fÄ±rla ve yÃ¼klemeyi baÅŸlat
            rotaLoader.classList.remove('hidden');
            rotaOutput.innerHTML = ""; // Ã–nceki sonucu temizle
            
            try {
                const base64Data = await fileToBase64(file);
                const model = "gemini-2.5-flash-preview-09-2025";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: `Bu bir hastane nÃ¶bet Ã§izelgesidir. GÃ¶rÃ¼ntÃ¼deki '${rotaName}' ismine ait tÃ¼m nÃ¶bet gÃ¼nlerini tarihleri (GG.AA.YYYY formatÄ±nda) ve haftanÄ±n gÃ¼nÃ¼ (Pazartesi, SalÄ±, vb.) olarak Ã§Ä±kar. Sadece bu ayÄ±n tarihlerini listele. NÃ¶betler arasÄ±ndaki boÅŸ gÃ¼n sayÄ±sÄ±nÄ± hesapla. Sonucu sade ve anlaÅŸÄ±lÄ±r bir liste olarak TÃ¼rkÃ§e ver.` },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API hatasÄ±: ${response.statusText}`);
                }
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                rotaOutput.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
                
                // Sonucu yerel depolamaya kaydet
                lsSet('metadata_rotaInfo', {
                    text: text,
                    updatedAt: new Date().toISOString()
                });

            } catch (error) {
                console.error("NÃ¶bet iÅŸleme hatasÄ±:", error);
                rotaOutput.innerHTML = `<p class="text-red-500">NÃ¶bet listesi iÅŸlenemedi. ${error.message}</p>`;
            } finally {
                rotaLoader.classList.add('hidden');
            }
        }
        
        // --- YENÄ°: VERÄ° YEDEKLEME FONKSÄ°YONLARI ---

        /**
         * TÃ¼m uygulama verilerini (LS_PREFIX ile baÅŸlayan) bir JSON dosyasÄ± olarak indirir.
         */
        function exportData() {
            try {
                console.log("Veriler dÄ±ÅŸa aktarÄ±lÄ±yor...");
                const backupData = {};
                
                // localStorage'daki tÃ¼m anahtarlarÄ± dolaÅŸ
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Sadece bizim uygulamamÄ±za ait olanlarÄ± al
                    if (key.startsWith(LS_PREFIX)) {
                        // DeÄŸer zaten lsSet tarafÄ±ndan stringify edildiÄŸi iÃ§in ham deÄŸeri alÄ±yoruz.
                        backupData[key] = localStorage.getItem(key);
                    }
                }
                
                if (Object.keys(backupData).length === 0) {
                    showMessage("Bilgi", "Yedeklenecek hiÃ§bir veri bulunamadÄ±.");
                    return;
                }

                // JSON verisini string'e Ã§evir (okunaklÄ± olmasÄ± iÃ§in 2 boÅŸluklu formatlama)
                const jsonString = JSON.stringify(backupData, null, 2);
                // Bir dosya "blob"u oluÅŸtur
                const blob = new Blob([jsonString], { type: "application/json" });
                // Bu blob iÃ§in geÃ§ici bir URL oluÅŸtur
                const url = URL.createObjectURL(blob);
                
                // Ä°ndirmeyi tetiklemek iÃ§in gÃ¶rÃ¼nmez bir link (<a>) oluÅŸtur
                const a = document.createElement('a');
                a.href = url;
                a.download = `ya-sahibez-zaman-yedek-${currentDayStr}.json`; // Dosya adÄ±
                document.body.appendChild(a); // Linki sayfaya ekle
                a.click(); // Linke tÄ±kla (indirmeyi baÅŸlat)
                document.body.removeChild(a); // Linki kaldÄ±r
                URL.revokeObjectURL(url); // GeÃ§ici URL'yi temizle
                
                showMessage("BaÅŸarÄ±lÄ±", "TÃ¼m verileriniz JSON dosyasÄ± olarak indiriliyor.");
            } catch (error) {
                console.error("DÄ±ÅŸa aktarma hatasÄ±:", error);
                showMessage("Hata", "Veriler dÄ±ÅŸa aktarÄ±lÄ±rken bir sorun oluÅŸtu.");
            }
        }

        /**
         * KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi bir JSON yedek dosyasÄ±nÄ± okur ve localStorage'a geri yÃ¼kler.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return; // KullanÄ±cÄ± dosya seÃ§mekten vazgeÃ§ti
            }
            
            const reader = new FileReader();
            
            // Dosya okuma tamamlandÄ±ÄŸÄ±nda...
            reader.onload = function(e) {
                try {
                    const jsonString = e.target.result;
                    // Okunan metni JSON olarak ayrÄ±ÅŸtÄ±r
                    const backupData = JSON.parse(jsonString);
                    
                    if (Object.keys(backupData).length === 0) {
                        showMessage("Hata", "Yedek dosyasÄ± boÅŸ veya geÃ§ersiz.");
                        return;
                    }

                    let validKeyFound = false;
                    
                    // JSON iÃ§indeki her anahtar/deÄŸer Ã§ifti iÃ§in...
                    for (const key in backupData) {
                        // EÄŸer anahtar bizim Ã¶nekimizle baÅŸlÄ±yorsa (doÄŸru dosya mÄ± diye kontrol)
                        if (key.startsWith(LS_PREFIX)) {
                            const value = backupData[key];
                            // DeÄŸer (zaten string) doÄŸrudan localStorage'a yazÄ±lÄ±r.
                            localStorage.setItem(key, value);
                            validKeyFound = true;
                        }
                    }

                    if (!validKeyFound) {
                        showMessage("Hata", "Bu dosya, bu uygulamaya ait geÃ§erli bir yedek dosyasÄ± deÄŸil.");
                        return;
                    }
                    
                    showMessage("BaÅŸarÄ±lÄ±", "Veriler baÅŸarÄ±yla geri yÃ¼klendi! Uygulama yenileniyor...");
                    
                    // Verilerin dÃ¼zgÃ¼n yÃ¼klenmesi iÃ§in sayfayÄ± yeniden baÅŸlat
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // 2 saniye bekle (kullanÄ±cÄ± mesajÄ± gÃ¶rsÃ¼n)

                } catch (error) {
                    console.error("Ä°Ã§e aktarma hatasÄ±:", error);
                    showMessage("Hata", "Yedek dosyasÄ± okunurken bir hata oluÅŸtu. Dosya bozuk veya JSON formatÄ±nda deÄŸil.");
                } finally {
                    // AynÄ± dosyayÄ± tekrar seÃ§ebilmek iÃ§in input'u sÄ±fÄ±rla
                    event.target.value = null;
                }
            };
            
            // DosyayÄ± metin olarak oku
            reader.readAsText(file);
        }

    </script>
</body>
</html>